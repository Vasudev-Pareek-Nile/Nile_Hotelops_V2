{% extends 'RoomWorkSheet/homebase.html' %}
{% load static %}


{% block content %}
 <style>
    tr.trBold {
        background: aliceblue;
    }
 </style>
    <div class="container1">
        <Div class="card card-primary ">
       
        <div class ="card-header">Rooms Worksheet Entry</div>
               
        <div class="card-body">
            <form action="{%url 'RoomWorkSheetEntry' %}" method = "post">
                {% csrf_token %}
        <div class="row">
    
            <lable  class="control-label col-sm-1">Month</lable>
            <div class="col-sm-3">
                    <select class="form-control "   data-val="{{CMonth}}" name="EntryMonth" value="{{mem.EntryMonth}}">
                        <option value ="1">January</option>
                        <option value ="2">February</option>
                        <option value ="3">March</option>
                        <option value ="4">April</option>
                        <option value ="5">May</option>
                        <option value ="6">June</option>
                        <option value ="7">July</option>
                        <option value ="8">August</option>
                        <option value ="9">September</option>
                        <option value ="10">October</option>
                        <option value ="11">November</option>
                        <option value ="12">December</option>
                        
                    </select>
    
                </div>
            <lable  class="col-sm-1"> Year</lable>
            <div  class="col-sm-3">
                <select class="form-control" name="EntryYear" value ="{{mem.EntryYear}}">
                    {%for i in CYear%}
                    <option>{{i}}</option>
                    {%endfor%}
                </select>
    
                </div>
            
        </div>
               
                <br/>
                <br>
               
                <table id="TblEntry" class= "table table-bordered "  style="width:600px" >
                    <thead>
                        <th> </th>
                        <th>Amount</th>
                        
                    </thead>
                   
                    {% for x in mem%}
                        <tr data-SectionTitle="{{x.RoomWorksheet_CategoryMaster.RoomWorksheet_SectionMaster.title}}" data-CategoryTitle="{{x.RoomWorksheet_CategoryMaster.CategoryTitle}}" data-CategoryID="{{x.RoomWorksheet_CategoryMaster.id}}" data-title="{{x.ItemTitle}}" data-iro="true" data-if="true" data-it="true" data-tld="0">
                            <td style='padding-left:30px'>{{x.ItemTitle}}</td> 
                            <td ><input class="form-control" name="Amount_{{ forloop.counter0 }}" type="number" step="0.01" />
                                <input name="ItemID_{{ forloop.counter0 }}" type="hidden" value="{{x.id}}" type="text"/>
                            </td> 
                        </tr>
                        {% if forloop.last %}
                        <input  type="hidden" name="TotalItem" value="{{ forloop.counter0 }}"/>
                        {% endif %}
                        
                    {% endfor%}
                    <input  type="hidden" name="TotalCategoryItem" id="TotalCategoryItem" value=""/>
               
                    {% comment %} <tfoot>
                        <tr>
                            <th>
                                Total 
                            </th>
                            <td>
                                <input type="text" readonly class="form-control" id="TotalAmount" name="TotalAmount" >
                            </td>
                        </tr>
                    </tfoot> {% endcomment %}
                </table>                          
                <br>
               
                <br>
    
                <div class = "card-footer text-right">
                <button class="btn btn-primary" type="submit" id="new1">Submit</button>
                </div>
                <br>
                
            </form>
        </div>
    </div>
    
</div>
<script>

    $(function(){
        var STitle="";
        $("tr[data-SectionTitle]").each(function(index,item){

            if(STitle=="" || STitle !=$(this).attr('data-SectionTitle')){
                    $(this).before('<tr><th colspan="2">&nbsp;</th></tr><tr class="trBold"><th colspan="2">'+$(this).attr('data-SectionTitle')+'</th></tr>')

                    if(STitle!=""){
                        $("tr[data-SectionTitle='"+$(this).attr('data-SectionTitle')+"']").eq($("tr[data-SectionTitle='"+$(this).attr('data-SectionTitle')+"']").length-1).after('<tr data-trt="stotal"  data-SectionTitle="'+$(this).attr('data-SectionTitle')+'" class="trBold"><th>Total</td><td><input type="number" class="form-control" name="SectionTotal" /></td></tr>')

                    }
            }
            
            STitle=$(this).attr('data-SectionTitle');
        })

var TotalCi=0;
        var CTitle="";
        $("tr[data-CategoryTitle]").each(function(index,item){

            if(CTitle=="" || CTitle !=$(this).attr('data-CategoryTitle')){
                if($(this).attr('data-CategoryTitle')!=''){
                    $(this).before('<tr><tr class="" data-ct="total" data-sectiontitle="'+$(this).attr('data-SectionTitle')+'"  data-CategoryTitle="'+$(this).attr('data-CategoryTitle')+'"><th>'+$(this).attr('data-CategoryTitle')+'</th> <th><input class="form-control" name="CategoryAmout_'+TotalCi+'" type="number" step="0.01" /> <input class="form-control" name="CategoryID_'+TotalCi+'" type="hidden" value="'+$(this).attr('data-CategoryID')+'" /></th></tr>')
                    TotalCi=TotalCi+1;
                }

            }
            CTitle=$(this).attr('data-CategoryTitle');
        })
        $("#TotalCategoryItem").val(TotalCi)
       
        DoCal();
        
        $("input[name*='Amount_']").blur(function(){
            DoCal();

        })      
    })

    var DoCal=function(){

            var a = $("tr[data-sectiontitle='Room Nights'][data-title='No. of Days'] input[name*='Amount_']").val().replace(',','');
            var b = $("tr[data-sectiontitle='Room Nights'][data-title='Number of Rooms (Keys)']  input[name*='Amount_']").val().replace(',','');

            var c = a * b;
            $("tr[data-sectiontitle='Room Nights'][data-title='Total Rooms Available'] input[name*='Amount_']").val(c);


            var ItemLoop=["Number of Guests","Rooms Occupied","Rooms Revenue"]
            var AllItemLoop=["Guest Density",
            "Number of Guests",
            "Rooms Occupied",
            "Average Rate (ADR)",
            "Rooms Revenue",
            "Market Mix (Revenue)"]
            var CategoryLoop=["COMPLIMENTARY","FIT","GROUP","NEGOTIATED","ONLINE","PACKAGES"]
            $(ItemLoop).each(function(index,item){
                $(CategoryLoop).each(function(Cindex,Citem){
                    
                        var Total=0;
                            $("tr[data-sectiontitle='"+item+"'][data-categorytitle='"+Citem+"']").each(function(){
                                var a = $(this).find("input[type='number'][name*='Amount_']").val();
                                a =parseFloat(a);
                                a= isNaN(a)?0:a;
                                Total=Total+a;
                            })
                            $("tr[data-ct='total'][data-categorytitle='"+Citem+"'][data-sectiontitle='"+item+"']").find("input[name*='CategoryAmout_']").val(Total.toFixed(2))
    
                })
    
            })

            $(CategoryLoop).each(function(Cindex,Citem){
                    
                var Total=0,ADR=0;
            
                var a = $("tr[data-sectiontitle='Rooms Occupied'][data-ct='total'][data-categorytitle='"+Citem+"'] input[type='number'][name*='CategoryAmout_']").val();
                a =parseFloat(a);
                a= isNaN(a)?0:a;

                var b = $("tr[data-sectiontitle='Number of Guests'][data-ct='total'][data-categorytitle='"+Citem+"'] input[type='number'][name*='CategoryAmout_']").val();
                b =parseFloat(b);
                b= isNaN(b)?0:b;
                

                var a_b = $("tr[data-sectiontitle='Rooms Revenue'][data-ct='total'][data-categorytitle='"+Citem+"'] input[type='number'][name*='CategoryAmout_']").val();
                a_b =parseFloat(a_b);
                a_b= isNaN(a_b)?0:a_b;

                if(a>0){
                    Total = b/a;
                    ADR = a_b/a;
                }
                $("tr[data-sectiontitle='Guest Density'][data-ct='total'][data-categorytitle='"+Citem+"'] input[type='number'][name*='CategoryAmout_']").val(Total.toFixed(2));
                $("tr[data-sectiontitle='Average Rate (ADR)'][data-ct='total'][data-categorytitle='"+Citem+"'] input[type='number'][name*='CategoryAmout_']").val(ADR.toFixed(2));
                        
        })

        $(AllItemLoop).each(function(index,item){
            var Total=0;
            $(CategoryLoop).each(function(Cindex,Citem){
                var a = $("tr[data-ct='total'][data-sectiontitle='"+item+"'][data-categorytitle='"+Citem+"']").find("input[type='number'][name*='CategoryAmout_']").val();
                a =parseFloat(a);
                a= isNaN(a)?0:a;
                Total=Total+a;
            })
            $("tr[data-trt='stotal'][data-sectiontitle='"+item+"']").find("input").val(Total.toFixed(2))

        })


        var TotalRoomRevenue = $("tr[data-sectiontitle='Rooms Revenue'][data-trt='stotal'] input").val();
        TotalRoomRevenue =parseFloat(TotalRoomRevenue);
        TotalRoomRevenue= isNaN(TotalRoomRevenue)?0:TotalRoomRevenue;
        $(CategoryLoop).each(function(Cindex,Citem){
                    
            var Total=0;
        
           debugger;

            var b = $("tr[data-sectiontitle='Rooms Revenue'][data-ct='total'][data-categorytitle='"+Citem+"'] input[type='number'][name*='CategoryAmout_']").val();
            b =parseFloat(b);
            b= isNaN(b)?0:b;
            


            if(TotalRoomRevenue>0){
                Total = (b/TotalRoomRevenue)*100;
            
            }
            $("tr[data-sectiontitle='Market Mix (Revenue)'][data-ct='total'][data-categorytitle='"+Citem+"'] input[type='number'][name*='CategoryAmout_']").val(Total.toFixed(2));
            
                    
    })
            
    }
</script>

{% endblock content %}


