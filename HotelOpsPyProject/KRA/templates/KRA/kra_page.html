{% extends "KRA/homebase.html" %}
{% block content %}

<style>
    table thead tr th{
        color: black !important;
    }

    .TextRed{
        color: red !important;
    }
</style>


<style>
    /* Make table full width */
    #KRAManagementTable {
        width: 100%;
        border-collapse: collapse;
    }

    /* Make header cells sticky */
    #KRAManagementTable thead th {
        position: sticky;
        top: 120px;
        z-index: 10;
        background-color: white;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* Add consistent styling */
    #KRAManagementTable th, 
    #KRAManagementTable td {
        /* padding: 10px; */
        border: 1px solid #dee2e6;
        vertical-align: middle;
        background-color: #fff;
    }

    .table-responsive {
        overflow-x: auto;
    }

    body {
        overflow-x: hidden;
    }

    .card-header {
        margin-bottom: -17px;
    }
    .card .card-body {
        padding-top: 0px !important;
    }
</style>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span class="text-uppercase fw-bold">KRA Management</span>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#kraModal" onclick="resetForm()">+ Add New</button>
    </div>

    <div class="card-body mt-2" id="kraCards">
        <!-- Cards will be loaded here -->
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="kraModal" tabindex="-1" aria-labelledby="kraModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form class="modal-content" id="kraForm">
            <div class="modal-header">
                <h5 class="modal-title" id="kraModalLabel">Add / Edit KRA</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="kraId">
                <div class="col-md-12">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label>Title</label>
                            <input type="text" class="form-control" id="Title" required>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label>Definition</label>
                            <textarea class="form-control" id="Defination" rows="3" required></textarea>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label>Type</label>
                            <select type="text" class="form-control" id="Type" required>
                                <option value="Monthly">Monthly</option>
                                <option value="Quarterly">Quarterly</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label>Source</label>
                            <select type="text" class="form-control" id="Source" required>
                                <option value="Entry">Entry</option>
                                <option value="CEO Report">CEO Report</option>
                                <option value="HotelOps">HotelOps</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label>Sort Order</label>
                            <input type="number" class="form-control" id="SortOrder" value="999">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>Comparison Type</label>
                            <select class="form-control" id="ComparisonType" required>
                                <option value="higher">Higher is better</option>
                                <option value="lower">Lower is better</option>
                                <option value="equal">Exact match</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="valueTypeSelector">Select Value Type</label>
                            <select name="value_type" id="valueTypeSelector" class="form-control">
                                <option value="number">Number</option>
                                <option value="percentage">Percentage</option>
                                <option value="decimal">Decimal</option>
                                <option value="text">Text</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" type="submit">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Toast Alert -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
    <div id="toast" class="toast align-items-center text-white bg-success border-0" role="alert" style="display: none;">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage">Saved successfully</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"><span aria-hidden="true">&times;</span></button>
        </div>
    </div>
</div>


<script>
const API_URL = "/KRA/api/kra/";

function showToast(message, isError = false) {
    $("#toast").removeClass("bg-success bg-danger").addClass(isError ? "bg-danger" : "bg-success");
    $("#toastMessage").text(message);
    new bootstrap.Toast(document.getElementById('toast')).show();
}
function loadKRAs() {
    $("#loader").show();           // Show loader
    $("#kraCards").empty();        // Clear current content

    $.get(API_URL, function(data) {
        let tableHtml = `
            <table class="table table-bordered table-striped" id="KRAManagementTable">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Title</th>
                        <th>Definition</th>
                        <th>Type</th>
                        <th>Source</th>
                        <th title="Comparison Type">Comp. Type</th>
                        <th>Value Type</th>
                        <th width="100">Order</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
        `;

        data.forEach((kra, index) => {
            tableHtml += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${kra.Title}</td>
                    <td>${kra.Defination}</td>
                    <td>${kra.Type}</td>
                    <td>${kra.Source}</td>
                    <td class="text-capitalize">${kra.ComparisonType}</td>
                    <td class="text-capitalize">${kra.Select_Value_Type}</td>
                    <td>
                        <input type="number" value="${kra.SortOrder}" class="form-control form-control-sm" onchange="changeSort(${kra.id}, this.value)">
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary EditButton" onclick="editKRA(${kra.id})" data-bs-toggle="modal" data-bs-target="#kraModal"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger delete Delete-Entry" onclick="deleteKRA(${kra.id})"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
            `;
        });

        tableHtml += `</tbody></table>`;
        $("#kraCards").html(tableHtml);
        $("#loader").hide();       // Hide loader after content loads
    }).fail(() => {
        $("#kraCards").html('<div class="alert alert-danger">Failed to load data</div>');
        $("#loader").hide();       // Hide loader on failure too
    });
}

function resetForm() {
    $("#kraForm")[0].reset();
    $("#kraId").val('');
    $("#ComparisonType").val('higher'); // default
    $("#valueTypeSelector").val('number'); // default

}

function editKRA(id) {
   $.get(API_URL + id + "/", function(data) {
        $("#kraId").val(data.id);
        $("#Title").val(data.Title);
        $("#Defination").val(data.Defination);
        $("#Type").val(data.Type);
        $("#SortOrder").val(data.SortOrder);
        $("#Source").val(data.Source); 
        $("#ComparisonType").val(data.ComparisonType); // Set comparison type
        // $("#valueTypeSelector").val(data.valueTypeSelector.toLowerCase()); // Set comparison type
        $("#valueTypeSelector").val(data.Select_Value_Type.toLowerCase());
        // console.log("valueTypeSelector for edit mode:", data.Select_Value_Type)
    });
}

function changeSort(id, value) {
    $.ajax({
        url: API_URL + id + "/change_sort_order/",
        type: 'POST',
        contentType: 'application/json',         // ðŸ‘ˆ ensure it's JSON
        data: JSON.stringify({ sort_order: value }),  // ðŸ‘ˆ use lowercase key
        success: function () {
            showToast("Sort order updated");
            loadKRAs();
        },
        error: function (xhr) {
            showToast("Failed to update sort order", true);
            console.error(xhr.responseText);  // optional debugging
        }
    });
}


function deleteKRA(id) {
    if (!confirm("Are you sure you want to delete this KRA?")) return;
    $.ajax({
        url: API_URL + id + "/",
        type: 'DELETE',
        success: function() {
            showToast("Deleted successfully");
            loadKRAs();
        },
        error: function() {
            showToast("Delete failed", true);
        }
    });
}

$("#kraForm").submit(function(e) {
    e.preventDefault();
    const id = $("#kraId").val();
    const data = {
        Title: $("#Title").val(),
        Defination: $("#Defination").val(),
        Type: $("#Type").val(),
        Source: $("#Source").val(),
        SortOrder: $("#SortOrder").val(),
        ComparisonType: $("#ComparisonType").val(),  //  Add this
        Select_Value_Type: $("#valueTypeSelector").val().toLowerCase(),  //  Add this
        OrganizationID: 1,
        CreatedBy: 1,
        ModifyBy: 1
    };

    const method = id ? 'PUT' : 'POST';
    const url = id ? API_URL + id + "/" : API_URL;
    const converteddata = JSON.stringify(data)
    // console.log("Type of data", typeof(data));
    // console.log("Type of converteddata", typeof(converteddata));
    // console.log("Type of converteddata", data);
    $.ajax({
        url: url,
        type: method,
        // data: data,
        contentType: 'application/json', 
        data: JSON.stringify(data),
        success: function() {
            showToast("Saved successfully");
            $("#kraModal").modal('hide');
            // resetForm();
            loadKRAs();
        },
        error: function(xhr) {
            showToast("Save failed: " + (xhr.responseText || 'Unknown error'), true);
        }
    });
});

$(document).ready(function() {
    loadKRAs();
});
</script>

{% endblock content %}

