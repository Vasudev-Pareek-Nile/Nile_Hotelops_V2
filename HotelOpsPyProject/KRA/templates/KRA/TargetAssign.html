 {% extends "KRA/homebase.html" %}
{% block content %}

<style>
    .modal#statusSuccessModal .modal-content, 
    .modal#statusErrorsModal .modal-content {
        border-radius: 30px;
    }
    .modal#statusSuccessModal .modal-content svg, 
    .modal#statusErrorsModal .modal-content svg {
        width: 100px; 
        display: block; 
        margin: 0 auto;
    }
    .modal#statusSuccessModal .modal-content .path, 
    .modal#statusErrorsModal .modal-content .path {
        stroke-dasharray: 1000; 
        stroke-dashoffset: 0;
    }
    .modal#statusSuccessModal .modal-content .path.circle, 
    .modal#statusErrorsModal .modal-content .path.circle {
        -webkit-animation: dash 0.9s ease-in-out; 
        animation: dash 0.9s ease-in-out;
    }
    .modal#statusSuccessModal .modal-content .path.line, 
    .modal#statusErrorsModal .modal-content .path.line {
        stroke-dashoffset: 1000; 
        -webkit-animation: dash 0.95s 0.35s ease-in-out forwards; 
        animation: dash 0.95s 0.35s ease-in-out forwards;
    }
    .modal#statusSuccessModal .modal-content .path.check, 
    .modal#statusErrorsModal .modal-content .path.check {
        stroke-dashoffset: -100; 
        -webkit-animation: dash-check 0.95s 0.35s ease-in-out forwards; 
        animation: dash-check 0.95s 0.35s ease-in-out forwards;
    }

    @-webkit-keyframes dash { 
        0% {
            stroke-dashoffset: 1000;
        }
        100% {
            stroke-dashoffset: 0;
        }
    }
    @-webkit-keyframes dash-check { 
        0% {
            stroke-dashoffset: -100;
        }
        100% {
            stroke-dashoffset: 900;
        }
    }
    .box00{
        width: 100px;
        height: 100px;
        border-radius: 50%;
    }

    .path.line {
        stroke-dasharray: 1000;
    }
</style>

<style>
    .listbox select {
        min-height: 400px;
    }

    .card-header{
        margin-bottom: -28px;
    }

    form {
        margin-bottom: -14px !important;;
    }
</style>
<div class="card">
    <div class="card-header text-uppercase fw-bold">
        Target Assign
    </div> 
    <div class="card-body">
        <form action="" method="get" id="filterForm">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <select class="form-control select2" id="I" name="I" onchange="submitForm()">
                            {% for org in orgs %}
                                <option value="{{ org.OrganizationID }}" {% if org.OrganizationID == I %}selected{% endif %}>{{ org.OrganizationName }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div> 
                <div class="col-md-2">
                    <div class="form-group">
                        <select class="form-control" name="employee" id="employee" onchange="submitForm()" required>
                            <option value="">Select</option>
                            {% for Emp in Emps %}
                                <option value="{{ Emp.EmployeeCode }}"   data-doj="{{Emp.DateofJoining}}" {% if Emp.EmployeeCode == selected_employee %}selected{% endif %}>{{ Emp.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <input type="text" name="DOJ" id="DOJ" class="form-control" readonly>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <select class="form-control" id="year" name="year" onchange="submitForm()">
                            {% for year in years %}
                                <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <input type="text" name="SelectedToYear" class="form-control" id="ToYear"> 
                    </div>
                </div>
                <div class="col-md-2" id="filterButton" style="display: none;">
                    <div class="form-group">
                        <button class="btn btn-primary btn-sm" id="FilterForm" type="submit">Filter</button>
                    </div>
                </div>
            </div>
        </form>
        
                
        <form action="" method="post" id="assignForm">
            {% csrf_token %}
            <div class="row mt-4">
                <div class="col-md-5">
                    <div class="listbox">
                        <!-- <input type="text" class="form-control" name="ToYear" readonly  >  -->
                        <input type="text" id="leftFilter" class="form-control mb-2" placeholder="Filter" onkeyup="filterList('leftList', 'leftFilter')">
                        <select id="leftList" name="kra_ids" multiple class="form-control" size="10">
                            {% for kra in Kraobjs %}
                            {% if kra.id not in selected_kras %}  
                            <option value="{{ kra.id }}">{{ kra.Title }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                        <input type="hidden" id="removedKras" name="removed_kras" value="[]">
                        <input type="hidden" name="AssignToDOJ" id="AssignToDOJ">
                        <input type="hidden"  name="SelectedToYear" id="SelectedToYear" readonly  > 

                    </div>

                </div>
                <div class="col-md-2 d-flex flex-column justify-content-center align-items-center">
                    <button id="moveRight" class="btn btn-secondary mb-2" type="button">>></button>
                    <button id="moveLeft" class="btn btn-secondary" type="button"><<</button>
                </div>
                <div class="col-md-5">
                    <div class="listbox">
                        <input type="text" id="rightFilter" class="form-control mb-2" placeholder="Filter" onkeyup="filterList('rightList', 'rightFilter')">
                       
                    <select id="rightList" name="selected_kras" multiple class="form-control" size="10">
                        {% for kra in Kraobjs %}

                            {% if kra.id in selected_kras %}
                            <option value="{{ kra.id }}" {% if kra.id in selected_kras %}selected{% endif %}>{{ kra.Title }}</option>
                        
                            {% endif %}
                            {% endfor %}
                    </select>
                    
                    </select>

                    </div>
                </div>
                <br>
                <br>
            </div>
            <div class="CustomFooter">
                <input type="hidden" id="AssignOrganizationID" name="AssignOrganizationID" value="{{ I }}">
                <input type="hidden" id="AssignEmployeeCode" name="AssignEmployeeCode" value="{{ selected_employee }}">
                <input type="hidden" id="AssignYear" name="AssignYear" value="{{ selected_year }}">
                
                <button class="btn btn-primary btn-sm" type="submit">Assign</button>
            </div>
        </form>
        <br>
    </div>
</div>


<!-- Modal -->
 <div class="container  p-5">
	<div class="row">
		<div class="modal fade" id="statusErrorsModal" tabindex="-1" role="dialog" data-bs-backdrop="static" data-bs-keyboard="false"> 
			<div class="modal-dialog modal-dialog-centered modal-sm" role="document"> 
				<div class="modal-content"> 
					<div class="modal-body text-center p-lg-4"> 
						<!-- <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 130.2 130.2">
							<circle class="path circle" fill="none" stroke="#FFBC34" stroke-width="6" stroke-miterlimit="10" cx="65.1" cy="65.1" r="62.1" /> 
							<line class="path line" fill="none" stroke="#FFBC34" stroke-width="6" stroke-linecap="round" stroke-miterlimit="10" x1="34.4" y1="37.9" x2="95.8" y2="92.3" />
							<line class="path line" fill="none" stroke="#FFBC34" stroke-width="6" stroke-linecap="round" stroke-miterlimit="10" x1="95.8" y1="38" x2="34.4" y2="92.2" /> 
						</svg>  -->
						<h4 class="text-Warning mt-3">Warning !!</h4> 
						{% comment %} <p class="mt-3" id="errorMessageText">Something went wrong while submitting the form.</p> {% endcomment %}
                        <p class="mt-3" id="errorMessageText">
                            {{ error_message|default:"Something went wrong while submitting the form." }}
                        </p>
						<button type="button" class="btn btn-sm mt-3 btn-Warning" data-dismiss="modal">Ok</button> 
					</div> 
				</div> 
			</div> 
		</div>
	</div>
</div> 



<script>
    var BindUserYear = function () {
        const dojString = $("#employee option:selected").data("doj");
        $("#DOJ").val(dojString);
        $("#AssignToDOJ").val(dojString);
        if (!dojString) return;

        const dojDate = new Date(dojString);
        dojDate.setMonth(dojDate.getMonth() - 1);
        const yearSelect = document.getElementById("year");
        yearSelect.innerHTML = "";

        const monthNamesList = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
            "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

        let end = new Date(); // current date
        end = new Date(end.getFullYear(), 12, 1); // include current month
        let current = new Date(end); // clone end date
        
        const options = [];

        while (current >= dojDate) {
            const month = current.getMonth();
            const year = current.getFullYear();
            const value = `${String(month + 1).padStart(2, '0')}-${year}`;
            const text = `${monthNamesList[month]}-${year}`;

            options.push({ value, text });

            current.setMonth(current.getMonth() - 1); // move backward
        }

        // Append in reverse (latest first)
        options.forEach(opt => {
            const option = document.createElement("option");
            option.value = opt.value;
            option.text = opt.text;
            yearSelect.appendChild(option);
        });

        // Get AssignYear from URL (e.g. ?year=08-2023)
        const urlParams = new URLSearchParams(window.location.search);
        const assignYearFromUrl = urlParams.get("year");
        console.log("assignYearFromUrl:",assignYearFromUrl)

        let foundMatch = false;

        // {% comment %} if (assignYearFromUrl) {
        //     for (let i = 0; i < yearSelect.options.length; i++) {
        //         if (yearSelect.options[i].value === assignYearFromUrl) {
        //             yearSelect.options[i].selected = true;
        //             foundMatch = true;
        //             break;
        //         }
        //     }
        // } {% endcomment %}

        if (assignYearFromUrl && assignYearFromUrl.length === 4) {
            // find December of that year
            const targetValue = `01-${assignYearFromUrl}`;

            for (let i = 0; i < yearSelect.options.length; i++) {
                if (yearSelect.options[i].value === targetValue) {
                    yearSelect.options[i].selected = true;
                    foundMatch = true;
                    break;
                }
            }
        }

        if (!foundMatch) {
            const firstOption = yearSelect.options[0]; // latest month is first
            firstOption.selected = true;
        }
        const selectedValue = yearSelect.value;
        console.log("selectedValue:",selectedValue)
        document.getElementById("AssignYear").value = selectedValue;

        // Calculate ToYear = AssignYear + 12 months
        // const [selectedMonthStr, selectedYearStr] = selectedValue.split("-");
        // const selectedMonth = parseInt(selectedMonthStr) - 1;
        // const selectedYear = parseInt(selectedYearStr);
        // const futureDate = new Date(selectedYear, selectedMonth + 12, 1);
        // const toMonth = String(futureDate.getMonth() + 1).padStart(2, '0');
        // const toYear = futureDate.getFullYear();
        // document.getElementById("ToYear").value = `${toMonth}-${toYear}`;
        // $("[name='ToYear']").val(`${toMonth}-${toYear}`);
        // document.getElementById("SelectedToYear").value = `${toMonth}-${toYear}`;
        // $("[name='SelectedToYear']").val(`${toMonth}-${toYear}`);

        // const monthNamesList = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
        //    "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

        // const toMonthName = monthNamesList[futureDate.getMonth()];
        // const toYear = futureDate.getFullYear();

        //document.getElementById("ToYear").value = `${toMonthName}-${toYear}`;
        //document.getElementById("SelectedToYear").value = `${toMonthName}-${toYear}`;

        // Calculate ToYear = December of selected year
        const [selectedMonthStr, selectedYearStr] = selectedValue.split("-");
        const selectedYear = parseInt(selectedYearStr);

        // Always set to December of the same year
        const toMonthName = "Dec";
        const toYear = selectedYear;

        document.getElementById("ToYear").value = `${toMonthName}-${toYear}`;
        document.getElementById("SelectedToYear").value = `${toMonthName}-${toYear}`;
    }

    $(function () {
        BindUserYear();
    });
    document.getElementById("moveLeft").addEventListener("click", function () {
        const leftList = document.getElementById("leftList");
        const rightList = document.getElementById("rightList");
        const removedKras = document.getElementById("removedKras");
    
        Array.from(rightList.selectedOptions).forEach(option => {
            leftList.appendChild(option);
    
            let removedIds = JSON.parse(removedKras.value || "[]");
            removedIds.push(option.value);
            removedKras.value = JSON.stringify(removedIds);
        });
    });
    

    document.getElementById("moveRight").addEventListener("click", function () {
        const leftList = document.getElementById("leftList");
        const rightList = document.getElementById("rightList");
        
        Array.from(leftList.selectedOptions).forEach(option => {
            rightList.appendChild(option);
        });
    });

    document.getElementById("moveLeft").addEventListener("click", function () {
        const leftList = document.getElementById("leftList");
        const rightList = document.getElementById("rightList");
        
        Array.from(rightList.selectedOptions).forEach(option => {
            leftList.appendChild(option);
        });
    });

    function filterList(listId, filterId) {
        const filterText = document.getElementById(filterId).value.toLowerCase();
        const list = document.getElementById(listId);
        
        Array.from(list.options).forEach(option => {
            const text = option.text.toLowerCase();
            option.style.display = text.includes(filterText) ? '' : 'none';
        });
    }

    document.querySelector("form").addEventListener("submit", function (event) {
        const rightList = document.getElementById("rightList");
        const selectedKras = Array.from(rightList.options).map(option => option.value);
        document.getElementById("selectedKras").value = JSON.stringify(selectedKras);
    });
   
   
  
  

    function submitForm() {
        document.getElementById("filterButton").style.display = 'none';
        
        document.getElementById("filterForm").submit();
        var EmployeeCode = document.getElementById("employee").value;
        var OrganizationID = document.getElementById("I").value;
        var Year = document.getElementById("year").value;

        document.getElementById("AssignEmployeeCode").value = EmployeeCode;
        document.getElementById("AssignOrganizationID").value = OrganizationID;
        document.getElementById("AssignYear").value = Year;
    }
    
    $(document).ready(function () {
      var selectedOrganization = "{{ I }}";
      $("select[name='I']").val(selectedOrganization);
      
      $('.select2').select2();
  }); 

  
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("assignForm").addEventListener("submit", function (e) {
            const empSelect = document.getElementById("employee");
            if (!empSelect.value) {
                e.preventDefault();  // Stop form submission
                alert("Please select an employee first.");
                empSelect.focus();
            }
        });
    });
</script>

{% if error_message %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Set the message inside the modal dynamically
        document.getElementById('errorMessageText').textContent = "{{ error_message|escapejs }}";

        // Open the modal using the new ID
        const errorModal = new bootstrap.Modal(document.getElementById('statusErrorsModal'));
        errorModal.show();

        // Clean the URL so modal doesn't appear again on refresh
        if (window.history.replaceState) {
            const cleanUrl = window.location.origin + window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
        }
    });
</script>
{% endif %}

{% endblock content %}
