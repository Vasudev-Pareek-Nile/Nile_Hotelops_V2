{% extends "HR/EmployeeDashboard/EditEmployee.html" %}
 {% load static %} 
{% block content %}

<style>
    .card {
        border-radius: 5px;
        border: 1px solid #0000004f;
    }
    
    .card-header{
        margin-bottom: -20px !important;
    }
</style>
<link href="{% static 'css/plugins/sweetalert/sweetalert.css' %}" rel="stylesheet">


<div class="card">
    <div class="card-header d-flex justify-content-between">
       <span class=" text-uppercase fw-bold">  Salary Information </span> 
        <a href="{% url 'Salary_Details_Settlement' EmpID OrganizationID %}" class="btn btn-primary btn-sm float-right">Add New</a>
    </div>

    {% comment %} <div class="card-body"> {% endcomment %}
        <div class="main m-3">
            <div class="row m-1">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>SR#</th>
                            <th>Effective From</th>
                            <th>CTC</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="salaryTable">

                    </tbody>
                </table>
            </div>
        </div>
    {% comment %} </div> {% endcomment %}
</div>

<script>
    let empId = "{{ EmpID }}";
    let orgId = "{{ OrganizationID }}";

    // reusable function to load data
    function loadSalaryTable() {
        fetch("{% url 'get_salary_effective_data' EmpID OrganizationID %}")
            .then(response => response.json())
            .then(data => {
                let tbody = document.getElementById("salaryTable");

                tbody.innerHTML = ""; // clear old data
                data.forEach((item, index) => {

                    const effectiveDate = new Date(item.EffectiveFrom);
                    const formattedDate = effectiveDate.toLocaleDateString('en-GB', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric'
                    }); 

                    let row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${formattedDate}</td>
                            <td>${item.CTC}</td>
                            <td>
                                <a href="/HumanResources/Update_Salary_Details_Settlement/${item.EmpID}/${item.OrganizationID}/${item.id}/" class="btn btn-primary btn-sm">Edit</a>
                                <a href="javascript:void(0);" onclick="deleteSalary(${item.EmpID}, ${item.OrganizationID}, ${item.id})" class="btn btn-danger text-white btn-sm">Delete</a>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
    }

    // call it on page load
    document.addEventListener("DOMContentLoaded", function () {
        loadSalaryTable();
    });

    function deleteSalary(empId, orgId, settleId) {
        if (!confirm("Are you sure you want to delete this record?")) return;

        let baseUrl = "{% url 'delete_salary_effective' 0 0 0 %}";
        let finalUrl = baseUrl.replace("0/0/0", empId + "/" + orgId + "/" + settleId);

        fetch(finalUrl, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                alert(data.message);
                loadSalaryTable(); // reload fresh data from API
            } else {
                alert(data.message);
            }
        });
    }
</script>


<script>
    $(document).ready(function () {
        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get('Success');
        
        if (success === 'True') {
            showSuccess();
            removeSuccessParam();
        }
        if (success === 'Deleted') {
            showDelete();
            removeSuccessParam();
        }
        if (success === 'Uploaded') {
            showUploaded();
            removeSuccessParam();
        }

        function removeSuccessParam() {
            urlParams.delete('Success'); 
            const newUrl = window.location.pathname + '?' + urlParams.toString();
            window.history.replaceState(null, '', newUrl);
        }
    });
</script>



{% endblock content %}





