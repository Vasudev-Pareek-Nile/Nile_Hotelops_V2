{% extends "HR/EmployeeDashboard/EditEmployee.html" %}
 {% load static %} 
{% block content %}
<link href="{% static 'css/plugins/sweetalert/sweetalert.css' %}" rel="stylesheet">

<style>
    .strike{
        color: red;
    }
    label{
        padding-top: 14px;
    }
    .card {
        border-radius: 5px;
        border: 1px solid #0000004f;
    }

    .card-header{
        margin-bottom: -20px !important;
    }


    .custom-file-wrapper {
        display: inline-flex;
        flex-direction: column;
        align-items: left;
        gap: 5px;
        width: 100%;
    }

    .custom-file-btn {
        background: #e8e8e8;
        padding: 1px 8px;
        border-radius: 6px;
        border: 1px solid #ccc;
        cursor: pointer;
        margin-top: 5px;
    }

    .real-file-input {
        display: none;
    }

    #file-name{
        font-size: 11px;
    }

    .submit-button-wrapper{
        text-align: right;
    }

    #saveButton{
        margin-top: 1.5rem !important;
    }
</style>
<div class="card pb-2">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span class="text-uppercase fw-bold">Personal Information</span>
        <button id="editButton" class="btn btn-primary btn-sm float-right">Edit</button>
    </div>
    <form id="personalInfoForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="main">
            <div class="row m-1">
                <div class="col-md-10">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>Code <span class="strike">*</span></label>
                                <input id="EmployeeCode" name="EmployeeCode" type="text" class="form-control" value="{{Emobj.EmployeeCode}}" readonly required>
                                <span id="EmployeeCodeerror" style="color:red;"></span>


                                <input type="hidden" name="Pre_EmpID" value="{{Eduboj.id}}">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>Prefix <span class="strike">*</span></label>
                                <select name="Prefix" id="Prefix" class="form-control" required disabled>
                                    <option value="" {% if Emobj.Prefix == "" %}selected{% endif %}>Select</option>
                                    <option value="Mr." {% if Emobj.Prefix == "Mr." %}selected{% endif %}>Mr.</option>
                                    <option value="Ms." {% if Emobj.Prefix == "Ms." %}selected{% endif %}>Ms.</option>
                                    <option value="Mrs." {% if Emobj.Prefix == "Mrs." %}selected{% endif %}>Mrs.</option>
                                    <option value="Miss." {% if Emobj.Prefix == "Miss." %}selected{% endif %}>Miss.</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>First Name <span class="strike">*</span></label>
                                <input id="FirstName" name="FirstName" type="text" value="{{Emobj.FirstName}}" class="form-control" required disabled>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>Middle Name</label>
                                <input id="MiddleName" name="MiddleName" value="{{Emobj.MiddleName}}" type="text" class="form-control" disabled>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Last Name <span class="strike">*</span></label>
                                <input id="LastName" name="LastName" value="{{Emobj.LastName}}" type="text" class="form-control" required disabled>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Gender <span class="strike">*</span></label>
                                <select id="Gender" name="Gender" class="form-control" required disabled>
                                    <option value="" {% if Emobj.Gender == "" %}selected{% endif %}>Select</option>
                                    <option value="Male" {% if Emobj.Gender == "Male" %}selected{% endif %}>Male</option>
                                    <option value="Female" {% if Emobj.Gender == "Female" %}selected{% endif %}>Female</option>
                                    <option value="Other" {% if Emobj.Gender == "Other" %}selected{% endif %}>Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Marital Status <span class="strike">*</span></label>
                                <select id="MaritalStatus" name="MaritalStatus" class="form-control" required disabled>
                                    <option value="" {% if Emobj.MaritalStatus == "" %}selected{% endif %}>Select</option>
                                    <option value="Unmarried" {% if Emobj.MaritalStatus == "Unmarried" %}selected{% endif %}>Unmarried</option>
                                    <option value="Married" {% if Emobj.MaritalStatus == "Married" %}selected{% endif %}>Married</option>
                                    <option value="Other" {% if Emobj.MaritalStatus == "Other" %}selected{% endif %}>Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Date of Birth <span class="strike">*</span></label>
                                <input id="DateOfBirth" name="DateofBirth" type="date" value="{% if Emobj.DateofBirth %}{{Emobj.DateofBirth|date:'Y-m-d'}}{% else %}{% now 'Y-m-d' %}{% endif %}" class="form-control" required disabled>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Age <span class="strike">*</span></label>
                                <input id="age" name="age" type="number" class="form-control" value="{{Emobj.age}}" required disabled>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Mobile Number <span class="strike">*</span></label>
                                <input id="MobileNumber" name="MobileNumber" type="text" value="{{Emobj.MobileNumber}}" class="form-control" required pattern="[6789][0-9]{9}" title="Enter a valid Indian mobile number" disabled>
                                <span id="mobileError" style="color:red;"></span>

                                <script>
                                    document.getElementById('MobileNumber').addEventListener('input', function () {
                                        const mobile = this.value;
                                        // For Indian mobile numbers (10 digits starting with 7, 8, or 9)
                                        const regex = /^[6-9]\d{9}$/;
                                        const mobileError = document.getElementById('mobileError');

                                        if (!regex.test(mobile)) {
                                            mobileError.textContent = "Invalid mobile number";
                                        } else {
                                            mobileError.textContent = "";
                                        }
                                    });
                                </script>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Covid Vaccination <span class="strike">*</span></label>
                                <select id="CovidVaccination" name="CovidVaccination" class="form-control" disabled>
                                    <option value = "Yes" {% if Emobj.CovidVaccination == "Yes" %}selected{% endif %}>Yes</option>
                                    <option value = "No" {% if Emobj.CovidVaccination == "No" %}selected{% endif %}>No</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-md-5">
                            <div class="form-group">
                                <label>Email Address <span class="strike">*</span></label>
                                <input id="EmailAddress" name="EmailAddress" type="email" class="form-control" value="{{Emobj.EmailAddress}}" required disabled>
                                <span id="emailError" style="color:red;"></span>

                                <script>
                                    document.getElementById('EmailAddress').addEventListener('input', function () {
                                        const email = this.value;
                                        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                                        const emailError = document.getElementById('emailError');
    
                                        if (!regex.test(email)) {
                                            emailError.textContent = "Invalid email format";
                                        } else {
                                            emailError.textContent = "";
                                        }
                                    });
                                </script>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Details of Illness (if any)</label>
                                <textarea id="IllnessDetails" rows="1" name="IllnessDetails" class="form-control" disabled>{{Emobj.DetailsofIllness}}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-2 mt-4">
                    <div class="form-group">    
                        {% if Emobj.ProfileImageFileName  %}
                            <img id="ProfileImagePreviewedit" src="{% url 'Humanview_file' %}?ID={{ Emobj.EmpID }}&model=EmployeePersonalDetails" alt="Profile Image Preview" style="width: 100%; height: 80%;"> 
                        {% else %}
                        <img id="ProfileImagePreviewedit" src="{% static 'Images/avatarimg.webp' %}" alt="Profile Image Preview" style="width: 100%; height: 80%;">
                       
                        {% endif %}
                        <!-- <input id="ProfileImage" name="ProfileImage" type="file" class="file-control mt-1" accept="image/*"  disabled> -->
                        <!-- <label for="ProfileImage">Profile Image <span class="strike">*</span></label>  -->

                        <div class="custom-file-wrapper">
                            <label for="ProfileImage" class="custom-file-btn">Choose File</label>
                            <span id="file-name">No file chosen</span>

                            <input id="ProfileImage" name="ProfileImage" type="file" 
                                accept="image/*" class="real-file-input" disabled>
                        </div>
                        <div class="submit-button-wrapper">
                            <button type="submit" id="saveButton" class="btn btn-primary Successpopup" style="display: none;">Save</button>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        <!-- <div class="m-3 CustomFooter">
            <button type="submit" id="saveButton" class="btn btn-primary Successpopup" style="display: none;">Save</button>
        </div> -->
    </form>
</div>
<script src="{% static 'js/plugins/sweetalert/sweetalert.min.js' %}"></script>



<script>
    // Reusable validation function
    function validateEmployeeCode() {
        const EmployeeCode = document.getElementById('EmployeeCode').value;
        const OrganizationID = '{{OrganizationID}}';
        const errorMessageSpan = document.getElementById('EmployeeCodeerror');
        const saveButton = document.getElementById('saveButton');

        // Clear previous messages
        errorMessageSpan.textContent = '';

        // AJAX call to validate EmployeeCode
        $.ajax({
            url: `/HumanResources/CheckEmployeeCode/?EmployeeCode=${EmployeeCode}&OrganizationID=${OrganizationID}`,
            method: 'GET',
            dataType: 'json',
            headers: {
                'hotel-api-token': '{{hotelapitoken}}'
            },
            success: function (data) {
                saveButton.disabled = false; // Enable the button by default

                if (data.error) {
                    errorMessageSpan.textContent = data.error;
                    saveButton.disabled = true; // Disable the button if there's an error
                } else {
                    if (data.status === 'exists') {
                        errorMessageSpan.textContent = data.message; // Display message if employee code exists
                        saveButton.disabled = true; // Disable the button if employee code exists
                    } else if (data.status === 'not_found') {
                        errorMessageSpan.textContent = ''; // Clear the message if not found
                        saveButton.disabled = false; // Enable the button if no errors
                    }
                }
            },
            error: function (xhr, status, error) {
                console.error('Error checking employee code:', error);
                saveButton.disabled = true; // Disable the button if AJAX call fails
            }
        });
    }

    // Add event listeners
    document.getElementById('EmployeeCode').addEventListener('keyup', function () {
        validateEmployeeCode(); // Call validation function on keyup
    });

    document.getElementById('saveButton').addEventListener('click', function (event) {
        event.preventDefault(); // Prevent form submission initially
        validateEmployeeCode(); // Call validation function on submit

        // Optionally, check if button is enabled before submitting
        if (!document.getElementById('saveButton').disabled) {
            document.getElementById('personalInfoForm').submit(); // Replace 'yourFormId' with the actual form ID
        }
    });
</script>


<script>
    $(document).ready(function () {
        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get('Success');
        
        if (success === 'True') {
            showSuccess();
            removeSuccessParam();
        }
        if (success === 'Deleted') {
            showDelete();
            removeSuccessParam();
        }
        if (success === 'Uploaded') {
            showUploaded();
            removeSuccessParam();
        }

        function removeSuccessParam() {
            urlParams.delete('Success'); 
            const newUrl = window.location.pathname + '?' + urlParams.toString();
            window.history.replaceState(null, '', newUrl);
        }
    });
</script>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const editButton = document.getElementById('editButton');
        const saveButton = document.getElementById('saveButton');
        const inputs = document.querySelectorAll('#personalInfoForm input, #personalInfoForm select, #personalInfoForm textarea');
        
        editButton.addEventListener('click', function() {
            if (editButton.textContent === 'Edit') {
                editButton.textContent = 'Cancel';
                saveButton.style.display = 'inline-block';
                inputs.forEach(input => input.removeAttribute('readonly'));
                inputs.forEach(input => input.removeAttribute('disabled'));
            } else {
                editButton.textContent = 'Edit';
                saveButton.style.display = 'none';
                inputs.forEach(input => input.setAttribute('readonly', 'readonly'));
                inputs.forEach(input => input.setAttribute('disabled', 'disabled'));
    
                // Re-enable the Date of Birth and Age fields
                document.getElementById('DateOfBirth').setAttribute('disabled', 'disabled');
                document.getElementById('age').setAttribute('disabled', 'disabled');
            }
        });
    });
    </script>
    
    <script>
    $(document).ready(function() {
        function calculateAge(dobSelector, ageSelector) {
            var dob = new Date($(dobSelector).val());
            var today = new Date(); 
            var age = today.getFullYear() - dob.getFullYear();
            var monthDifference = today.getMonth() - dob.getMonth();
            if (monthDifference < 0 || (monthDifference === 0 && today.getDate() < dob.getDate())) {
                age--;
            }
            $(ageSelector).val(age);
        }
    
        // Profile image preview
        $('#ProfileImage').on('change', function() {
            var file = this.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#ProfileImagePreviewedit').attr('src', e.target.result);
                }
                reader.readAsDataURL(file);
            }
        });
    
        $('#DateOfBirth').on('change', function() {
            calculateAge(this, '#age');
        });
    });

    document.getElementById("ProfileImage").addEventListener("change", function () {
        let fileName = this.files.length ? this.files[0].name : "No file chosen";
        document.getElementById("file-name").textContent = fileName;
    });
</script>

{% endblock content %}





