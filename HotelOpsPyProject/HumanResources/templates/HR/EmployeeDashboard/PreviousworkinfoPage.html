{% extends "HR/EmployeeDashboard/EditEmployee.html" %}
 {% load static %} 
{% block content %}
<link href="{% static 'css/plugins/sweetalert/sweetalert.css' %}" rel="stylesheet">

<style>
    
    #ProfileImagePreview {
        border-radius: 50%;
        border: 2px solid #ddd;     
        margin-top: 10px;
        max-width: 150px; 
        height: 150px;    
        object-fit: cover; 
    }

    .card {
        border-radius: 5px;
        border: 1px solid #0000004f;
    }
    
    .card-header{
        margin-bottom: -20px !important;
    }
</style>

<div class="modal fade modalPr" id="fileModal" tabindex="-1" role="dialog" aria-labelledby="fileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fileModalLabel">File Preview</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <iframe id="filePreview" style="width: 100%; height: 500px; border: none;" onerror="this.style.display='none'; document.getElementById('filePreviewFallback').style.display='block';"></iframe>
                <div id="filePreviewFallback" style="display:none;">
                    <p>Your browser does not support inline previews. <a id="downloadLink" href="#" download>Click here to download the file.</a></p>
                </div>
            </div>
            <div class="modal-footer">
                <a id="downloadLink" class="btn btn-primary" href="#" download>Download</a>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>



<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
       <span class=" text-uppercase fw-bold">  Previous Work Information </span> 
        <button id="editButton" class="btn btn-primary btn-sm float-right">Edit</button>
    </div>

    <form id=" PreviousWorkForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="main">
         
            <div class="row m-3 mb-0">
                                {% comment %} <table id="previousworkinformationsTable" class="table table-bordered" style="width: 100%;">
                                    <thead>
                                        <tr>
                                            <th>Company</th>
                                            <th>Position</th>
                                            <th>From</th>
                                            <th style="width: 250px;">To</th>
                                            <th>Attachment</th>
                                            <th>Salary</th>
                                            <th  class="Action">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                      {% for pre in previousworks %}
                                        <tr id="Prerow{{ pre.id }}">
                                            <td><input type="text" class="form-control" name="Company[]" value="{{ pre.Company }}" required></td>
                                            <td><input type="text" class="form-control" name="Position[]" value="{{ pre.Position }}" required></td>
                                            <td><input type="date" class="form-control" name="FromDate[]" value="{% if pre  %}{{ pre.FromDate|date:'Y-m-d' }}{% else %}{% now "Y-m-d" %}{% endif %}" required></td>
                                           
                                            <td st>
                                
                                                <div class="form-inline">
                                                    <div class="form-group">
                                                        <input type="checkbox" class="form-check-input presentCheckbox" id="isPresent{{ pre.id }}" 
                                                               {% if pre.IsPresent == True %}checked{% endif %} onclick="toggleDateInput(this)">
                                                        <label class="form-check-label" for="isPresent{{ pre.id }}">Present</label>
                                                
                                                        <input type="date" class="form-control ml-2 toDateInput" name="ToDate[]" 
                                                               value="{% if pre.ToDate %}{{ pre.ToDate|date:'Y-m-d' }}{% else %}{% now 'Y-m-d' %}{% endif %}" 
                                                               {% if pre.IsPresent == True %}style="display:none"{% endif %}>
                                                
                                                        <input type="hidden" class="presentHiddenInput" name="IsPresentHidden[]" 
                                                               value="{% if pre.IsPresent == True %}On{% else %}Off{% endif %}">
                                                    </div>
                                                </div>
                                                
                                            </td>
                                           
                                           
                                           
                                            <td>
                                                <input type="file" class="form-control" name="AttachmentPreviousWork[]"  {% if pre.FileTitle %}{% else %}required{% endif %} >
                                              
                                                {% if pre.FileName %}
                                                Previous Document
                                                <a  href="javascript:void(0)" data-href="{% url 'Humanview_file' %}?ID={{ pre.id }}&model=EmployeePreviousWorkInformationDetails" 
                                                class="btn btn-primary btn-sm ml-2"
                                                onclick="showEduDetails(this)"
                                                >
                                               <span class="fa fa-eye"></span>
                                                </a>

                                                {% else %}

                                                {% endif %}





                                            </td>
                                            <td><input type="text" class="form-control" name="Salary[]" value="{{ pre.Salary }}" required></td>
                                            <td>
                                                <button type="button" class="btn btn-danger btn-sm Action" onclick="removePreviousRow('{{ pre.id }}')">REMOVE</button>
                                                <input type="hidden" name="Pre_ids[]" value="{{ pre.id }}">
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="7" class="text-right Action">
                                                <button type="button" class="btn btn-primary btn-sm Action" onclick="addPreviousRow()">ADD</button>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                                
                                <input type="hidden" id="removedPreIds" name="removed_Pre_ids[]">     {% endcomment %}

                                <table id="previousworkinformationsTable" class="table table-bordered" style="width: 100%;">
                                    <thead>
                                        <tr>
                                            <th>Company</th>
                                            <th>Position</th>
                                            <th>From</th>
                                            <th style="width: 250px;">To</th>
                                            <th>Attachment</th>
                                            <th>Salary</th>
                                            <th class="Action">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for pre in previousworks %}
                                        <tr id="Prerow{{ pre.id }}">
                                            <td><input type="text" class="form-control" name="Company[]" value="{{ pre.Company }}" required></td>
                                            <td><input type="text" class="form-control" name="Position[]" value="{{ pre.Position }}" required></td>
                                            <td><input type="date" class="form-control" name="FromDate[]" value="{{ pre.FromDate|date:'Y-m-d' }}" required></td>
                                            <td><input type="date" class="form-control" name="ToDate[]" value="{{ pre.ToDate|date:'Y-m-d' }}" required></td>
                                            <td>
                                                <input type="file" class="form-control" name="AttachmentPreviousWork[]" {% if pre.FileTitle %}{% else %}required{% endif %}>
                                                {% if pre.FileName %}
                                                Previous Document
                                                <a href="javascript:void(0)" data-href="{% url 'Humanview_file' %}?ID={{ pre.id }}&model=EmployeePreviousWorkInformationDetails" class="btn btn-primary btn-sm ml-2" onclick="showEduDetails(this)">
                                                    <span class="fa fa-eye"></span>
                                                </a>
                                                {% endif %}
                                            </td>
                                            <td><input type="text" class="form-control" name="Salary[]" value="{{ pre.Salary }}" required></td>
                                            <td>
                                                <button type="button" class="btn btn-danger btn-sm Action" onclick="removePreviousRow('{{ pre.id }}')">REMOVE</button>
                                                <input type="hidden" name="Pre_ids[]" value="{{ pre.id }}">
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="7" class="text-right Action">
                                                <button type="button" class="btn btn-primary btn-sm Action" onclick="addPreviousRow()">ADD</button>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                                
                                <input type="hidden" id="removedPreIds" name="removed_Pre_ids[]">
                                
             </div>
        
        </div>
        <div class="CustomFooter m-3">
            <button type="submit" id="saveButton" class="btn btn-primary Successpopup" style="display: none;">Save</button>
        </div>
    </form>
</div>


{% comment %} 
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const editButton = document.getElementById('editButton');
        const saveButton = document.getElementById('saveButton');
        const inputs = document.querySelectorAll('#previousworkinformationsTable input, #previousworkinformationsTable select, #previousworkinformationsTable textarea');
        const addButton = document.querySelector('#previousworkinformationsTable tfoot button');
        const removeButtons = document.querySelectorAll('#previousworkinformationsTable tbody .btn-danger');
        
        function toggleInputs(disabled) {
            inputs.forEach(input => {
                if (disabled) {
                    input.setAttribute('readonly', 'readonly');
                    input.setAttribute('disabled', 'disabled');
                } else {
                    input.removeAttribute('readonly');
                    input.removeAttribute('disabled');
                }
            });
            
            if (disabled) {
                addButton.setAttribute('disabled', 'disabled');
                removeButtons.forEach(button => button.setAttribute('disabled', 'disabled'));
            } else {
                addButton.removeAttribute('disabled');
                removeButtons.forEach(button => button.removeAttribute('disabled'));
            }
        }
    
        editButton.addEventListener('click', function() {
            if (editButton.textContent.trim() === 'Edit') {
                editButton.textContent = 'Cancel';
                saveButton.style.display = 'inline-block';
                toggleInputs(false);
            } else {
                editButton.textContent = 'Edit';
                saveButton.style.display = 'none';
                toggleInputs(true);
            }
        });
    
        toggleInputs(true);
    });
    

    
</script> {% endcomment %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const editButton = document.getElementById('editButton');
        const saveButton = document.getElementById('saveButton');
        const inputs = document.querySelectorAll('#previousworkinformationsTable input, #previousworkinformationsTable select, #previousworkinformationsTable textarea');
        const addButton = document.querySelector('#previousworkinformationsTable tfoot button');
        const removeButtons = document.querySelectorAll('#previousworkinformationsTable tbody .btn-danger');
        const actionColumn = document.querySelectorAll('#previousworkinformationsTable .Action'); // Select Action column

        function toggleInputs(disabled) {
            inputs.forEach(input => {
                if (disabled) {
                    input.setAttribute('readonly', 'readonly');
                    input.setAttribute('disabled', 'disabled');
                } else {
                    input.removeAttribute('readonly');
                    input.removeAttribute('disabled');
                }
            });

            if (disabled) {
                addButton.setAttribute('disabled', 'disabled');
                removeButtons.forEach(button => button.setAttribute('disabled', 'disabled'));
            } else {
                addButton.removeAttribute('disabled');
                removeButtons.forEach(button => button.removeAttribute('disabled'));
            }
        }

        function toggleActionColumn(visible) {
            actionColumn.forEach(col => {
                col.style.display = visible ? '' : 'none'; // Show or hide the column
            });
        }

        editButton.addEventListener('click', function() {
            if (editButton.textContent.trim() === 'Edit') {
                editButton.textContent = 'Cancel';
                saveButton.style.display = 'inline-block';
                toggleInputs(false);
                toggleActionColumn(true); // Show Action column
            } else {
                editButton.textContent = 'Edit';
                saveButton.style.display = 'none';
                toggleInputs(true);
                toggleActionColumn(false); // Hide Action column
            }
        });

        // Initial setup
        toggleInputs(true);
        toggleActionColumn(false); // Hide Action column on page load
    });
</script>




<script>
    $(document).ready(function () {
        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get('Success');
        
        if (success === 'True') {
            showSuccess();
            removeSuccessParam();
        }
        if (success === 'Deleted') {
            showDelete();
            removeSuccessParam();
        }
        if (success === 'Uploaded') {
            showUploaded();
            removeSuccessParam();
        }

        function removeSuccessParam() {
            urlParams.delete('Success'); 
            const newUrl = window.location.pathname + '?' + urlParams.toString();
            window.history.replaceState(null, '', newUrl);
        }
    });
</script>
{% comment %} 
<script>
    var showEduDetails= function(obj)
    {
            var hurl = $(obj).attr('data-href');
            $(".modalPr").modal('show')
            $(".modalPr iframe").attr('src',hurl);

    }
   

</script> {% endcomment %}



<script>
    let newPreCount = 0; // Counter for new rows

function addPreviousRow() {
    // Get the table's <tbody> element
    var table = document.getElementById('previousworkinformationsTable').getElementsByTagName('tbody')[0];
    var newRow = table.insertRow(); // Insert a new row
    newPreCount++;
    var newId = 'new_' + newPreCount; // Generate a unique ID for the new row
    var today = new Date().toISOString().split('T')[0]; // Get today's date in 'YYYY-MM-DD' format

    // Set the ID for the new row
    newRow.id = 'Prerow' + newId;

    // Add the HTML content for the new row
    newRow.innerHTML = `
        <td><input type="text" class="form-control" name="Company[]" required></td>
        <td><input type="text" class="form-control" name="Position[]" required></td>
        <td><input type="date" class="form-control" name="FromDate[]" required value="${today}"></td>
        <td><input type="date" class="form-control" name="ToDate[]" required value="${today}"></td>
        <td><input type="file" class="form-control" name="AttachmentPreviousWork[]" required></td>
        <td><input type="text" class="form-control" name="Salary[]" required></td>
        <td>
            <button type="button" class="btn btn-danger btn-sm" onclick="removePreviousRow('${newId}')">REMOVE</button>
            <input type="hidden" name="Pre_ids[]" value="${newId}">
        </td>
    `;
}

function removePreviousRow(PreId) {
    // Get the row by its ID
    var row = document.getElementById('Prerow' + PreId);

    // If the row exists, remove it and track the removed IDs
    if (row) {
        row.parentNode.removeChild(row);
        addRemovedPreId(PreId);
    }
}

function addRemovedPreId(PreId) {
    // Get the hidden input storing removed IDs
    var removedPreIdsInput = document.getElementById('removedPreIds');
    var removedPreIds = removedPreIdsInput.value.split(',').filter(id => id); // Split existing IDs and filter empty ones

    // Add the ID to the list if not already present
    if (!removedPreIds.includes(PreId)) {
        removedPreIds.push(PreId);
        removedPreIdsInput.value = removedPreIds.join(',');
    }
}

function showEduDetails(btn) {
    // Logic to display additional details when a document is clicked
    var url = btn.getAttribute('data-href');
    window.open(url, '_blank');
}

</script>

<script>
    function toggleDateInput(checkbox) {
        const dateInput = checkbox.closest('.form-group').querySelector('.toDateInput');
        const hiddenInput = checkbox.closest('.form-group').querySelector('.presentHiddenInput');

        if (checkbox.checked) {
            dateInput.style.display = 'none';  
            hiddenInput.value = "On";  
        } else {
            dateInput.style.display = 'inline-block';  
            hiddenInput.value = "Off"; 

            if (!dateInput.value) {
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
            }
        }
    }

    document.querySelectorAll('.presentCheckbox').forEach(function (checkbox) {
        toggleDateInput(checkbox); 
    });
</script>
{% endblock content %}





