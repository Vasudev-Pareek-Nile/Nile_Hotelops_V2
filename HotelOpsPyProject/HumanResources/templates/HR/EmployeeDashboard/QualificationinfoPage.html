{% extends "HR/EmployeeDashboard/EditEmployee.html" %}
 {% load static %} 
{% block content %}
<link href="{% static 'css/plugins/sweetalert/sweetalert.css' %}" rel="stylesheet">

<style>
    
    #ProfileImagePreview {
        border-radius: 50%;
        border: 2px solid #ddd;     
        margin-top: 10px;
        max-width: 150px; 
        height: 150px;    
        object-fit: cover; 
    }
    .card {
        border-radius: 5px;
        border: 1px solid #0000004f;
    }
    
    .card-header{
        margin-bottom: -20px !important;
    }
</style>

<div class="modal fade modalPr" id="fileModal" tabindex="-1" role="dialog" aria-labelledby="fileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fileModalLabel">File Preview</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <iframe id="filePreview" style="width: 100%; height: 500px; border: none;" onerror="this.style.display='none'; document.getElementById('filePreviewFallback').style.display='block';"></iframe>
                <div id="filePreviewFallback" style="display:none;">
                    <p>Your browser does not support inline previews. <a id="downloadLink" href="#" download>Click here to download the file.</a></p>
                </div>
            </div>
            <div class="modal-footer">
                <a id="downloadLink" class="btn btn-primary" href="#" download>Download</a>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>



<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span class=" text-uppercase fw-bold">Qualification Information</span> 
        <button id="editButton" class="btn btn-primary btn-sm float-right">Edit</button>
    </div>

    <form id=" QualificationForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="main">
         
            <div class="row m-3 mb-0">
                <table id="educationTable" class="table table-bordered" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Education Type</th>
                            <th>Degree/Course</th>
                            <th>Name of the Institution</th>
                            <th>Year</th>
                            {% comment %} <th>Percentage</th> {% endcomment %}
                            <th>Attachment</th>
                            <th class="Action">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                         {% for Edu in Educations %} 
                        <tr id="Edurow{{ Edu.id }}">
                            <td>
                                <select class="form-control" name="EducationType[]">
                                    <option value="Secondary" {% if Edu.EducationType == "Secondary" %}selected{% endif %}>Secondary</option>
                                    <option value="Higher Secondary" {% if Edu.EducationType == "Higher Secondary" %}selected{% endif %}>Higher Secondary</option>
                                    <option value="Graduation" {% if Edu.EducationType == "Graduation" %}selected{% endif %}>Graduation</option>
                                    <option value="Post Graduation" {% if Edu.EducationType == "Post Graduation" %}selected{% endif %}>Post Graduation</option>
                                    <option value="Diploma" {% if Edu.EducationType == "Diploma" %}selected{% endif %}>Diploma</option>
                                    <option value="Certificate" {% if Edu.EducationType == "Certificate" %}selected{% endif %}>Certificate</option>
                                    <option value="Other" {% if Edu.EducationType == "Other" %}selected{% endif %}>Other</option>
                                </select>
                            </td>
                            <td><input type="text" class="form-control" name="DegreeCourse[]" value="{{ Edu.Degree_Course }}"></td>
                            <td><input type="text" class="form-control" name="InstitutionName[]" value="{{ Edu.NameoftheInstitution }}"></td>
                            <td>
                                
                                <input type="hidden" value="{{Edu.Year}}">
                                <select id="yearDropdown{{ Edu.id }}" class="form-control" name="Year[]">
                                
                                </select>
                            </td>

                            {% comment %} <td><input type="text" class="form-control" name="Percentage[]" value="{{ Edu.Percentage }}"></td> {% endcomment %}
                            <td>
                                <input type="file" class="form-control" name="AttachmentEducation[]">
                              

                             
                                {% if Edu.FileName %}
                                    
                                 
                            
                                Previous Document
                                <a  href="javascript:void(0)" data-href="{% url 'Humanview_file' %}?ID={{ Edu.id }}&model=EmployeeQualificationDetails" 
                                class="btn btn-primary btn-sm ml-2"
                                onclick="showEduDetails(this)"
                                >
                               <span class="fa fa-eye"></span>
                                </a>

                               
                                {% else %}

                                {% endif %}
                              
               
                                   
                               



                            </td>
                            <td>
                                <button type="button" class="btn btn-danger btn-sm Action" onclick="removeEducationRow('{{ Edu.id }}')">REMOVE</button>
                                <input type="hidden" name="Edu_ids[]" value="{{ Edu.id }}">
                            </td>
                        </tr>
                       {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="7" class="text-right Action">
                                <button type="button" class="btn btn-primary btn-sm Action" onclick="addEducationRow()">ADD</button>
                            </td>
                        </tr>
                    </tfoot>
                </table>
                
                <input type="hidden" id="removedEduIds" name="removed_Edu_ids[]">    
            </div>
            
        </div>
        <div class="CustomFooter m-3">
            <button type="submit" id="saveButton" class="btn btn-primary Successpopup" style="display: none;">Save</button>
        </div>
    </form>
</div>



<script>
    document.addEventListener('DOMContentLoaded', function() {
        const editButton = document.getElementById('editButton');
        const saveButton = document.getElementById('saveButton');
        const inputs = document.querySelectorAll('#educationTable input, #educationTable select, #educationTable textarea');
        const addButton = document.querySelector('#educationTable tfoot button');
        const removeButtons = document.querySelectorAll('#educationTable tbody .btn-danger');
        const actionColumn = document.querySelectorAll('#educationTable .Action'); // Select Action column

        
        function toggleInputs(disabled) {
            inputs.forEach(input => {
                if (disabled) {
                    input.setAttribute('readonly', 'readonly');
                    input.setAttribute('disabled', 'disabled');
                } else {
                    input.removeAttribute('readonly');
                    input.removeAttribute('disabled');
                }
            });
            
            if (disabled) {
                addButton.setAttribute('disabled', 'disabled');
                removeButtons.forEach(button => button.setAttribute('disabled', 'disabled'));
            } else {
                addButton.removeAttribute('disabled');
                removeButtons.forEach(button => button.removeAttribute('disabled'));
            }
        }
        function toggleActionColumn(visible) {
            actionColumn.forEach(col => {
                col.style.display = visible ? '' : 'none'; // Show or hide the column
            });
        }
        editButton.addEventListener('click', function() {
            if (editButton.textContent.trim() === 'Edit') {
                editButton.textContent = 'Cancel';
                saveButton.style.display = 'inline-block';
                toggleInputs(false);
                toggleActionColumn(true); // Show Action column
            } else {
                editButton.textContent = 'Edit';
                saveButton.style.display = 'none';
                toggleInputs(true);
                toggleActionColumn(false); // Hide Action column

            }
        });
    
        toggleInputs(true);
        toggleActionColumn(false); // Hide Action column on page load

    });
    

    
</script>



<script>
    $(document).ready(function () {
        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get('Success');
        
        if (success === 'True') {
            showSuccess();
            removeSuccessParam();
        }
        if (success === 'Deleted') {
            showDelete();
            removeSuccessParam();
        }
        if (success === 'Uploaded') {
            showUploaded();
            removeSuccessParam();
        }

        function removeSuccessParam() {
            urlParams.delete('Success'); 
            const newUrl = window.location.pathname + '?' + urlParams.toString();
            window.history.replaceState(null, '', newUrl);
        }
    });
</script>
<script>
    var showEduDetails= function(obj)
    {
            var hurl = $(obj).attr('data-href');
            $(".modalPr").modal('show')
            $(".modalPr iframe").attr('src',hurl);

    }
   

</script>

<script>
    // Function to populate the year dropdown
    function populateYearDropdown(dropdownId, selectedYear) {
        const startYear = 1980; // Starting year
        const endYear = new Date().getFullYear(); // Current year

        const dropdown = document.getElementById(dropdownId);

        if (!dropdown) return; // Exit if dropdown not found

        // Clear existing options
        dropdown.innerHTML = '';

        // Add a default placeholder option
        const placeholderOption = document.createElement('option');
        placeholderOption.textContent = 'Select Year';
        placeholderOption.value = '';
        placeholderOption.disabled = true;
        placeholderOption.selected = !selectedYear; // Select if no year provided
        dropdown.appendChild(placeholderOption);

        // Populate the dropdown with years
        for (let year = startYear; year <= endYear; year++) {
            const option = document.createElement('option');
            option.textContent = year;
            option.value = year;
            if (year == selectedYear) {
                option.selected = true; // Select if it matches the existing year
            }
            dropdown.appendChild(option);
        }
    }

    // Function to add a new education row
    function addEducationRow() {
        var table = document.getElementById('educationTable').getElementsByTagName('tbody')[0];
        var newRow = table.insertRow();
        var newId = 'new_' + (table.rows.length + 1);  

        newRow.id = 'Edurow' + newId;
        newRow.innerHTML = `
            <td>
                <select class="form-control" name="EducationType[]" required>
                    <option value="Secondary">Secondary</option>
                    <option value="Higher Secondary">Higher Secondary</option>
                    <option value="Graduation">Graduation</option>
                    <option value="Post Graduation">Post Graduation</option>
                    <option value="Diploma">Diploma</option>
                    <option value="Certificate">Certificate</option>
                    <option value="Other">Other</option>
                </select>
            </td>
            <td><input type="text" class="form-control" name="DegreeCourse[]" required></td>
            <td><input type="text" class="form-control" name="InstitutionName[]" required></td>
            <td>
                <select id="yearDropdown${newId}" class="form-control" name="Year[]" required>
                    <!-- Options will be populated dynamically -->
                </select>
            </td>
            
            <td><input type="file" class="form-control" name="AttachmentEducation[]" required></td>
            <td>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeEducationRow('${newId}')">REMOVE</button>
                <input type="hidden" name="Edu_ids[]" value="${newId}">
            </td>
        `;

        // Populate the year dropdown for the newly added row
        populateYearDropdown(`yearDropdown${newId}`);
    }

    // Function to remove an education row
    function removeEducationRow(EduId) {
        var row = document.getElementById('Edurow' + EduId);

        if (row) {
            row.parentNode.removeChild(row);
            addRemovedEduId(EduId);
        }
    }

    // Function to add removed education IDs to hidden input
    function addRemovedEduId(EduId) {
        var removedEduIdsInput = document.getElementById('removedEduIds');
        var removedEduIds = removedEduIdsInput.value.split(',').filter(id => id);

        if (!removedEduIds.includes(EduId)) {
            removedEduIds.push(EduId);
            removedEduIdsInput.value = removedEduIds.join(',');
        }
    }

    // Populate year dropdowns for existing records on page load
    document.addEventListener('DOMContentLoaded', function () {
        {% for Edu in Educations %}
            populateYearDropdown('yearDropdown{{ Edu.id }}', '{{ Edu.Year }}');
        {% endfor %}
    });
</script>


{% endblock content %}





