{% extends "HR/EmployeeDashboard/EditEmployee.html" %}
 {% load static %} 
{% load encryption_filters %}

{% block content %}
<link href="{% static 'css/plugins/sweetalert/sweetalert.css' %}" rel="stylesheet">

<style>
    
    #ProfileImagePreview {
        border-radius: 50%;
        border: 2px solid #ddd;     
        margin-top: 10px;
        max-width: 150px; 
        height: 150px;    
        object-fit: cover; 
    }

    .Name
    {
        width: 200px;
    }

    .Date
    {
        width: 140px;
    }

    .Designation
    {
        width: 150px;
    }

    .Department
    {
        width: 150px;
    }
    .EmpCode
    {
        width: 80px;
    }
    .Signed
    {
        width: 250px;
    }
    .Action 
    {
        width : 200px
    }

    .card {
        border-radius: 5px;
        border: 1px solid #0000004f;
    }

    .card-header{
        margin-bottom: -20px !important;
    }

    .card .card-body {
        padding: 18px !important;
    }
</style>


<div class="card">
    <div class="card-header">
    <span class="text-uppercase fw-bold">Kra Report </span> 
            
        </div>
        <div class="card-body">

            <form method="get" id="filterForm">
                <div class="row">
                    <!-- Year Dropdown -->
                    <div class="col-md-2">
                        <div class="form-group">
                            <select class="form-control" id="year" name="year" onchange="submitForm()">
                                {% for year in years %}
                                    <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                                {% endfor %}
                            </select>
                            <input type="hidden" name="OID" value="{{OrganizationID}}">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group" style="display: none;">
                            <input type="hidden"  name="EmpID" value="{{EmpID|encrypt_id_filter}}" id="">
                            <button type="submit" class="btn btn-primary" id="filterButton">Filter</button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" id="Exporttoexecel">Export</button>
                        </div>
                    </div>
                </div>
            </form>
    
            {% if rowslist %}
            <table class="table table-bordered" style="font-size: 10px;" id="reportTable">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Standard</th>
                        <th>Jan</th>
                        <th>Feb</th>
                        <th>Mar</th>
                        <th>Apr</th>
                        <th>May</th>
                        <th>Jun</th>
                        <th>Jul</th>
                        <th>Aug</th>
                        <th>Sep</th>
                        <th>Oct</th>
                        <th>Nov</th>
                        <th>Dec</th>
                        <th>Overall Rating</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in rowslist %}
                    <tr>
                        <td>{{ row.Title }}</td>
                        <td>{{ row.Standard }}</td>
                        <td>{{ row.Jan }}</td>
                        <td>{{ row.Feb }}</td>
                        <td>{{ row.Mar }}</td>
                        <td>{{ row.Apr }}</td>
                        <td>{{ row.May }}</td>
                        <td>{{ row.Jun }}</td>
                        <td>{{ row.Jul }}</td>
                        <td>{{ row.Aug }}</td>
                        <td>{{ row.Sep }}</td>
                        <td>{{ row.Oct }}</td>
                        <td>{{ row.Nov }}</td>
                        <td>{{ row.Dec }}</td>
                        <td>{{ row.OverallRating }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
    </div>
    
   

    <script>
        function submitForm(org) {
            if (org == 'org') {
                $("select[name='employee']").val('');
            }
            document.getElementById("filterForm").submit();
        }
    
        $(document).ready(function () {
            var selectedOrganization = "{{ I }}";
            $("select[name='I']").val(selectedOrganization);
            var selectedyear = "{{ selected_year }}";
            $("select[name='year']").val(selectedyear);
            var selectedemployee = "{{ selected_employee }}";
            $("select[name='employee']").val(selectedemployee);
        });
    
        document.getElementById("Exporttoexecel").addEventListener("click", function () {
        var table = document.getElementById("reportTable");
    
        var selectedOrgText = $("select[name='I'] option:selected").text();  
        var selectedEmpText = $("select[name='employee'] option:selected").text();  
    
        var headers = [
            ["Organization Name", selectedOrgText],  
            ["Employee Name", selectedEmpText],  
            [],  
            ["Title", "Standard", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "Overall Rating"]  
        ];
    
        var headerStyle = {
            fill: { 
                fgColor: { rgb: "FFFF00" } 
            },
            font: { bold: true }
        };
    
        var tableData = [];
        var rows = table.querySelectorAll("tr");  
        for (var i = 1; i < rows.length; i++) {   
            var rowData = [];
            var cells = rows[i].querySelectorAll("td");  
            cells.forEach(function(cell) {
                rowData.push(cell.innerText.trim());  
            });
            tableData.push(rowData);  
        }
    
        var fullData = headers.concat(tableData);  
    
        var wb = XLSX.utils.book_new();
        var ws = XLSX.utils.aoa_to_sheet(fullData); 
    
      
        for (var col = 0; col < headers[3].length; col++) {
            var cell = ws[XLSX.utils.encode_cell({r: 3, c: col})];  
            if (!cell) {
                cell = ws[XLSX.utils.encode_cell({r: 3, c: col})] = {};  
            }
            cell.s = headerStyle; 
        }
    
        XLSX.utils.book_append_sheet(wb, ws, "KRA Report");
    
        var fileName = `KRA_Yearly_Report_${selectedEmpText}_${selectedOrgText}.xlsx`;
    
        XLSX.writeFile(wb, fileName);
    });
    
    </script>
    <script>
        $(document).ready(function () {
            const urlParams = new URLSearchParams(window.location.search);
            const success = urlParams.get('Success');
            
            if (success === 'True') {
                showSuccess();
                removeSuccessParam();
            }
            if (success === 'Deleted') {
                showDelete();
                removeSuccessParam();
            }
            if (success === 'Uploaded') {
                showUploaded();
                removeSuccessParam();
            }
    
            function removeSuccessParam() {
                urlParams.delete('Success'); 
                const newUrl = window.location.pathname + '?' + urlParams.toString();
                window.history.replaceState(null, '', newUrl);
            }
        });
    </script>


{% endblock content %}





