{% extends "HR/EmployeeDashboard/EditEmployee.html" %}
 {% load static %} 
{% block content %}
<link href="{% static 'css/plugins/sweetalert/sweetalert.css' %}" rel="stylesheet">

<style>
    
    #ProfileImagePreview {
        border-radius: 50%;
        border: 2px solid #ddd;     
        margin-top: 10px;
        max-width: 150px; 
        height: 150px;    
        object-fit: cover; 
    }
    .strike{
        color: red;
    }

    label{
        padding-top: 14px;
    }
    .card {
        border-radius: 5px;
        border: 1px solid #0000004f;
    }
    
    .card-header{
        margin-bottom: -20px !important;
    }
</style>

<div class="modal fade modalPr" id="fileModal" tabindex="-1" role="dialog" aria-labelledby="fileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fileModalLabel">File Preview</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <iframe id="filePreview" style="width: 100%; height: 500px; border: none;" onerror="this.style.display='none'; document.getElementById('filePreviewFallback').style.display='block';"></iframe>
                <div id="filePreviewFallback" style="display:none;">
                    <p>Your browser does not support inline previews. <a id="downloadLink" href="#" download>Click here to download the file.</a></p>
                </div>
            </div>
            <div class="modal-footer">
                <a id="downloadLink" class="btn btn-primary" href="#" download>Download</a>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>



<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span class="text-uppercase fw-bold">Family Information</span>
        <button id="editButton" class="btn btn-primary btn-sm float-right">Edit</button>
    </div>

    <form id="FamilyForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="main">
                <div class="row m-1">
                    <div class="col-md-12">
                        {% if SpouseChild == True %} 
                        <div class="row m-1">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="SpouseName">Spouse Name <span class="strike">*</span></label>
                                    <input id="SpouseName" name="SpouseName" type="text" class="form-control"   value="{{Finfoobj.SpouseName}}" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="SpouseDOB">DOB </label>
                                    <div class="input-group">
                                        <input id="SpouseDOB" name="SpouseDOB" type="date" value="{% if Finfoobj.SpouseDateofBirth %}{{ Finfoobj.SpouseDateofBirth|date:'Y-m-d' }}{% endif %}" class="form-control">
                                        &nbsp; &nbsp; &nbsp;
                                        <div class="input-group-append ml-2">
                                            <button type="button" class="btn btn-primary" id="clearbtn" onclick="clearDate('SpouseDOB', 'SpouseAge')">Clear</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="SpouseAge">Age </label>
                                    <input id="SpouseAge" name="SpouseAge" type="number" class="form-control"   value="{{Finfoobj.SpouseAge}}" >
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="SpouseContact">Contact No.</label>
                                    <input id="SpouseContact" name="SpouseContact" type="tel" class="form-control"  value="{{Finfoobj.SpouseContactNo}}"  >
                                   <span id="SpouseContactmobileError" style="color:red;"></span>
                                    
                                </div>
                            </div>
                            
                        </div>
                        {% endif %}
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="MotherName">Mother's Name <span class="strike">*</span></label>
                                        <input id="MotherName" name="MotherName" type="text" class="form-control"   value="{{Finfoobj.MotherName}}" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="MotherDOB">DOB </label>
                                    <div class="input-group">
                                    <input id="MotherDOB" name="MotherDOB" type="date" value="{% if Finfoobj.MotherDateofBirth %}{{ Finfoobj.MotherDateofBirth|date:'Y-m-d' }}{% endif %}"   class="form-control" >
                                    &nbsp; &nbsp; &nbsp;
                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-primary" id="clearbtn" onclick="clearDate('MotherDOB', 'MotherAge')">Clear</button>
                                    </div>
                                </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="MotherAge"> Age </label>
                                    <input id="MotherAge" name="MotherAge" type="number" class="form-control"   value="{{Finfoobj.MotherAge}}" >
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="MotherContact">Contact No.</label>
                                    <input id="MotherContact" name="MotherContact" type="tel" class="form-control"  value="{{Finfoobj.MotherContactNo}}" >
                                    <span id="MotherContactmobileError" style="color:red;"></span>
                                </div>
                            </div>

                        
                            
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="FatherName">Father's Name <span class="strike">*</span></label>
                                    <input id="FatherName" name="FatherName" type="text" class="form-control"   value="{{Finfoobj.FatherName}}" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="FatherDOB">DOB</label>
                                    <div class="input-group">
                                        <input id="FatherDOB" name="FatherDOB" type="date" value="{% if  Finfoobj %}{{Finfoobj.FatherDateofBirth|date:'Y-m-d'}}{% else %}{% now 'Y-m-d' %}{% endif %}"  class="form-control" >
                                        &nbsp; &nbsp; &nbsp;
                                        <div class="input-group-append">
                                            <button type="button" class="btn btn-primary" id="clearbtn" onclick="clearDate('FatherDOB', 'FatherAge')">Clear</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="FatherAge"> Age </label>
                                    <input id="FatherAge" name="FatherAge" type="number" class="form-control"   value="{{Finfoobj.FatherAge}}" >
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="FatherContact">Contact No.</label>
                                    <input id="FatherContact" name="FatherContact" type="tel" class="form-control"   value="{{Finfoobj.FatherContactNo}}" >
                                    <span id="FatherContactmobileError" style="color:red;"></span>

                                </div>
                            </div>
                        </div>
                    </div> 
                    {% if SpouseChild == True %} 
                    <div class="col-md-7 col-sm-5 mt-4 m-3" >
                        <h5>Children</h2>
                            <table id="childrenTable" class="table table-bordered" >
                                <thead>
                                    <tr>
                                        <th style="width: 257px;">Name</th>
                                        <th style="width: 100px;">Age</th>
                                        <th style="width: 127px;">Relation</th>
                                        <th style="width: 89px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for child in childs %}
                                    <tr id="row{{ child.id }}">
                                        <td><input type="text" class="form-control" name="childName[]" value="{{ child.Name }}"></td>
                                        <td><input type="number" class="form-control" name="childAge[]" value="{{ child.Age }}"></td>
                                        <td>
                                            <select class="form-control" name="childrelations[]">
                                                <option value="" {% if not child.Relation %}selected{% endif %}>Select</option>
                                                <option value="Son" {% if child.Relation == "Son" %}selected{% endif %}>Son</option>
                                                <option value="Daughter" {% if child.Relation == "Daughter" %}selected{% endif %}>Daughter</option>
                                            </select>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-danger btn-sm" onclick="removeRow('{{ child.id }}')">REMOVE</button>
                                            <input type="hidden" name="child_ids[]" value="{{ child.id }}">
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="4" class="text-right">
                                            <button type="button" class="btn btn-primary btn-sm" onclick="addRow()">ADD</button>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                            
                            <input type="hidden" id="removedChildIds" name="removed_child_ids[]">
                            
                    </div>
                    {% endif %}

                </div>
           
        </div>
        <div class="CustomFooter m-3">
            <button type="submit" id="saveButton" class="btn btn-primary Successpopup" style="display: none;">Save</button>
        </div>
    </form>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const editButton = document.getElementById('editButton');
        const saveButton = document.getElementById('saveButton');
        const buttons = document.querySelectorAll('#FamilyForm button'); // Select all buttons in the form
        const inputs = document.querySelectorAll('#FamilyForm input, #FamilyForm select, #FamilyForm textarea');

        const addButton = document.querySelector('#childrenTable tfoot button');
        const removeButtons = document.querySelectorAll('#childrenTable tbody .btn-danger');
       
        function toggleInputs(disabled) {
            inputs.forEach(input => {
                if (disabled) {
                    input.setAttribute('readonly', 'readonly');
                    input.setAttribute('disabled', 'disabled');
                } else {
                    input.removeAttribute('readonly');
                    input.removeAttribute('disabled');
                }
            });
            
            buttons.forEach(button => {
                if (disabled) {
                    button.setAttribute('disabled', 'disabled'); // Disable all buttons
                } else {
                    button.removeAttribute('disabled'); // Enable all buttons
                }
            });

            // Maintain specific conditions for add and remove buttons
            if (disabled) {
                addButton.setAttribute('disabled', 'disabled');
                removeButtons.forEach(button => button.setAttribute('disabled', 'disabled'));
            } else {
                addButton.removeAttribute('disabled');
                removeButtons.forEach(button => button.removeAttribute('disabled'));
            }
        }
    
        editButton.addEventListener('click', function() {
            if (editButton.textContent.trim() === 'Edit') {
                editButton.textContent = 'Cancel';
                saveButton.style.display = 'inline-block';
                toggleInputs(false);
            } else {
                editButton.textContent = 'Edit';
                saveButton.style.display = 'none';
                toggleInputs(true);
            }
        });
    
        toggleInputs(true); // Initialize the form in a read-only state
    });
</script>




<script>
    $(document).ready(function () {
        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get('Success');
        
        if (success === 'True') {
            showSuccess();
            removeSuccessParam();
        }
        if (success === 'Deleted') {
            showDelete();
            removeSuccessParam();
        }
        if (success === 'Uploaded') {
            showUploaded();
            removeSuccessParam();
        }

        function removeSuccessParam() {
            urlParams.delete('Success'); 
            const newUrl = window.location.pathname + '?' + urlParams.toString();
            window.history.replaceState(null, '', newUrl);
        }
    });
</script>

<script>
    var showEduDetails= function(obj)
    {
            var hurl = $(obj).attr('data-href');
            $(".modalPr").modal('show')
            $(".modalPr iframe").attr('src',hurl);

    }
   

</script>

<script>
    $(document).ready(function() {
        function calculateAge(dobSelector, ageSelector) {
            var dob = new Date($(dobSelector).val());
            var today = new Date(); 
            var age = today.getFullYear() - dob.getFullYear();
            var monthDifference = today.getMonth() - dob.getMonth();
            if (monthDifference < 0 || (monthDifference === 0 && today.getDate() < dob.getDate())) {
                age--;
            }
            $(ageSelector).val(age);
        }

        $('#SpouseDOB').on('change', function() {
            calculateAge(this, '#SpouseAge');
        });

        $('#FatherDOB').on('change', function() {
            calculateAge(this, '#FatherAge');
        });

        $('#MotherDOB').on('change', function() {
            calculateAge(this, '#MotherAge');
        });

        calculateAge('#SpouseDOB', '#SpouseAge');
        calculateAge('#FatherDOB', '#FatherAge');
        calculateAge('#MotherDOB', '#MotherAge');
        
        // Clear the date and age on button click
        $('#clearBtn').on('click', function() {
            if (!Finfoobj.SpouseDateofBirth) {
                clearDate('SpouseDOB', 'SpouseAge'); 
            }
            if (!Finfoobj.MotherDateofBirth) {
                clearDate('MotherDOB', 'MotherAge'); 
            }
            if (!Finfoobj.FatherDateofBirth) {
                clearDate('FatherDOB', 'FatherAge'); 
            }
        });
    });

    function clearDate(dobId, ageId) {
        document.getElementById(dobId).value = '';  
        document.getElementById(ageId).value = '';  
    }
    
    var Finfoobj = {
        SpouseDateofBirth: null,  
        MotherDateofBirth: null,
        FatherDateofBirth: null
    };
</script>


<script>
    let newChildCount = 0;
 
 function addRow() {
     const table = document.getElementById('childrenTable').getElementsByTagName('tbody')[0];
     const newRow = table.insertRow();
     newChildCount++;
     const newId = 'new_' + newChildCount;
 
     newRow.id = newId; // Set the ID for the new row
 
     newRow.innerHTML = `
         <td><input type="text" class="form-control" name="childName[]" required></td>
         <td><input type="number" class="form-control" name="childAge[]" required></td>
         <td>
             <select class="form-control" name="childrelations[]" required>
                 <option value="">Select</option>
                 <option value="Son">Son</option>
                 <option value="Daughter">Daughter</option>
             </select>
         </td>
         <td>
             <button type="button" class="btn btn-danger btn-sm" onclick="removeRow('${newId}')">REMOVE</button>
             <input type="hidden" name="child_ids[]" value="${newId}">
         </td>
     `;
 }
 function removeRow(childId) {
     const row = document.getElementById(childId);
     if (row) {
         row.parentNode.removeChild(row);
         addRemovedChildId(childId);
     } else {
         const newChildPrefix = 'new_';
         if (childId.startsWith(newChildPrefix)) {
             console.error('New row with ID ' + childId + ' not found.');
         } else {
             const existingRow = document.getElementById('row' + childId);
             if (existingRow) {
                 existingRow.parentNode.removeChild(existingRow);
                 addRemovedChildId(childId);
             } else {
                 console.error('Row with ID ' + childId + ' not found.');
             }
         }
     }
 }
 
 
 function addRemovedChildId(childId) {
     const removedChildIdsInput = document.getElementById('removedChildIds');
     const removedChildIds = removedChildIdsInput.value.split(',').filter(id => id);
 
     if (!removedChildIds.includes(childId)) {
         removedChildIds.push(childId);
         removedChildIdsInput.value = removedChildIds.join(',');
     }
 }
 
 </script>




<script>
    {% if SpouseChild == True %} 
    document.getElementById('SpouseContact').addEventListener('input', function () {
        const mobile = this.value;
        
        const regex = /^[6-9]\d{9}$/;
        const mobileError = document.getElementById('SpouseContactmobileError');

        if (!regex.test(mobile)) {
            mobileError.textContent = "Invalid mobile number";
        } else {
            mobileError.textContent = "";
        }
    });
 {% endif %}


    document.getElementById('MotherContact').addEventListener('input', function () {
        const mobile = this.value;
        // For Indian mobile numbers (10 digits starting with 7, 8, or 9)
        const regex = /^[6-9]\d{9}$/;
        const mobileError = document.getElementById('MotherContactmobileError');

        if (!regex.test(mobile)) {
            mobileError.textContent = "Invalid mobile number";
        } else {
            mobileError.textContent = "";
        }
    });


    document.getElementById('FatherContact').addEventListener('input', function () {
        const mobile = this.value;
        // For Indian mobile numbers (10 digits starting with 7, 8, or 9)
        const regex = /^[6-9]\d{9}$/;
        const mobileError = document.getElementById('FatherContactmobileError');

        if (!regex.test(mobile)) {
            mobileError.textContent = "Invalid mobile number";
        } else {
            mobileError.textContent = "";
        }
    });



</script>
{% endblock content %}





