{% extends "manningguide/homebase.html" %}
{% load maningfilter %}
{% block content %}
{% load static %}

<style>
    @import url('https://fonts.googleapis.com/css2?family=Arial+Nova:wght@400;700&display=swap');

    body {
        font-family: "Arial Nova", sans-serif; 
        overflow:hidden;
        margin: 0;
        padding: 0;
    }

    .settings-icon {
        display: none !important;
    }

    #TableReportContainer {
        max-height: 80vh; 
        overflow-y: auto;
        position: relative;
        font-size: 13px !important;
    }

    #TableReport {
        width: 100%;
        border-spacing: 0px !important;
        border-collapse: separate;
    }

    #TableReport thead{
        position: sticky;
        top: 0px;
        background-color: #f8f9fa; /* Matches Bootstrap card background */
        z-index: 2;
        font-size: 13px !important;
        font-weight: bold;
    }

    #TableReport tbody td {
        font-size: 13px !important;
    }

    .custom-checkbox {
        width: 8px; /* Adjust width */
        height: 15px; /* Adjust height */
        transform: scale(2.1); /* Adjust scale factor */
        margin-right:10px;
        
    }
    .stickySetting{
        border-top: 1px solid #E9E9EA !important;
    }

    .select2-container, .dropdown-menu {
        z-index: 1000 !important; /* Less than navbar */
    }

</style>

<style>
    /* Light theme-based colors */
    .avg-salary-group {
        background-color: #f1f4f9 ; /* light blue-gray */
    }

    .head-count-group {
        background-color: #f9f7f1 !important; /* light beige */
    }

    .total-ctc-group {
        background-color: #f2f6f3 !important; /* light green-gray */
    }

    /* Optional: subtle border or font styling for better visibility */
    .avg-salary-group, .head-count-group, .total-ctc-group {
        border-right: 1px solid #ddd !important;
    }
    
    .TotalFooter{
        text-align: right !important;
    }

    .Total{
        font-size: 20px;
    }
</style>



<style>
    .card{
    border-radius:10px;
    }

    .btn{
    padding:4px !important;
    border-radius:4px !important;
    }
    .headr-color{
    background-color: #edf0fb !important;
    }

    #TableReport tr td:not(:first-child){
    text-align : center !important;
    }
    .table th {
    padding: 5px 5px !important;
    }
    .table{
    border-radius:5px !important;
    }
    #hotelForm{
    display: flex;
    margin-bottom: -6px !important;
    justify-content:center;
    align-items:center;
    gap: 10px;
    }
    .card .card-body {
    padding: 8px !important;
    }
    .page-wrapper .content {
    padding: 0px !important;
    }
</style>


<div class="card" id="profile-card">
    
    <div id="card-loader" class="card-loader" 
        style="display:none; flex-direction: column; justify-content: center; align-items: center; 
            position: fixed; top:0; left:0; width:100vw; height:100vh; 
            background: rgba(34,34,34,0.4); z-index:9999;">
        <div class="spinner-border text-primary-spinner" role="status" style="width:3rem; height:3rem;"></div>
        <div style="margin-top:1rem; font-weight:bold; font-size:1.2rem; color:#3a4a93;">
            Loading...
        </div>
    </div>
    <div class="card-body">
        <div class="CustomFooter">
            <form method="GET" class="" id="hotelForm">
                <div class="">
                    <select name="hotel_name" class="form-control">
                        {% for itm in memOrg %}
                            <option value="{{ itm.OrganizationID }}" {% if itm.OrganizationID == selectedOrganizationID %}selected{% endif %}>
                                {{ itm.Organization_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="" >     
                    <label class="input-group-text mb-0 ml-2" for="exclude_zero_headcount" style="padding: 9px; font-size:13px">
                        <input type="checkbox" class="custom-checkbox" name="exclude_zero_headcount" value="1" id="exclude_zero_headcount"
                            {% if request.GET.exclude_zero_headcount %}checked{% endif %}>
                        Excluding 0 Head Count
                    </label>                   
                </div>

                <div class="">
                    <a href="{% url 'Variance_Ceo_Report' %}" class="btn btn-danger" target="_blank">
                        Clear
                    </a>
                    <button onclick="exportToExcel()" class="btn btn-primary" type="button">
                        Excel
                    </button>
                    <a href="{% url 'Variance_Ceo_Report_PDF' %}?hotel_name={{selectedOrganizationID}}&exclude_zero={{exclude_zero_headcount}}" class="btn btn-danger" target="_blank">
                        PDF
                    </a>
                </div>
            </form>
        </div>

        
        <div class="" id="TableReportContainer"></div> 
    </div> 
</div> 




<script>
  $(document).ready(function () {
    // Select2 auto-submit
    $('select[name="hotel_name"]').on('change', function (e) {
      $('#hotelForm').submit();
    });

    // Checkbox auto-submit
    $('#exclude_zero_headcount').on('change', function () {
      $('#hotelForm').submit();
    });
  });
</script>

<script>
    function showLoader(cardId) {
        document.querySelector(`#${cardId} .card-loader`).style.display = "flex";
    }

    function hideLoader(cardId) {
        document.querySelector(`#${cardId} .card-loader`).style.display = "none";
    }
</script>


<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>


<script>
    function exportToExcel() {
        const table = document.getElementById("TableReport");

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.table_to_sheet(table, { raw: false });  // Set raw: false to allow type inference

        // Convert numeric strings to actual numbers
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let R = range.s.r + 1; R <= range.e.r; ++R) {  // skip header row
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const cell_address = XLSX.utils.encode_cell({ r: R, c: C });
                const cell = ws[cell_address];
                if (cell && typeof cell.v === 'string') {
                    // Remove commas, trim, and check if it's a number
                    const cleaned = cell.v.replace(/,/g, '').trim();
                    if (!isNaN(cleaned) && cleaned !== '') {
                        cell.v = parseFloat(cleaned);
                        cell.t = 'n';  // mark cell as number
                    }
                }
            }
        }

        // Optional: Adjust column widths
        const colWidths = [];
        for (let C = range.s.c; C <= range.e.c; ++C) {
            let maxWidth = 10;
            for (let R = range.s.r; R <= range.e.r; ++R) {
                const cell_ref = XLSX.utils.encode_cell({ r: R, c: C });
                const cell = ws[cell_ref];
                if (cell && cell.v) {
                    const len = cell.v.toString().length;
                    if (len > maxWidth) maxWidth = len;
                }
            }
            colWidths.push({ wch: maxWidth + 2 });
        }
        ws['!cols'] = colWidths;

        XLSX.utils.book_append_sheet(wb, ws, "Variance_CEO_Report List");
        XLSX.writeFile(wb, "Variance_CEO_Report.xlsx");
    }
</script>


<script>
  let OID_demo = "{{selectedOrganizationID}}";
  let Ex_zero_demo = "{{exclude_zero_headcount}}";
  showLoader("profile-card");

  fetch(`/Manning_Guide/api/variance_details_report/?OrganizationID=${OID_demo}&Ex_zero=${Ex_zero_demo}`)
    .then(res => res.json())
    .then(res => {
      hideLoader("profile-card");

      const data = res.data;
      const container = document.getElementById("TableReportContainer");
      container.innerHTML = "";

      const deptMap = {};

      /* =========================
         AGGREGATE BY DEPARTMENT
      ========================== */
      data.forEach(row => {

        const dept = row.Department || "Unknown";

        const Bud_AvgSal = parseFloat((row.Bud_AvgSal || 0).toString().replace(/,/g, ""));
        const Act_AvgSal = parseFloat((row.Act_AvgSal || 0).toString().replace(/,/g, ""));
        const Bud_HC = parseInt(row.Bud_HC || 0);
        const Act_HC = parseInt(row.Act_HC || 0);
        const Bud_TotalCTC = parseFloat((row.Bud_TotalCTC || 0).toString().replace(/,/g, ""));
        const Act_TotalCTC = parseFloat((row.Act_TotalCTC || 0).toString().replace(/,/g, ""));

        if (!deptMap[dept]) {
          deptMap[dept] = {
            budSal: 0,
            actSal: 0,
            budHC: 0,
            actHC: 0,
            budCTC: 0,
            actCTC: 0
          };
        }

        if (Bud_AvgSal > 0) deptMap[dept].budSal += Bud_AvgSal;
        if (Act_AvgSal > 0) deptMap[dept].actSal += Act_AvgSal;

        deptMap[dept].budHC += Bud_HC;
        deptMap[dept].actHC += Act_HC;
        deptMap[dept].budCTC += Bud_TotalCTC;
        deptMap[dept].actCTC += Act_TotalCTC;
      });

      /* =========================
         TABLE STRUCTURE
      ========================== */
      container.innerHTML = `
        <table class="table table-bordered table-sm" id="TableReport">
          <thead class="table-light">
            <tr>
              <th class="stickySetting text-center align-middle" rowspan="2">DEPARTMENTS</th>
              <th class="stickySetting text-center" colspan="3" class="TextCenter">AVERAGE SALARY</th>
              <th class="stickySetting text-center" colspan="3" class="TextCenter">HEAD COUNT</th>
              <th class="stickySetting text-center" colspan="3" class="TextCenter">TOTAL CTC</th>
            </tr>
            <tr>
              <th class="stickySetting text-center avg-salary-group headr-color">BUDGETED</th>
              <th class="stickySetting text-center avg-salary-group headr-color">ACTUAL</th>
              <th class="stickySetting text-center avg-salary-group headr-color">VARIANCE</th>
              <th class="stickySetting text-center head-count-group headr-color">BUDGETED</th>
              <th class="stickySetting text-center head-count-group headr-color">ACTUAL</th>
              <th class="stickySetting text-center head-count-group headr-color">VARIANCE</th>
              <th class="stickySetting text-center total-ctc-group headr-color">BUDGETED</th>
              <th class="stickySetting text-center total-ctc-group headr-color">ACTUAL</th>
              <th class="stickySetting text-center total-ctc-group headr-color">VARIANCE</th>
            </tr>
          </thead>
          <tbody id="deptBody_Data"></tbody>
        </table>
      `;

      const tbody = document.getElementById("deptBody_Data");

      /* =========================
         COLOR HELPER
      ========================== */
      function getColor(val) {
        return Number(val) < 0 ? "red" : "green";
      }

      /* =========================
        GRAND TOTAL VARIABLES
      ========================= */
      let totalBudSal = 0;
      let totalActSal = 0;
      let totalBudHC = 0;
      let totalActHC = 0;
      let totalBudCTC = 0;
      let totalActCTC = 0;

      let budAvg_Total = 0;
      let actAvg_Total = 0;

      /* =========================
         RENDER DEPARTMENTS
      ========================== */
      Object.entries(deptMap).forEach(([dept, d]) => {
        console.log("i am here")
        
        totalBudSal += d.budSal;
        totalActSal += d.actSal;
        totalBudHC += d.budHC;
        totalActHC += d.actHC;
        totalBudCTC += d.budCTC;
        totalActCTC += d.actCTC;
        
        // console.log("totalBudSal::", totalBudSal)
        // console.log("totalActSal::", totalActSal)
        // const budAvg = d.budHC ? (d.budSal / d.budHC).toFixed(2) : 0;
        // const actAvg = d.actHC ? (d.actSal / d.actHC).toFixed(2) : 0;
        // const budAvg = d.budHC ? (d.budSal / d.budHC).toFixed(2) : 0;
        // const actAvg = d.actHC ? (d.actSal / d.actHC).toFixed(2) : 0;

        const budAvg = d.budHC ? (d.budSal / d.budHC) : 0;
        const actAvg = d.actHC ? (d.actSal / d.actHC) : 0;

        budAvg_Total += budAvg;
        actAvg_Total += actAvg;

        tbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${dept}</td>
            <td class="TextEnd">${Number(budAvg).toFixed(2).toLocaleString()}</td>
            <td class="TextEnd">${Number(actAvg).toFixed(2).toLocaleString()}</td>
            <td class="TextEnd" style="color:${getColor(budAvg - actAvg)}">
              ${Number(budAvg - actAvg).toFixed(2).toLocaleString()}
            </td>

            <td class="TextEnd">${d.budHC}</td>
            <td class="TextEnd">${d.actHC}</td>
            <td class="TextEnd" style="color:${getColor(d.budHC - d.actHC)}">
              ${d.budHC - d.actHC}
            </td>

            <td class="TextEnd">${Number(d.budCTC).toLocaleString()}</td>
            <td class="TextEnd">${Number(d.actCTC).toLocaleString()}</td>
            <td class="TextEnd" style="color:${getColor(d.budCTC - d.actCTC)}">
              ${Number(d.budCTC - d.actCTC).toLocaleString()}
            </td>
          </tr>
        `);
      });

      /* =========================
        GRAND TOTAL CALCULATION
      ========================= */
      const totalBudAvg = budAvg_Total ? (budAvg_Total / totalBudHC).toFixed(2) : 0;
      const totalActAvg = actAvg_Total ? (actAvg_Total / totalActHC).toFixed(2) : 0;

      /* =========================
        GRAND TOTAL ROW
      ========================= */
      tbody.insertAdjacentHTML("beforeend", `
        <tr class="table-secondary fw-bold">
          <td>GRAND TOTAL</td>

          <td class="TextEnd">${Number(totalBudAvg).toLocaleString()}</td>
          <td class="TextEnd">${Number(totalActAvg).toLocaleString()}</td>
          <td class="TextEnd" style="color:${getColor(totalBudAvg - totalActAvg)}">
            ${Number(totalBudAvg - totalActAvg).toLocaleString()}
          </td>

          <td class="TextEnd">${totalBudHC}</td>
          <td class="TextEnd">${totalActHC}</td>
          <td class="TextEnd" style="color:${getColor(totalBudHC - totalActHC)}">
            ${totalBudHC - totalActHC}
          </td>

          <td class="TextEnd">${Number(totalBudCTC).toLocaleString()}</td>
          <td class="TextEnd">${Number(totalActCTC).toLocaleString()}</td>
          <td class="TextEnd" style="color:${getColor(totalBudCTC - totalActCTC)}">
            ${Number(totalBudCTC - totalActCTC).toLocaleString()}
          </td>
        </tr>
      `);
    });
</script>





{% endblock content %}