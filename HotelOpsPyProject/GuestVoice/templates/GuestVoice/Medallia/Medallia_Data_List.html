{% extends 'GuestVoice/GuestVoicehomebase.html' %}
{% block content %} 
{% load custom_filters %}
{% load static %}

<style>

    /* Make scrollbar thinner */
    .table-responsive::-webkit-scrollbar {
        height: 5px; /* Reduce height */
    }

    /* Track (background of the scrollbar) */
    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    /* Handle (scrollbar itself) */
    .table-responsive::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

    /* Handle on hover */
    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    table tr td:last-child, table tr th:last-child {
        max-width: 400px !important;
        min-width: 400px !important;
    }
</style>

<style>
.custom-toast {
  position: fixed;
  top: 40px;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  border-radius: 8px;
  padding: 18px 22px;
  display: flex;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0,0,0,0.15);
  font-family: Arial, sans-serif;
  font-size: 14px;
  gap: 8px;
  animation: fadeIn 0.3s ease, fadeOut 0.3s ease 3s forwards;
  z-index: 9999;
}
.toast-action {
  margin-left: auto;
  color: #0078d4;
  cursor: pointer;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translate(-50%, -20px); }
  to { opacity: 1; transform: translate(-50%, 0); }
}
@keyframes fadeOut {
  to { opacity: 0; transform: translate(-50%, -20px); }
}
</style>

<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h3 class="page-title">Guest Voice</h3>
                <ul class="breadcrumb">
                    <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                    <li class="breadcrumb-item active">Medallia Data List</li>
                </ul>
            </div>
            <div class="col-auto float-end ms-auto">
                <a href="{% url "Medallia_Add_Data" %}?OID={{selected_organization}}" class="btn btn-primary"><i class="fa-solid fa-plus"></i>&nbsp;Create Entry</a> 
                &nbsp;
                 <a href="" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#Upload_File"><i class="fa-solid fa-th-large"></i>&nbsp;Add Bulk</a>
    
            </div>
        </div>
    </div>

    <div class="card-body">

<!-- Data table -->
    <div class="row">
        <div class="col-md-12">
            <div class="table-responsive">
                <table class="table table-striped table-bordered  custom-table mb-0 datatable">
                    <thead>
                        <tr>
                            <th class="text-center">#</th>
                            <th >Month</th>
                            <th >Guest Name</th>
                            <th >Property Name</th>
                            <th class="text-center">Room No.</th>
                            <th class="text-center">NPS</th>
                            <th class="text-center">Response Date</th>
                            <th class="text-center">Entry Date</th>
                            <th class="text-center">Check In</th>
                            <th class="text-center">Check Out</th>
                            <th class="text-center">Check-in Process</th>
                            <th class="text-center">Staff Responsiveness</th>
                            <th class="text-center">WOH App Experience</th>
                            <th class="text-center">Working Order</th>
                            <th class="text-center">Overall FnB Experience</th>
                            <th class="text-center">Cleanliness of Room and Bathroom</th>
                            <th class="text-center">Customer Service</th>
                            <th class="text-center">Property Anticipated Guest Needs</th>
                            <th class="text-center">Condition of the Hotel</th>
                            <th class="text-center">Overall Breakfast Experience</th>
                            <th class="text-center">Satisfaction with LP Member Benefits</th>
                            <th class="text-center">Overall WOH Program Experience</th>
                            <th class="text-center">Spa Experience</th>
                            <th class="text-center">Helpfulness of Staff</th>
                            <th class="text-center">Overall Delivery of HK Services</th>
                            <th >Comments</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for data in Medallia_Data %}
                        <tr>
                            <td class="text-center">{{ forloop.counter }}</td>
                            <td >{{ data.Month|default_if_none:''  }}</td>
                            <td >{{ data.GuestName|default_if_none:''  }}</td>
                            <td >{{ data.PropertyName|default_if_none:''  }}</td>
                            <td class="text-center">{{ data.RoomNo|default_if_none:''  }}</td>
                            {% comment %} <td class="text-center">{{ data.RoomNo  }}</td> {% endcomment %}
                            <td class="text-center">{{ data.NPS|default_if_none:''  }}</td>
                            <td class="text-center">{{ data.ResponseDate|default_if_none:''  }}</td>
                            <td class="text-center">{{ data.EntryDate|default_if_none:''  }}</td>
                            <td class="text-center">{{ data.CheckInDate|default_if_none:''  }}</td>
                            <td class="text-center">{{ data.CheckOutDate|default_if_none:''  }}</td>
                            <td class="text-center">{{ data.CheckInProcess|default_if_none:''  }}</td>
                            <td class="text-center">{{ data.StaffResponsiveness|default_if_none:''  }}</td>
                            <td class="text-center">{{ data.WohAppExperience|default_if_none:''  }}</td>

                            <td class="text-center">{{ data.WorkingOrder|default_if_none:''  }}</td>
                            <td class="text-center">{{ data.OverallFnbExperience|default_if_none:''  }}</td>
                            <td class="text-center">{{ data.Cleanliness|default_if_none:''  }}</td>
                            <td class="text-center">{{ data.CustomerService|default_if_none:''  }}</td>
                            <td class="text-center">{{ data.PropertyAnticipatedGuestNeeds|default_if_none:''  }}</td>
                            <td class="text-center">{{ data.ConditionOfHotel|default_if_none:''  }}</td>
                            <td class="text-center">{{ data.BreakfastExperience|default_if_none:''  }}</td>
                            <td class="text-center">{{ data.LpMemberSatisfaction|default_if_none:''  }}</td>
                            <td class="text-center">{{ data.WohProgramExperience|default_if_none:''  }}</td>
                            <td class="text-center">{{ data.SpaExperience|default_if_none:''  }}</td>
                            <td class="text-center">{{ data.StaffHelpfulness|default_if_none:''  }}</td>
                            <td class="text-center">{{ data.DeliveryHkServices|default_if_none:''  }}</td>
                            <td >{{ data.Comments  }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</div>


<!-- <button onclick="showToast()">Copy Password</button> -->


<!-- Add File Upload -->
<div id="Upload_File" class="modal custom-modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'bulk_upload_medallia' %}?OID={{selected_organization}}&SW={{selected_software}}" id="BulkUpload_Pupup" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="input-block mb-3">
                        <label class="col-form-label">Select File <span class="text-danger">*</span></label>
                        <input class="form-control" type="file" accept=".xls,.xlsx" name="excel_file_upload">
                    </div>
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">Upload</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div> 

<script>
    window.addEventListener("load", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const isSuccess = urlParams.get("Success");
        const message = urlParams.get("message");
        const OID = urlParams.get("OID");

        console.log("OID is here", OID)

        if (isSuccess && ['true', '1', 'yes', 'false', '0', 'no'].includes(isSuccess.toLowerCase())) {
            const successBool = ['true', '1', 'yes'].includes(isSuccess.toLowerCase());
            showToast(message, successBool);

            // Remove query params so it doesn't show again on refresh
            urlParams.delete("Success");
            urlParams.delete("message");
            urlParams.delete("action");
            const newUrl = window.location.pathname + (urlParams.toString() ? "?" + urlParams.toString() : "");
            window.history.replaceState({}, document.title, newUrl); 

            // const keepParams = ["OID"];
            // for (const key of ["Success", "message", "action"]) {
            //     urlParams.delete(key);
            // }
            // const newUrl = window.location.pathname + 
            //     (urlParams.toString() ? "?" + urlParams.toString() : "");
            // window.history.replaceState({}, document.title, newUrl);
        }
    });

    function showToast(msg, isSuccess) {
        const toast = document.createElement('div');
        toast.className = 'custom-toast';

        const iconColor = isSuccess ? '#2ecc71' : '#e74c3c'; // green / red
        const iconSymbol = isSuccess ? '✔' : '✖';

        toast.innerHTML = `
            <span style="color:${iconColor};font-size:16px;">${iconSymbol}</span>
            <span>${msg}</span>
            <span style="margin-left:auto;color:#0078d4;cursor:pointer;" onclick="this.parentElement.remove()">Dismiss</span>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3500);
    }
</script>
{% endblock content %}