{% extends 'GuestVoice/GuestVoicehomebase.html' %}
{% block content %} 
{% load custom_filters %}
{% load static %}


<style>
    table tr td:last-child, table tr th:last-child {
        max-width: 400px !important;
        min-width: 400px !important;
    }
</style>

<style>
.custom-toast {
  position: fixed;
  top: 40px;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  border-radius: 8px;
  padding: 18px 22px;
  display: flex;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0,0,0,0.15);
  font-family: Arial, sans-serif;
  font-size: 14px;
  gap: 8px;
  animation: fadeIn 0.3s ease, fadeOut 0.3s ease 3s forwards;
  z-index: 9999;
}
.toast-action {
  margin-left: auto;
  color: #0078d4;
  cursor: pointer;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translate(-50%, -20px); }
  to { opacity: 1; transform: translate(-50%, 0); }
}
@keyframes fadeOut {
  to { opacity: 0; transform: translate(-50%, -20px); }
}
</style>


<div class="card">

        <div class="card-header">
            <div class="row align-items-center">
                <div class="col">
                    <h3 class="page-title">Guest Voice</h3>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                        <li class="breadcrumb-item active">Review Data List</li>
                    </ul>
                </div>
                <div class="col-auto float-end ms-auto">
                    <a href="{% url "ReviewPro_Add_Data" %}?OID={{selected_organization}}" class="btn btn-primary"><i class="fa-solid fa-plus"></i>&nbsp;Create Entry</a> 
                    &nbsp;
                    <a href="" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#Upload_File"><i class="fa-solid fa-th-large"></i>&nbsp;Add Bulk</a>
                </div>
            </div>
        </div>

    <div class="card-body">
    <!-- Data Table  -->
        <div class="row">
            <div class="col-md-12">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered  custom-table mb-0 datatable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Month</th>
                                <th>GRI™</th>
                                <th class="reviewer">Reviewer</th>
                                <th>Country</th>
                                <th>Published</th>
                                <th>Entry Date</th>
                                <th>Source</th>
                                <th>Review Rating</th>
                                <th>Rating Scale</th>
                                <th>Review Score</th>
                                <th>Classification</th>
                                <th>Service</th>
                                <th>Service Score</th>
                                <th>Cleanliness</th>
                                <th>Clean. Score</th>
                                <th>Location</th>
                                <th>Loc. Score</th>
                                <th>Value</th>
                                <th>Val. Score</th>
                                <th>Room</th>
                                <th>Room Score</th>
                                <th>Dept. Rating Scale</th>
                                <th>Gastronomy</th>
                                <th>Gastronomy Score</th>
                                <th class="title">Review Title</th>
                                <th class="review-text">Review Text</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for data in ReviewProData %}
                            <tr>
                                <td class="text-center">{{ forloop.counter }}</td>
                                <td>{{ data.Month }}</td> 
                                <td>{{ data.GriTM|default_if_none:'' }}</td> 
                                <td>{{ data.Reviewer }}</td> 
                                <td>{{ data.Country|default_if_none:'' }}</td> 
                                <td>{{ data.PublishedDate|default_if_none:'' }}</td> 
                                <td>{{ data.EntryDate|default_if_none:'' }}</td> 
                                <td>{{ data.Source|default_if_none:'' }}</td> 
                                <td>{{ data.ReviewRating|default_if_none:'' }}</td> 
                                <td>{{ data.RatingScale|default_if_none:'' }}</td> 
                                <td>{{ data.ReviewScore|default_if_none:'' }}</td> 
                                <td>{{ data.Classification|default_if_none:'' }}</td> 
                                <td>{{ data.Service|default_if_none:'' }}</td> 
                                <td>{{ data.ServiceScore|default_if_none:'' }}</td> 
                                
                                <td>{{ data.CleanlinessScore|default_if_none:'' }}</td> 
                                <td>{{ data.Cleanliness|default_if_none:''  }}</td> 
                                <td>{{ data.Location|default_if_none:''  }}</td> 
                                <td>{{ data.LocationScore|default_if_none:''  }}</td> 
                                <td>{{ data.Value|default_if_none:''  }}</td> 
                                <td>{{ data.ValueScore|default_if_none:''  }}</td> 
                                
                                <td>{{ data.Room|default_if_none:''  }}</td> 
                                <td>{{ data.RoomScore|default_if_none:''  }}</td> 
                                <td>{{ data.DepartmentRatingScale|default_if_none:''  }}</td> 
                                <td>{{ data.Gastronomy|default_if_none:''  }}</td> 
                                <td>{{ data.GastronomyScore|default_if_none:''  }}</td> 
                                <td>{{ data.ReviewTitle }}</td> 
                                <td>{{ data.ReviewText  }}</td> 
                            </tr>
                            {% endfor %}

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Add File Upload -->
<div id="Upload_File" class="modal custom-modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url "bulk_upload_reviews" %}?OID={{selected_organization}}" id"BulkUpload_Pupup" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="input-block mb-3">
                        <label class="col-form-label">Select File <span class="text-danger">*</span></label>
                        <input class="form-control" type="file" accept=".xls,.xlsx" name="excel_file_upload">
                        {% comment %} <input type="file" name="excel_file" accept=".xlsx,.xls"> {% endcomment %}
                    </div>
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">Upload</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
window.addEventListener("load", function () {
    const urlParams = new URLSearchParams(window.location.search);
    const isSuccess = urlParams.get("Success");
    const message = urlParams.get("message");

    if (isSuccess && ['true', '1', 'yes', 'false', '0', 'no'].includes(isSuccess.toLowerCase())) {
        const successBool = ['true', '1', 'yes'].includes(isSuccess.toLowerCase());
        showToast(message, successBool);

        // Remove query params so it doesn't show again on refresh
        urlParams.delete("Success");
        urlParams.delete("message");
        urlParams.delete("action");
        const newUrl = window.location.pathname + (urlParams.toString() ? "?" + urlParams.toString() : "");
        window.history.replaceState({}, document.title, newUrl); 
    }
});

function showToast(msg, isSuccess) {
    const toast = document.createElement('div');
    toast.className = 'custom-toast';

    const iconColor = isSuccess ? '#2ecc71' : '#e74c3c'; // green / red
    const iconSymbol = isSuccess ? '✔' : '✖';

    toast.innerHTML = `
        <span style="color:${iconColor};font-size:16px;">${iconSymbol}</span>
        <span>${msg}</span>
        <span style="margin-left:auto;color:#0078d4;cursor:pointer;" onclick="this.parentElement.remove()">Dismiss</span>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3500);
}
</script>

{% endblock content %}