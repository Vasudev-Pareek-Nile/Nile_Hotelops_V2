{% extends "Salary_Structure/homebase.html" %}

{% block content %}

<style>
    
    .card-footer{
        z-index: 9;
        position: fixed;
        bottom: 0;
        /* display: block; */
        width: 100%;
        background-color: white;
        right: 0;
        padding-right: 56px;
        justify-content: end;
    }


    #Salary_StructureTable {
        width: 100%;
        border-collapse: collapse;
    }

    #Salary_StructureTable th:nth-child(3),
    #Salary_StructureTable td:nth-child(3) {
        background-color: #f9f9f9;
        max-width: 150px;
        min-width: 150px;
    }

    #Salary_StructureTable th:nth-child(4),
    #Salary_StructureTable td:nth-child(4) {
        background-color: #f9f9f9;
        max-width: 100px;
        min-width: 100px;
    }

    #Salary_StructureTable th:nth-child(5),
    #Salary_StructureTable td:nth-child(5) {
        background-color: #f9f9f9;
        max-width: 100px;
        min-width: 100px;
    }
    #Salary_StructureTable th:nth-child(6),
    #Salary_StructureTable td:nth-child(6) {
        background-color: #f9f9f9;
        max-width: 150px;
        min-width: 150px;
    }
    #Salary_StructureTable th:nth-child(7),
    #Salary_StructureTable td:nth-child(7) {
        background-color: #f9f9f9;
        max-width: 30px;
        min-width: 30px;
    }

    
    .delete:hover{
        background-color: white;
        border-color: red;
    }

    .delete:hover i{
        color: red;
    }

    .delete i{
        color: white;
        transition: all 0.5s ease-in-out;
    }

    #Gender{
        z-index: 9990; /* Ensure it appears above other elements */
    }
</style>


<div class="card">

    <div class="card-body">
        <div id="SalaryStructureContainer" class="">
            <form action="{% url "salary_Calc_post_value" %}" id="SalaryStructureForm" method="post">
                {% csrf_token %}
                <table class="table table-bordered" id="Salary_StructureTable">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Title</th>
                            <th>Formula_Expression</th>
                            <th>Per Month</th>
                            <th>Per Annum</th>
                        </tr>
                    </thead>
                    <tbody id="SalaryStructureBody">
                        <tr>
                            <td>${index + 1}</td>
                            <td>
                                <p>${item.Display_Names || ''}</p>
                            </td>
                            <td><input type="text" class="form-control" name="Formula_Expression" value="${item.Formula_Expression || ''}" readonly></td>
                            <td><input type="text" class="form-control" name="PerAnnum" value="${item.Calculated_Value || ''}"></td>
                            <td><input type="text" class="form-control" name="PerMonth" value=""></td>
                            <input type="hidden" name="RowID[]" value="${item.id}">
                            <input type="hidden" name="RowID[]" value="${item.Salary_Code}">
                        </tr>
                    </tbody>
                </table>
            </form>
        </div>
    </div>
    <div class="card-footer d-flex justify-content-end">
        <button type="submit" form="SalaryStructureForm" class="btn btn-primary">Save</button>
        <button type="reset" form="SalaryStructureForm" class="btn btn-secondary ms-2">Reset</button>
    </div>

    <div class="d-flex justify-content-end mb-2">
        <button id="addRowBtn" type="button" class="btn btn-sm btn-primary">+ Add Row</button>
    </div>

</div>



{% comment %} <script>
    document.addEventListener("DOMContentLoaded", function () {
        // fetch("/Salary_Structure/api/salary-structure/")
        fetch("/Salary_Structure/salary_Calc_post_value")
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById("SalaryStructureBody");
                tbody.innerHTML = "";

                console.log("data is here", data)

                data.forEach((item, index) => {
                    const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>
                                <p>${item.Display_Names || ''}</p>
                            </td>
                            <td><input type="text" class="form-control" name="Formula_Expression" value="${item.Formula_Expression || ''}" readonly></td>
                            <td><input type="text" class="form-control" name="PerAnnum" value="${item.Calculated_Value || ''}"></td>
                            <td><input type="text" class="form-control" name="PerMonth" value=""></td>
                            <input type="hidden" name="RowID[]" value="${item.id}">
                            <input type="hidden" name="RowID[]" value="${item.Salary_Code}">
                        </tr>
                    `;
                    tbody.insertAdjacentHTML("beforeend", row);
                });

                // Attach delete handler
                document.querySelectorAll(".delete-btn").forEach(btn => {
                    btn.addEventListener("click", function () {
                        const rowId = this.getAttribute("data-id");

                        if (confirm("Are you sure you want to delete this row?")) {
                            fetch(`/Salary_Structure/Delete_Salary_Structure/${rowId}/`, {
                                method: "DELETE",
                                headers: {
                                    "X-CSRFToken": getCookie("csrftoken")
                                }
                            })
                            .then(response => {
                                if (response.ok) {
                                    this.closest("tr").remove();
                                } else {
                                    alert("Error deleting record.");
                                }
                            })
                            .catch(error => console.error("Error deleting:", error));
                        }
                    });
                });
            })
            .catch(error => console.error("Error fetching salary structure:", error));
    });


    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

</script> {% endcomment %}

{% endblock content %}