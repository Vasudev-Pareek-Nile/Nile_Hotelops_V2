{% extends "Inventory/homebase.html" %} 
{% load IT_Inventory_Filters %}
{% block content %}
<style>
    .modal#statusSuccessModal .modal-content, 
    .modal#statusErrorsModal .modal-content {
        border-radius: 30px;
    }
    .modal#statusSuccessModal .modal-content svg, 
    .modal#statusErrorsModal .modal-content svg {
        width: 100px; 
        display: block; 
        margin: 0 auto;
    }
    .modal#statusSuccessModal .modal-content .path, 
    .modal#statusErrorsModal .modal-content .path {
        stroke-dasharray: 1000; 
        stroke-dashoffset: 0;
    }
    .modal#statusSuccessModal .modal-content .path.circle, 
    .modal#statusErrorsModal .modal-content .path.circle {
        -webkit-animation: dash 0.9s ease-in-out; 
        animation: dash 0.9s ease-in-out;
    }
    .modal#statusSuccessModal .modal-content .path.line, 
    .modal#statusErrorsModal .modal-content .path.line {
        stroke-dashoffset: 1000; 
        -webkit-animation: dash 0.95s 0.35s ease-in-out forwards; 
        animation: dash 0.95s 0.35s ease-in-out forwards;
    }
    .modal#statusSuccessModal .modal-content .path.check, 
    .modal#statusErrorsModal .modal-content .path.check {
        stroke-dashoffset: -100; 
        -webkit-animation: dash-check 0.95s 0.35s ease-in-out forwards; 
        animation: dash-check 0.95s 0.35s ease-in-out forwards;
    }

    @-webkit-keyframes dash { 
        0% {
            stroke-dashoffset: 1000;
        }
        100% {
            stroke-dashoffset: 0;
        }
    }
    @keyframes dash { 
        0% {
            stroke-dashoffset: 1000;
        }
        100%{
            stroke-dashoffset: 0;
        }
    }
    @-webkit-keyframes dash { 
        0% {
            stroke-dashoffset: 1000;
        }
        100% {
            stroke-dashoffset: 0;
        }
    }
    @keyframes dash { 
        0% {
            stroke-dashoffset: 1000;}
        100% {
            stroke-dashoffset: 0;
        }
    }
    @-webkit-keyframes dash-check { 
        0% {
            stroke-dashoffset: -100;
        }
        100% {
            stroke-dashoffset: 900;
        }
    }
    @keyframes dash-check {
        0% {
            stroke-dashoffset: -100;
        }
        100% {
            stroke-dashoffset: 900;
        }
    }
    .box00{
        width: 100px;
        height: 100px;
        border-radius: 50%;
    }

    
    .card-header{
        margin-bottom:-25px;
    }
</style>

<div class="card">
    <div class="card-header  d-flex justify-content-between">
        <p class="text-uppercase fw-bold fs-6">IT Inventory Software List</p>
        <div>
            <a href="{% url 'Inventory_Add' %}?SoftwareInventory=True" class="btn btn-primary btn-sm">Add Software Inventory</a>
            <button onclick="exportTableToExcel()" class="btn btn-primary btn-sm">Export to Excel</button>
            <a href="{% url "IT_Inventory_Data_PDF" %}?Inventory_Type=Software" type="button" class="btn btn-primary btn-sm" >Download PDF</a>
        </div>
    </div>
    <!-- <br> -->
    <div class="card-body">
        <div class="col-md-12">
            <form method="GET" class="row">
                <div class="m-1 col-md-3">
                    <label for="organization" class="form-label">Organization</label>
                    {% if SessionOrganizationID == 3 %}
                        <!-- Show dropdown for Nile users -->
                        <select name="OrganizationID" id="organization" class="form-control select2">
                            <option value="All" {% if selectedOrganizationID == "All" %}selected{% endif %}>All</option>
                            {% for itm in orgs %}
                                <option value="{{ itm.OrganizationID }}" {% if itm.OrganizationID|stringformat:"s" == selectedOrganizationID %}selected{% endif %}>
                                    {{ itm.OrganizationName }}
                                </option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <!-- Show only their own organization as readonly -->
                        <input type="hidden" name="OrganizationID" value="{{ SessionOrganizationID }}">
                        <input type="text" class="form-control" value="{{ orgs.0.OrganizationName }}">
                    {% endif %}
                </div>
                <div class="col-md-2">
                    <label for="SoftwareType"  class="form-label">Software Type</label>
                    <select name="SoftwareType" id="SoftwareType" class="form-control select2">
                        <option value="">All</option>
                        {% for software_type in software_types %}
                            <option value="{{ software_type.software_name }}" {% if software_type.software_name == SoftwareType%} selected {% endif %}>{{ software_type.software_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label for="SoftwareName" class="form-label">Software Name</label>
                    <select  name="SoftwareName" id="SoftwareName" class="form-control select2">
                        <option value="">All</option>
                        {% for software_Name in SoftwareNames %}
                            <option value="{{ software_Name.softwarename }}" {% if software_Name.softwarename == SoftwareName %} selected {% endif %}>{{ software_Name.softwarename }}</option>
                        {% endfor %}
                    </select>
                </div>


                <div class="col-md-2">
                    <label class="form-label" for="software_AMC_Type">AMC Type</label>
                    <select class="form-control" name="software_AMC_Type" id="software_AMC_Type">
                        <option value="">Select Type</option>
                        <option value="Comprehensive" {% if software_AMC_Type == "Comprehensive" %}selected{% endif %}>Comprehensive</option>
                        <option value="Non Comprehensive" {% if software_AMC_Type == "Non Comprehensive" %}selected{% endif %}>Non Comprehensive </option>
                        <option value="On Call" {% if software_AMC_Type == "On Call" %}selected{% endif %}>On Call</option>
                        <option value="Hotel Team" {% if software_AMC_Type == "By Hotel Team" %}selected{% endif %}>By Hotel Team</option>
                        <option value="No AMC" {% if software_AMC_Type == "No AMC Required" %}selected{% endif %}>No AMC Required</option>
                    </select>
                </div>

                
                <div class="col-md-2">
                    <label class="form-label" for="AMC_Status">AMC Status</label>
                    <select class="form-control" name="AMC_Status" id="AMC_Status">
                        <option value="">Select Status</option>
                        <option value="N/A" {% if software_AMC_Status == 'N/A' %}selected{% endif %}>N/A</option>
                        <option value="Under Warranty" {% if software_AMC_Status == 'Under Warranty' %}selected{% endif %}>Under Warranty</option>
                        <option value="Expired" {% if software_AMC_Status == 'Expired' %}selected{% endif %}>Expired</option>
                    </select>
                </div>

                <div class="col-md-2" style="margin-top:2rem;">
                    <a href="{% url "Software_List" %}" type="button" id="RefreshBtn" class="btn btn-primary">Clear Filter</a>
                </div>
            
                {% comment %} <div class="col-md-12 text-end mt-3">
                    <a href="{% url "Software_List" %}" type="button" id="RefreshBtn" class="btn btn-primary btn-sm">Clear Filter</a>
                </div> {% endcomment %}
            </form>  
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <table class="table table-striped table-bordered custom-table mb-0 datatable dataTable no-footer"  id="SoftwareTable">
            <thead class="thead">
                <tr class="">
                    <th>#</th>
                    <th>Software Type</th>
                    <th>Software Name</th>
                    <th>Quantity</th>
                    <th>AMC Type</th>
                    <th>AMC PERIOD</th>
                    <th>AMC STATUS</th>
                    <th>AMC Quantity</th>
                    <th>Per Unit <br> Price</th>
                    <th>AMC Yearly <br> Expense</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                {% for itInventorys in inventory_data %}
                <tr>
                    <td>{{ forloop.counter }}</td> 
                    <td>{{itInventorys.inventory.softwaretype}}</td> 
                    <td>{{itInventorys.inventory.softwarename}}</td> 
                    <td>{{itInventorys.inventory.Quantity}}</td> 
                    <td>{{itInventorys.inventory.software_AMC_Type}}</td> 
                    <td>
                        {{itInventorys.inventory.software_AMC_Start|format_ymd_to_dmy }}
                        <br>
                        {{itInventorys.inventory.software_AMC_end|format_ymd_to_dmy }}
                    </td> 
                    {% comment %} <td>{{itInventorys.inventory.software_AMC_Status}}</td>  {% endcomment %}
                    <td>
                        <span class="{% if itInventorys.inventory.software_AMC_Status == 'Expired' %}text-danger{% endif %}">{{itInventorys.inventory.software_AMC_Status}}</span>
                    </td> 

                    <td>{{itInventorys.inventory.Software_Quantity}}</td> 
                    <td>{{itInventorys.inventory.Software_unit_price}}</td> 
                    <td>{{itInventorys.inventory.software_AMC_Yearly_Expense}}</td> 
                </tr>
                {% endfor %} 
            </tbody> 
        </table>
    </div>
</div>
    


<!-- Modals For Success and Error -->
<div class="container  p-5">
	<div class="row">
		<div class="modal fade" id="statusErrorsModal" tabindex="-1" role="dialog" data-bs-backdrop="static" data-bs-keyboard="false"> 
			<div class="modal-dialog modal-dialog-centered modal-sm" role="document"> 
				<div class="modal-content"> 
					<div class="modal-body text-center p-lg-4"> 
						<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 130.2 130.2">
							<circle class="path circle" fill="none" stroke="#3a4a93" stroke-width="6" stroke-miterlimit="10" cx="65.1" cy="65.1" r="62.1" /> 
							<line class="path line" fill="none" stroke="#3a4a93" stroke-width="6" stroke-linecap="round" stroke-miterlimit="10" x1="34.4" y1="37.9" x2="95.8" y2="92.3" />
							<line class="path line" fill="none" stroke="#3a4a93" stroke-width="6" stroke-linecap="round" stroke-miterlimit="10" x1="95.8" y1="38" x2="34.4" y2="92.2" /> 
						</svg> 
						<h4 class="text-danger mt-3">Error !!</h4> 
						{% comment %} <p class="mt-3" id="errorMessageText">Something went wrong while submitting the form.</p> {% endcomment %}
                        <p class="mt-3" id="errorMessageText">
                            {{ error_message|default:"Something went wrong while submitting the form." }}
                        </p>
						<button type="button" class="btn btn-sm mt-3 btn-danger" data-bs-dismiss="modal">Ok</button> 
					</div> 
				</div> 
			</div> 
		</div>

		<div class="modal fade" id="statusSuccessModal" tabindex="-1" role="dialog" data-bs-backdrop="static" data-bs-keyboard="false"> 
			<div class="modal-dialog modal-dialog-centered modal-sm" role="document"> 
				<div class="modal-content"> 
					<div class="modal-body text-center p-lg-4"> 
						<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 130.2 130.2">
							<circle class="path circle" fill="none" stroke="{% if 'deleted' in success_message|lower %}#ff0000{% else %}#3a4a93{% endif %}" stroke-width="6" stroke-miterlimit="10" cx="65.1" cy="65.1" r="62.1" />
							<polyline class="path check" fill="none" stroke="{% if 'deleted' in success_message|lower %}#ff0000{% else %}#3a4a93{% endif %}" stroke-width="6" stroke-linecap="round" stroke-miterlimit="10" points="100.2,40.2 51.5,88.8 29.8,67.5 " /> 
						</svg> 
						<h4 class="mt-3" style="color:{% if 'deleted' in success_message|lower %}#ff0000{% else %}#3a4a93{% endif %}">Congrats!</h4> 
						{% comment %} <p class="mt-3" id="successMessageText">Travel Details submitted successfully.</p> {% endcomment %}
                        <p class="mt-3 {% if 'deleted' in success_message|lower %}text-danger{% endif %}" id="successMessageText">
                            {{ success_message|default:"Details submitted successfully." }}
                        </p>
						<button type="button" class="btn btn-sm mt-3 {% if 'deleted' in success_message|lower %}btn-danger{% else %}btn-primary{% endif %}" data-dismiss="modal">Ok</button> 
					</div> 
				</div> 
			</div> 
		</div>
	</div>
</div>

<script>
    window.onload = function() {
        {% for itInventorys in inventory_data %}
        const qrCodeBase64_{{ forloop.counter }} = "{{ itInventorys.qr_code_base64 }}";
        
        document.getElementById('qrCodeImage{{ forloop.counter }}').src = "data:image/png;base64," + qrCodeBase64_{{ forloop.counter }};

        document.getElementById('downloadQR{{ forloop.counter }}').addEventListener('click', function() {
            const downloadLink = document.createElement('a');
            downloadLink.href = "data:image/png;base64," + qrCodeBase64_{{ forloop.counter }};
            downloadLink.download = "qr_code{{ forloop.counter }}.png";
            downloadLink.click();
        });

      
        document.getElementById('qrCodeImage{{ forloop.counter }}').addEventListener('click', function() {
            alert("Welcome!");
            
        });
        {% endfor %}
    };
</script>

<script>
    window.addEventListener("load", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const isSuccess = urlParams.get("success");
        const isError = urlParams.get("error");
        const message = urlParams.get("message");

        if (isSuccess && ['true', '1', 'yes'].includes(isSuccess.toLowerCase())) {
            const successModalElement = document.getElementById("statusSuccessModal");
            const successText = document.getElementById("successMessageText");

            if (successModalElement) {
                if (successText && message) {
                    successText.textContent = decodeURIComponent(message);
                }
                const successModal = new bootstrap.Modal(successModalElement);
                successModal.show();
            }
        }

        if (isError && ['true', '1', 'yes'].includes(isError.toLowerCase())) {
            const errorModalElement = document.getElementById("statusErrorsModal");
            const errorText = document.getElementById("errorMessageText");

            if (errorModalElement) {
                if (errorText && message) {
                    errorText.textContent = decodeURIComponent(message);
                }
                const errorModal = new bootstrap.Modal(errorModalElement);
                errorModal.show();
            }
        }

        // Cleanup URL
        const newUrl = window.location.origin + window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
    });
</script>

{% comment %} <script>
    document.addEventListener('DOMContentLoaded', function () {
        const SoftwareTypeInput = document.getElementById('SoftwareType');
        const SoftwareNameInput = document.getElementById('SoftwareName');
        const software_AMC_TypeInput = document.querySelector('[name="software_AMC_Type"]');
        const AMC_StatusInput = document.querySelector('[name="AMC_Status"]');

        const table = document.getElementById('SoftwareTable');
        const tbody = document.getElementById('tableBody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        function filterTable() {
            const softwareTypeVal = SoftwareTypeInput.value.toLowerCase();
            const softwareNameVal = SoftwareNameInput.value.toLowerCase();
            const amcTypeVal = software_AMC_TypeInput.value.toLowerCase();
            const amcStatusVal = AMC_StatusInput.value.toLowerCase();

            let currentSrNo = 1;

            rows.forEach(row => {
                const type = row.children[1]?.textContent.toLowerCase();   // adjust index if needed
                const name = row.children[2]?.textContent.toLowerCase();   // adjust index if needed
                const amcType = row.children[3]?.textContent.toLowerCase(); // adjust index if needed
                const amcStatus = row.children[4]?.textContent.toLowerCase(); // adjust index if needed

                const matches =
                    (!softwareTypeVal || type.includes(softwareTypeVal)) &&
                    (!softwareNameVal || name.includes(softwareNameVal)) &&
                    (!amcTypeVal || amcType === amcTypeVal) &&
                    (!amcStatusVal || amcStatus === amcStatusVal);

                row.style.display = matches ? '' : 'none';

                // Optional: Renumber Sr. No. if present in column 0
                if (matches && row.children[0]?.hasAttribute('rowspan')) {
                    row.children[0].textContent = currentSrNo++;
                }
            });
        }

        // Attach listeners
        SoftwareTypeInput.addEventListener('input', filterTable);
        SoftwareNameInput.addEventListener('input', filterTable);
        software_AMC_TypeInput.addEventListener('change', filterTable);
        AMC_StatusInput.addEventListener('change', filterTable);
    });
</script> {% endcomment %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const filters = document.querySelectorAll('form select');
        filters.forEach(function (filter) {
            filter.addEventListener('change', function () {
                this.form.submit();
            });
        });
    });
</script>

{% comment %} <script>
    document.addEventListener('DOMContentLoaded', function () {
        const SoftwareTypeInput = document.getElementById('SoftwareType');
        const SoftwareNameInput = document.getElementById('SoftwareName');
        const software_AMC_TypeInput = document.querySelector('[name="software_AMC_Type"]');
        const AMC_StatusInput = document.querySelector('[name="AMC_Status"]');

        const tbody = document.getElementById('tableBody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        function filterTable() {
            const softwareTypeVal = SoftwareTypeInput.value.toLowerCase();
            const softwareNameVal = SoftwareNameInput.value.toLowerCase();
            const amcTypeVal = software_AMC_TypeInput.value.toLowerCase();
            const amcStatusVal = AMC_StatusInput.value.toLowerCase();

            rows.forEach(row => {
                const type = row.children[0]?.textContent.toLowerCase();       // Software Type
                const name = row.children[1]?.textContent.toLowerCase();       // Software Name
                const amcType = row.children[3]?.textContent.toLowerCase();    // AMC Type
                const amcStatus = row.children[5]?.textContent.toLowerCase();  // AMC Status

                const matches =
                    (!softwareTypeVal || type.includes(softwareTypeVal)) &&
                    (!softwareNameVal || name.includes(softwareNameVal)) &&
                    (!amcTypeVal || amcType === amcTypeVal) &&
                    (!amcStatusVal || amcStatus === amcStatusVal);

                row.style.display = matches ? "" : "none";
            });
        }

        [SoftwareTypeInput, SoftwareNameInput, software_AMC_TypeInput, AMC_StatusInput].forEach(input => {
            input.addEventListener('input', filterTable);
        });
    });
</script> {% endcomment %}

 {% comment %} <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    function exportTableToExcel() {
        const table = document.getElementById("SoftwareTable");

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.table_to_sheet(table, { raw: true });  // auto handles rowspan/colspan

        XLSX.utils.book_append_sheet(wb, ws, "Travel Details");
        XLSX.writeFile(wb, "Travel_Details.xlsx");
    }
</script>  {% endcomment %}


<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
    function exportTableToExcel() {
        const table = document.getElementById("SoftwareTable");

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.table_to_sheet(table, { raw: true });

        // Set column widths based on content length
        const range = XLSX.utils.decode_range(ws['!ref']);
        const colWidths = [];

        for (let C = range.s.c; C <= range.e.c; ++C) {
            let maxWidth = 10;
            for (let R = range.s.r; R <= range.e.r; ++R) {
                const cell_ref = XLSX.utils.encode_cell({ r: R, c: C });
                const cell = ws[cell_ref];
                if (cell && cell.v) {
                    const len = cell.v.toString().length;
                    if (len > maxWidth) maxWidth = len;
                }
            }
            colWidths.push({ wch: maxWidth + 2 }); // Add padding
        }

        ws['!cols'] = colWidths;

        XLSX.utils.book_append_sheet(wb, ws, "IT Inventory Software List");
        XLSX.writeFile(wb, "IT_Inventory_Software_List.xlsx");
    }
</script>


{% endblock content %}
