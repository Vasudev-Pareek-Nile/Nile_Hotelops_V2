{% extends "Ranking_Board\homebase.html" %}
{% load static %}
{% block content %} 
     
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: Arial, sans-serif;
        background-color: #f9fafb;
        padding: 32px 16px;
        color: #000;
        font-size: 14px;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
    }



    .table-wrapper {
        width: 100%;
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid #d1d5db;
    }

    thead {
        background-color: #f9fafb;
    }

    th {
        padding: 12px;
        text-align: center;
        border: 1px solid #d1d5db;
        font-weight: 500;
        font-size: 13px;
    }

    th.main-header {
        background-color: #f3f4f6;
    }

    th.htl-header {
        vertical-align: middle;
        background-color: #ffffff;
        min-width: 120px;
    }

    th.sub-header {
        background-color: #f9fafb;
        min-width: 80px;
    }

    tbody tr {
        transition: background-color 0.2s;
    }

    tbody tr:hover {
        background-color: #f9fafb;
    }

    td {
        padding: 10px 12px;
        text-align: center;
        border: 1px solid #d1d5db;
        font-size: 13px;
    }

    td:first-child {
        text-align: left;
        font-weight: 500;
    }

    .page-wrapper .content {
        padding: 0px !important;
    }
    @media print {
        body {
            background-color: #fff;
            padding: 0;
        }

        .card {
            box-shadow: none;
            padding: 16px;
        }
    }

    @media screen and (max-width: 768px) {
        body {
            padding: 16px 8px;
        }

        .card {
            padding: 16px;
        }

        h1 {
            font-size: 20px;
            margin-bottom: 16px;
        }

        th, td {
            padding: 8px;
            font-size: 12px;
        }
    }
</style>

<style>
    .input-small {
        width: 98px;
        height: 30px;
        text-align: center;
    }

    .card{
        position: relative;
    }
    .card-footer{
        z-index: 9;
        position: fixed;
        bottom: 0;
        display: block;
        width: 100%;
        background-color: white;
        right: 0;
        padding-right: 56px;
    }
</style>

<!-- <div class="container"> -->
<div class="card">
    <div class="card-header">
        <h4 class="mb-2">Hotel Ranking Dashboard</h4>
    </div>
    <div class="card-body">
        <form action="" method="POST">
            {% csrf_token %}

            <div class="mb-2">
                <label>Entry Date 
                    <input type="date" class="form-control" value="{{current_date}}" name="EntryDate" required>
                </label>
            </div>

            <table>
                <thead>
                    <tr>
                        <th rowspan="2" class="htl-header">HTL</th>
                        <th colspan="2" class="main-header">TRIP ADVISOR</th>
                        <th colspan="2" class="main-header">Google Review</th>
                        <th colspan="2" class="main-header">MMT</th>
                        <th colspan="2" class="main-header">Booking.Com</th>
                    </tr>
                    <tr>
                        <th class="sub-header">Ranking</th>
                        <th class="sub-header">NRR</th>
                        <th class="sub-header">Ranking</th>
                        <th class="sub-header">NRR</th>
                        <th class="sub-header">Ranking</th>
                        <th class="sub-header">NRR</th>
                        <th class="sub-header">Ranking</th>
                        <th class="sub-header">NRR</th>
                    </tr>
                </thead>
                <tbody id="Ranking_Board_Table">

                </tbody>
            </table>

            <!-- Fixed Footer Buttons (outside scrollable area) -->
            <div class="card-footer text-end">
                <button type="button" class="btn btn-primary mt-1" id="Save">Save</button>
            </div>
        </form>
    </div>
</div>
<!-- </div> -->

<script>
    $(document).ready(function () {
        function loadRankingBoard() {
            $.ajax({
                url: "{% url 'OrganizationList_Api' 3 %}",
                method: "GET",
                dataType: "json",
                success: function (data) {
                    let tbody = $("#Ranking_Board_Table");
                    tbody.empty();

                    if (data.length === 0) {
                        tbody.append(`<tr><td colspan="9">No data found</td></tr>`);
                        return;
                    }

                    data.forEach(item => {
                        let row = `
                            <tr data-hotel-id="${item.OrganizationID}" data-hotel-name="${item.ShortDisplayLabel}">
                                <td title="${item.OrganizationName}">${item.ShortDisplayLabel}</td>
                                <td><input type="number" class="form-control input-small" id="trip_ranking_${item.OrganizationID}" name="trip_ranking"></td>
                                <td><input type="number" class="form-control input-small" id="trip_nrr_${item.OrganizationID}" name="trip_nrr"></td>
                                <td><input type="number" class="form-control input-small" id="google_ranking_${item.OrganizationID}" name="google_ranking"></td>
                                <td><input type="number" class="form-control input-small" id="google_nrr_${item.OrganizationID}" name="google_nrr"></td>
                                <td><input type="number" class="form-control input-small" id="mmt_ranking_${item.OrganizationID}" name="mmt_ranking"></td>
                                <td><input type="number" class="form-control input-small" id="mmt_nrr_${item.OrganizationID}" name="mmt_nrr"></td>
                                <td><input type="number" class="form-control input-small" id="trip_ranking_${item.OrganizationID}" name="booking_ranking"></td>
                                <td><input type="number" class="form-control input-small" id="trip_ranking_${item.OrganizationID}" name="booking_nrr"></td>
                            </tr>
                        `;
                        tbody.append(row);
                    });
                },
                error: function () {
                    $("#Ranking_Board_Table").html(`<tr><td colspan="9">Error loading data</td></tr>`);
                }
            });
        }

        loadRankingBoard();

        // ðŸ”¹ Handle Save button click
        $("#Save").click(function () {
            let allData = [];
            let entryDate = $("input[name='EntryDate']").val();

            $("#Ranking_Board_Table tr").each(function () {
                let hotelId = $(this).data("hotel-id");
                let hotelName = $(this).data("hotel-name");
                console.log("hotelid is here::", hotelId);
                if (!hotelId) return;

                let rowData = {
                    HotelID: hotelId,
                    HotelName: hotelName,
                    date: entryDate,
                    ta_ranking: $(this).find("input[name='trip_ranking']").val() || null,
                    ta_nrr: $(this).find("input[name='trip_nrr']").val() || null,
                    google_ranking: $(this).find("input[name='google_ranking']").val() || null,
                    google_nrr: $(this).find("input[name='google_nrr']").val() || null,
                    mmt_ranking: $(this).find("input[name='mmt_ranking']").val() || null,
                    mmt_nrr: $(this).find("input[name='mmt_nrr']").val() || null,
                    booking_ranking: $(this).find("input[name='booking_ranking']").val() || null,
                    booking_nrr: $(this).find("input[name='booking_nrr']").val() || null,
                };
                console.log("Row data is here::", rowData);
                allData.push(rowData);
            });

            if (allData.length === 0) {
                alert("No data to submit!");
                return;
            }

            $.ajax({
                url: "{% url 'hotel-ranking-api' %}?UserID=1&S_OID=3",  // ðŸ”¹ Replace with actual user and org IDs
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}" },
                contentType: "application/json",
                data: JSON.stringify(allData),
                success: function (response) {
                    alert("Ranking data saved successfully!");
                    location.reload();
                },
                error: function (xhr) {
                    console.error(xhr.responseText);
                    alert("Error saving data!");
                }
            });
        });
    });
</script>

{% endblock content %} 


