{% extends 'Warning/homebase.html' %}

{% load static %}
{% load encryption_filters %}

{% block content %}
<style>
    .modal#statusSuccessModal .modal-content, 
    .modal#statusErrorsModal .modal-content {
        border-radius: 30px;
    }
    .modal#statusSuccessModal .modal-content svg, 
    .modal#statusErrorsModal .modal-content svg {
        width: 100px; 
        display: block; 
        margin: 0 auto;
    }
    .modal#statusSuccessModal .modal-content .path, 
    .modal#statusErrorsModal .modal-content .path {
        stroke-dasharray: 1000; 
        stroke-dashoffset: 0;
    }
    .modal#statusSuccessModal .modal-content .path.circle, 
    .modal#statusErrorsModal .modal-content .path.circle {
        -webkit-animation: dash 0.9s ease-in-out; 
        animation: dash 0.9s ease-in-out;
    }
    .modal#statusSuccessModal .modal-content .path.line, 
    .modal#statusErrorsModal .modal-content .path.line {
        stroke-dashoffset: 1000; 
        -webkit-animation: dash 0.95s 0.35s ease-in-out forwards; 
        animation: dash 0.95s 0.35s ease-in-out forwards;
    }
    .modal#statusSuccessModal .modal-content .path.check, 
    .modal#statusErrorsModal .modal-content .path.check {
        stroke-dashoffset: -100; 
        -webkit-animation: dash-check 0.95s 0.35s ease-in-out forwards; 
        animation: dash-check 0.95s 0.35s ease-in-out forwards;
    }

    @-webkit-keyframes dash { 
        0% {
            stroke-dashoffset: 1000;
        }
        100% {
            stroke-dashoffset: 0;
        }
    }
    @keyframes dash { 
        0% {
            stroke-dashoffset: 1000;
        }
        100%{
            stroke-dashoffset: 0;
        }
    }
    @-webkit-keyframes dash { 
        0% {
            stroke-dashoffset: 1000;
        }
        100% {
            stroke-dashoffset: 0;
        }
    }
    @keyframes dash { 
        0% {
            stroke-dashoffset: 1000;}
        100% {
            stroke-dashoffset: 0;
        }
    }
    @-webkit-keyframes dash-check { 
        0% {
            stroke-dashoffset: -100;
        }
        100% {
            stroke-dashoffset: 900;
        }
    }
    @keyframes dash-check {
        0% {
            stroke-dashoffset: -100;
        }
        100% {
            stroke-dashoffset: 900;
        }
    }
    .box00{
        width: 100px;
        height: 100px;
        border-radius: 50%;
    }
</style>

<style>
    body{
        position: relative;
    }
    table thead tr th{
        background: #edf0fb !important;    }
    #ChangeBtn{
        position:fixed;
        bottom: 0;
        right: 0;
        background-color: white;
        width: 100%;
    }
    .select2-container, .dropdown-menu {
        z-index: 1000 !important; /* Less than navbar */
    }
    .text-primary {
        color: #3a4a93 !important;
    }

    .settings-icon span {
        background-color: #3a4a93;
        animation: none !important;
    }

    .select2-container, .dropdown-menu {
        z-index: 1000 !important; /* Less than navbar */
    }

    .table th {
        font-weight: bold !important;
        padding: 1rem 0.5rem !important;
    }
</style>

<div class="card pb-4">
    <div class="card-header mb-4" id="ChangeTitle">
        <h4 class="card-title text-uppercase fw-bold">Warning Employee List</h4>
    </div>
    <!-- <br> -->
    <div class="col-md-12">
        <form method="GET" class="row" style="padding-inline: 21px" id="FilterForm">
            <div class="m-1 col-md-4">
                <label for="organization" class="form-label">Organizations</label>
                {% if SessionOrganizationID == 3 %}
                    <!-- Show dropdown for Nile users -->
                    <select name="OrganizationID" id="organization" class="form-control select2">
                        <option value="All" {% if selectedOrganizationID == "All" %}selected{% endif %}>All</option>
                        {% for itm in orgs %}
                            <option value="{{ itm.OrganizationID }}" {% if itm.OrganizationID|stringformat:"s" == selectedOrganizationID %}selected{% endif %}>
                                {{ itm.OrganizationName }}
                            </option>
                        {% endfor %}
                    </select>
                {% else %}
                    <!-- Show only their own organization as readonly -->
                    <input type="hidden" name="OrganizationID" value="{{ SessionOrganizationID }}">
                    <input type="text" class="form-control" value="{{ orgs.0.OrganizationName }}" readonly>
                {% endif %}
            </div>

            <div class="m-1 col-md-1">
                <label for="EmployeeCode" class="form-label">Code</label>
                <input type="text" class="form-control EmployeeCode" id="EmployeeCode" name="EmployeeCode" value="">
            </div>

            <div class="m-1 col-md-2">
                <label for="Department" class="form-label">Department</label>
                <input type="text" class="form-control" id="Department" name="Department" list="DepartmentList" placeholder="Type Here">
                <datalist id="DepartmentList">
                    {% for dept in Departments_Dropdown %}
                        <option value="{{ dept }}"></option>
                    {% endfor %}
                </datalist>
            </div>

            <div class="m-1 col-md-2">
                <label for="Designation" class="form-label">Designation</label>
                <input type="text" class="form-control" id="Designation" name="Designation" list="DesignationList" placeholder="Type Here">
                <datalist id="DesignationList">
                    {% for des in Designations_Dropdown %}
                        <option value="{{ des }}">{{ des }}</option>
                    {% endfor %}
                </datalist>
            </div>

            <div class="col-md-1" style="margin-top:2.5rem;">
                <a href="{% url 'Warning_Employee_List' %}" class="btn btn-primary ml-3" style="padding-inline:15px;">
                    Clear
                </a>
            </div>
        </form>  
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            <table class="table table-striped table-striped" id="EmployeeListTable">
                <thead class="thead">
                    <tr class="">
                        <th>#</th>
                        <th>Employee Code</th>
                        <th>Employee Name</th>
                        {% comment %} <th>P_Org_ID</th>
                        <th>W_Org_ID</th>   {% endcomment %}
                        <th>Status</th>
                        <th>Department</th>
                        <th>Designation</th>
                        <th>Level</th>
                        <th>Reporting To Designation</th>
                        <th>Actions</th>

                    </tr>
                </thead>
                <tbody>
                    {% for Emp_Data in employee_data %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                            {{Emp_Data.EmployeeCode}} 
                         {% comment %} {{Emp_Data.EmpID}}  {% endcomment %}
                        </td>
                        <td>
                            {% if Emp_Data.FirstName %}{{Emp_Data.FirstName}}{% else %}{% endif %}
                            {% if Emp_Data.MiddleName %}{{Emp_Data.MiddleName}}{% else %}{% endif %}
                            {% if Emp_Data.LastName %}{{Emp_Data.LastName}}{% else %}{% endif %}
                        </td>
                        {% comment %} <td>{{Emp_Data.personal_OrganizationID}}</td>
                        <td>{{Emp_Data.work_OrganizationID}}</td>   {% endcomment %}
                        <td>{{Emp_Data.EmpStatus}}</td>
                        <td>{{Emp_Data.Department}}</td>
                        <td>{{Emp_Data.Designation}}</td>
                        <td>{{Emp_Data.Level}}</td>
                        <td>{{Emp_Data.ReportingtoDesignation}}</td>
                        <td>
                            <a class="btn btn-primary btn-sm open-warning-modal"
                                data-bs-toggle="modal"
                                data-bs-target="#warningModal"
                                data-empid="{{ Emp_Data.EmpID }}"
                                data-ecode="{{ Emp_Data.EmployeeCode }}"
                                data-department="{{ Emp_Data.Department }}"
                                data-orgid="{{ OrganizationID }}"
                                title="New Warning">New`
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center text-muted">No data available</td>
                    </tr>
                    {% endfor %}
                </tbody> 
            </table>
        </form>
    </div>
</div>



<a href="#ChangeTitle">
    <div class="settings-icon"> 
        <span data-bs-toggle="offcanvas" data-bs-target="#theme-settings-offcanvas" aria-controls="theme-settings-offcanvas" id="settingsicon">
            <i class="fa-solid fa-circle-arrow-up"></i>
        </span> 
    </div> 
</a>

<!-- Modals For Success and Error -->
<div class="container  p-5">
	<div class="row">
		<div class="modal fade" id="statusErrorsModal" tabindex="-1" role="dialog" data-bs-backdrop="static" data-bs-keyboard="false"> 
			<div class="modal-dialog modal-dialog-centered modal-sm" role="document"> 
				<div class="modal-content"> 
					<div class="modal-body text-center p-lg-4"> 
						<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 130.2 130.2">
							<circle class="path circle" fill="none" stroke="#3a4a93" stroke-width="6" stroke-miterlimit="10" cx="65.1" cy="65.1" r="62.1" /> 
							<line class="path line" fill="none" stroke="#3a4a93" stroke-width="6" stroke-linecap="round" stroke-miterlimit="10" x1="34.4" y1="37.9" x2="95.8" y2="92.3" />
							<line class="path line" fill="none" stroke="#3a4a93" stroke-width="6" stroke-linecap="round" stroke-miterlimit="10" x1="95.8" y1="38" x2="34.4" y2="92.2" /> 
						</svg> 
						<h4 class="text-danger mt-3">Error !!</h4> 
						{% comment %} <p class="mt-3" id="errorMessageText">Something went wrong while submitting the form.</p> {% endcomment %}
                        <p class="mt-3" id="errorMessageText">
                            {{ error_message|default:"Something went wrong while submitting the form." }}
                        </p>
						<button type="button" class="btn btn-sm mt-3 btn-danger" data-bs-dismiss="modal">Ok</button> 
					</div> 
				</div> 
			</div> 
		</div>

		<div class="modal fade" id="statusSuccessModal" tabindex="-1" role="dialog" data-bs-backdrop="static" data-bs-keyboard="false"> 
			<div class="modal-dialog modal-dialog-centered modal-sm" role="document"> 
				<div class="modal-content"> 
					<div class="modal-body text-center p-lg-4"> 
						<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 130.2 130.2">
							<circle class="path circle" fill="none" stroke="{% if 'deleted' in success_message|lower %}#ff0000{% else %}#3a4a93{% endif %}" stroke-width="6" stroke-miterlimit="10" cx="65.1" cy="65.1" r="62.1" />
							<polyline class="path check" fill="none" stroke="{% if 'deleted' in success_message|lower %}#ff0000{% else %}#3a4a93{% endif %}" stroke-width="6" stroke-linecap="round" stroke-miterlimit="10" points="100.2,40.2 51.5,88.8 29.8,67.5 " /> 
						</svg> 
						<h4 class="mt-3" style="color:{% if 'deleted' in success_message|lower %}#ff0000{% else %}#3a4a93{% endif %}">Congrats!</h4> 
						{% comment %} <p class="mt-3" id="successMessageText">Travel Details submitted successfully.</p> {% endcomment %}
                        <p class="mt-3 {% if 'deleted' in success_message|lower %}text-danger{% endif %}" id="successMessageText">
                            {{ success_message|default:"Details submitted successfully." }}
                        </p>
						<button type="button" class="btn btn-sm mt-3 {% if 'deleted' in success_message|lower %}btn-danger{% else %}btn-primary{% endif %}" data-dismiss="modal">Ok</button> 
					</div> 
				</div> 
			</div> 
		</div>
	</div>
</div>


<div class="modal fade" id="warningModal" tabindex="-1" role="dialog" aria-labelledby="warningModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header d-flex justify-content-between">
                <h5 class="modal-title" id="warningModalLabel">Select Warning Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <a id="verbal-link" class="btn btn-secondary mb-2">Verbal Warning</a>
                <a id="written-link" class="btn btn-warning mb-2">Written Warning</a>
                <a id="final-link" class="btn btn-danger mb-2">Final Warning</a>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Initialize select2
        $('.select2').select2();

        // Submit form on any select2 change
        $('#FilterForm #organization').on('change', function () {
            $('#FilterForm').submit();
        });
    });
</script>

<script>
    $(document).ready(function () {
        $('.open-warning-modal').on('click', function () {
            let empID = $(this).data('empid');
            let empCode = $(this).data('ecode');
            let department = $(this).data('department');
            let orgID = $(this).data('orgid');

            console.log("empID::", empID)
            console.log("empCode::", empCode)
            console.log("department::", department)
            console.log("orgID::", orgID)

            // Construct URLs dynamically
            let baseVerbal = "{% url 'VerbalWarning' %}";
            let baseWritten = "{% url 'Written_Warning' %}";
            let baseFinal = "{% url 'FinalWarning' %}";

            let queryParams = `?EC=${empCode}&EmpID=${empID}&DepartmentName=${encodeURIComponent(department)}&OID=${orgID}&Page=Warning_Employee_List`;

            $('#verbal-link').attr('href', baseVerbal + queryParams);
            $('#written-link').attr('href', baseWritten + queryParams);
            $('#final-link').attr('href', baseFinal + queryParams);
        });
    });
</script>

<script>
    
    document.addEventListener('DOMContentLoaded', function () {
        const empCodeInput = document.getElementById('EmployeeCode');
        // const reportingToInput = document.getElementById('ReportingToDesignation');
        const departmentInput = document.getElementById('Department');
        const designationInput = document.getElementById('Designation');

        const table = document.getElementById('EmployeeListTable');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        function filterTable() {
            const empCodeValue = empCodeInput.value.trim().toLowerCase();
            // const reportingToValue = reportingToInput.value.trim().toLowerCase();
            const departmentValue = departmentInput.value.trim().toLowerCase();
            const designationValue = designationInput.value.trim().toLowerCase();

            let srNo = 1;

            rows.forEach((row) => {
                const cells = row.querySelectorAll('td');

                const empCode = cells[1]?.textContent.trim().toLowerCase();
                const department = cells[4]?.textContent.trim().toLowerCase();
                const designation = cells[5]?.textContent.trim().toLowerCase();
                // const reportingTo = cells[9]?.textContent.trim().toLowerCase();

                const matches =
                    (!empCodeValue || empCode.includes(empCodeValue)) &&
                    (!departmentValue || department.includes(departmentValue)) &&
                    (!designationValue || designation.includes(designationValue))
                    // (!reportingToValue || reportingTo.includes(reportingToValue));

                row.style.display = matches ? '' : 'none';

                // Renumber the visible rows
                if (matches) {
                    cells[0].textContent = srNo++;
                }
            });
        }

        empCodeInput.addEventListener('input', filterTable);
        // reportingToInput.addEventListener('input', filterTable);
        departmentInput.addEventListener('input', filterTable);
        designationInput.addEventListener('input', filterTable);
    });
</script>





{% comment %} Modal Show {% endcomment %}
<script>
    window.addEventListener("load", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const isSuccess = urlParams.get("Success"); // Note: 'Success' is capitalized in your URL
        const message = urlParams.get("message");
        // const action = urlParams.get("action");

        if (isSuccess && ['true', '1', 'yes'].includes(isSuccess.toLowerCase())) {
            const successModalElement = document.getElementById("statusSuccessModal");
            const successText = document.getElementById("successMessageText");

            if (successModalElement) {
                if (successText && message) {
                    successText.textContent = decodeURIComponent(message);
                }

                const successModal = new bootstrap.Modal(successModalElement);
                successModal.show();
            }

            // ✅ Remove only specific params from URL
            urlParams.delete("Success");
            // urlParams.delete("success");  // optional, covers both cases
            urlParams.delete("message");
            // urlParams.delete("action");
    
            const newQuery = urlParams.toString();
            const newUrl = window.location.pathname + (newQuery ? "?" + newQuery : "");
            window.history.replaceState({}, document.title, newUrl); 
        }
    });
</script>

{% endblock %}
