{% extends "ceodashboard/homebase.html" %}
{% block content %}
{% load static %}

<style>
    .welcome-info .welcome-img img {
        width: 70px;
        height: auto;
        border-radius: 50%;
    }
    .welcome-info .welcome-img{
        width: 15%;
        gap: 10px;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        display: flex;
    }
    .welcome-btn .btn {
        font-size: 15px;
        font-weight: 500;
        color: white;
        background: #3a4a93;
        border: 1px solid #3a4a93;
        border-radius: 5px;
        line-height: normal;
        padding: 9px 12px;
        min-width: 110px;
    }

    .welcome-content{
        width: 45%;
    }


    .round-user-icon{
        display: inline-flex;
        align-items: center;
        justify-content: center;
      /*  background-color: #3a4a93;  Blue background */
        background-color: #b1b3bb; /* Blue background */
        color: white;
        border-radius: 50%; /* Makes it round */
        width: 25px;
        height: 25px;
    }
    .round-user-icon i{
        font-size: 13px;
    }

    .profile-img-wrap {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .profile-view .profile-img-wrap img{
        border-radius: 50%;
        height: 80px;
        width: 80px;
    }
</style>

<style>
    .CommonScrolling{
        max-height: 450px;
        overflow-y: scroll;
    }

    .employee-dashboard-container a {
        color: #515f9f !important;
    }

    #ViewProfile{
        color:white !important;
    }

    .Summery-cards{
        padding-inline: 30px;
    }

    .Custom-Border{
        border-bottom: 0.3px solid #cdc9c9;
    }
</style>

<style>
    .card-loader {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #ffffffcc;
        z-index: 10;
        justify-content: center;
        align-items: center;
    }

    .text-primary-spinner{
        color: #3a4a93;
    }

    .BorderBottom{
        padding-bottom: 10px;
        border-bottom: 1px solid #dedede;
    }

    .card-title{
        font-size: 16px !important;
    }

    .fullName{
        font-size: 14px !important;
    }

    .EmpDesignation{
        font-size: 12px !important;
    }
</style>



<div class="employee-dashboard-container">
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-sm-12" >
                <!-- Loader -->
                <div class="profile-view" style="position: relative;" id="profile-card">
                    <!-- ðŸ‘‡ LOADER INSIDE profile-view -->
                    <div class="card-loader">
                        <div>
                            <div class="spinner-border text-primary-spinner" role="status" style="width: 2.5rem; height: 2.5rem;"></div>
                            <div style="margin-top: 0.5rem; font-weight: bold; color: #3a4a93;">Loading...</div>
                        </div>
                    </div>

                    <div class="profile-img-wrap">
                            <div class="profile-img">
                                <a>
                                    <img id="emp-profile-image" src="/static/Images/avatarimg.webp" alt="Profile Image Preview">
                                </a>
                                <a href="{% url 'Employee_Personal_Dashboard' %}"  class="btn btn-sm btn-primary mt-2 rounded-2" id="ViewProfile">Dashboard</a>
                            </div>
                        </div>
                        <div class="profile-basic">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="profile-info-left">
                                        <h3 class="user-name m-t-0 mb-0" id="emp-full-name"></h3>
                                        <ul class="personal-info mt-2">
                                            <li>
                                                <div class="title">Designation:</div>
                                                <div class="text" id="emp-designation"></div>
                                            </li>
                                            <li>
                                                <div class="title">Department:</div>
                                                <div class="text" id="emp-department"></div>
                                            </li>
                                            <li>
                                                <div class="title">Reports to:</div>
                                                <div class="text" id="emp-reporting-to"></div>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <ul class="personal-info" style="border-right: 2px dashed #D3D3D4;">
                                        <li>
                                            <div class="title">Code:</div>
                                            <div class="text" id="emp-code"></div>
                                        </li>
                                        <li class="d-flex align-items-center">
                                            <div class="title">Status:</div>
                                            <div class="text" id="emp-status"></div>
                                        </li>
                                        <li>
                                            <div class="title">DOJ:</div>
                                            <div class="text" id="emp-doj"></div>
                                        </li>
                                        <li>
                                            <div class="title">Tenure:</div>
                                            <div class="text" id="emp-tenure"></div>
                                        </li>
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <ul class="personal-info">
                                    <li>
                                        <div class="title">Phone:</div>
                                        <div class="text" id="emp-phone"></div>
                                    </li>
                                    <li>
                                        <div class="title">Email:</div>
                                        <div class="text" id="emp-email"></div>
                                    </li>
                                    <li>
                                        <div class="title">Birthday:</div>
                                        <div class="text" id="emp-birthday"></div>
                                    </li>

                                    <li>
                                        <div class="title">Gender:</div>
                                        <div class="text" id="emp-gender"></div>
                                    </li>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> 


    <div class="card">
        <div class="card-body">
            <div class="col-md-12">
                <div class="row">
                    <div class="d-flex justify-content-between Summery-cards" id="Summery-card" style="position: relative;">

                        <!-- Loader ----- -->
                        <div class="card-loader">
                        <div>
                            <div class="spinner-border text-primary-spinner" role="status" style="width: 2.5rem; height: 2.5rem;"></div>
                            <div style="margin-top: 0.5rem; font-weight: bold; color: #3a4a93;">Loading...</div>
                        </div>
                        </div>
                        <!-- End Loader -->

                        <div class="d-flex">
                            <div class="">
                                <h3 class="card-title d-flex align-items-center gap-2">
                                    <p class="text-uppercase BorderBottom"> <strong>Employee</strong> </p> 
                                </h3>
                                <div>
                                    <p class="d-flex justify-content-between">Total Employee&nbsp;&nbsp;<span id="TotalEmployee"></span></p>
                                    <p class="d-flex justify-content-between">Resigned<span id="Resigned"></span></p>
                                </div>
                            </div>
                        </div> 

                        <!-- Example --- -->
                        <div class="d-flex">
                            <div class="">
                                <h3 class="card-title BorderBottom">
                                    {% comment %} <p class="round-user-icon">
                                        <i class="fa-solid fa-user"></i>
                                    </p>  {% endcomment %}
                                    <p class="text-uppercase "> <strong>Employment Status</strong> </p> 
                                </h3>
                                <div >
                                    <p class="d-flex justify-content-between">Confirmed<span id="EmpStatusConfirmedCount"></span></p>
                                    <p class="d-flex justify-content-between">Not Confirmed<span id="EmpStatusNotConfirmedCount"></span></p>
                                    <p class="d-flex justify-content-between">On Probation<span id="EmpStatusOnProbationCount"></span></p>
                                </div>
                            </div>
                        </div>

                        <!-- Example --- -->
                        <div class="d-flex">
                            <div class="">
                                <h3 class="card-title BorderBottom">
                                    {% comment %} <p class="round-user-icon">
                                        <i class="fa-solid fa-user"></i>
                                    </p>  {% endcomment %}
                                    <p class="text-uppercase"> <strong>PADP Summery</strong> </p> 
                                </h3>
                                <div >
                                    <p class="d-flex justify-content-between">Approved<span id="PADP_Approved"></span></p>
                                    <p class="d-flex justify-content-between">Pending<span id="PADP_Pending"></span></p>
                                    <p class="d-flex justify-content-between">In Process<span id="PADP_InProcess"></span></p>
                                </div>
                            </div>
                        </div>

                        <!-- Example --- -->
                        <div class="d-flex">
                            <div class="">
                                <h3 class="card-title BorderBottom">
                                    {% comment %} <p class="round-user-icon">
                                        <i class="fa-solid fa-user"></i>
                                    </p>  {% endcomment %}
                                    <p class="text-uppercase"> <strong>Leave Applications</strong> </p> 
                                </h3>
                                <div>
                                    <p class="d-flex justify-content-between">Approved<span id="LeaveApproved"></span></p>
                                    <p class="d-flex justify-content-between">Pending<span id="LeavePending"></span></p>
                                </div>
                            </div>
                        </div>

                        <!-- Example --- -->
                        <div class="d-flex">
                            <div class="">
                                <h3 class="card-title BorderBottom">
                                    {% comment %} <p class="round-user-icon">
                                        <i class="fa-solid fa-user"></i>
                                    </p>  {% endcomment %}
                                    <p class="text-uppercase"> <strong>Open Positions</strong> </p> 
                                </h3>
                                <div>
                                    <p class="d-flex justify-content-between">Opened<span id="Opened"></span></p>
                                    <p class="d-flex justify-content-between">Overdue<span id="Overdue"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mega cards -->
     <!-- Birthday cards -->
    <div class="row">
        <div class="col-md-3 d-flex">
            <div class="card profile-box flex-fill" id="Birthday_Card" style="position: relative;">
                <!-- Loader Code -->
                <div class="card-loader">
                    <div>
                        <div class="spinner-border text-primary-spinner" role="status" style="width: 2.5rem; height: 2.5rem;"></div>
                        <div style="margin-top: 0.5rem; font-weight: bold; color: #3a4a93;">Loading...</div>
                    </div>
                </div>
                <!-- // Loader Code -->

                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <h3 class="card-title">Upcoming Birthday ({% now "F" %}) </h3>
                        <h3 class="card-title" id="UpcomingBirthdayCount"></h3>
                    </div>
                    <div class="d-flex flex-column gap-3 CommonScrolling" id="Upcoming-Birthday-Container"></div>
                </div>
            </div>
        </div>

        
        <!--  Upcoming Employee Work Anniversary -->
        <div class="col-md-3 d-flex">
            <div class="card profile-box flex-fill" id="Anniversary_Card" style="position: relative;">
                <!-- Loader Code -->
                <div class="card-loader">
                    <div>
                        <div class="spinner-border text-primary-spinner" role="status" style="width: 2.5rem; height: 2.5rem;"></div>
                        <div style="margin-top: 0.5rem; font-weight: bold; color: #3a4a93;">Loading...</div>
                    </div>
                </div>
                <!-- // Loader Code -->

                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <h3 class="card-title">Work Anniversary ({% now "F" %}) </h3>
                        <h3 class="card-title" id="UpcomingAnniversaryCount"></h3>
                    </div>
                    <div class="d-flex flex-column gap-3 CommonScrolling" id="Upcoming-Anniversary-Container"></div>
                </div>
            </div>
        </div>

        <!-- Upcoming PADP -->
        <div class="col-md-3 d-flex">
            <div class="card profile-box flex-fill" id="Upcoming_PADP" style="position: relative;">
                <!-- Loader Code -->
                <div class="card-loader">
                    <div>
                        <div class="spinner-border text-primary-spinner" role="status" style="width: 2.5rem; height: 2.5rem;"></div>
                        <div style="margin-top: 0.5rem; font-weight: bold; color: #3a4a93;">Loading...</div>
                    </div>
                </div>
                 <!-- // Loader Code -->
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <h3 class="card-title">Upcoming PADP</h3>
                        <h3 class="card-title" id="UpcomingPADPCount"></h3>
                    </div>
                    <div class="d-flex flex-column gap-3 CommonScrolling" id="UpcomingPADP_Container"></div>
                </div>
            </div>
        </div>

        <!-- F&F In process -->
        <div class="col-md-3 d-flex">
            <div class="card profile-box flex-fill" id="FNF_Process" style="position: relative;">
                <!-- Loader Code -->
                <div class="card-loader">
                    <div>
                        <div class="spinner-border text-primary-spinner" role="status" style="width: 2.5rem; height: 2.5rem;"></div>
                        <div style="margin-top: 0.5rem; font-weight: bold; color: #3a4a93;">Loading...</div>
                    </div>
                </div>
                 <!-- // Loader Code -->

                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <h3 class="card-title">F&F In Process</h3>
                        <h3 class="card-title" id="FNFInProcessCount"></h3>
                    </div>
                    <div class="d-flex flex-column gap-3 CommonScrolling" id="FNF-Process-container"></div>
                </div>
            </div>
        </div>




        <!--  Pending Confirmation Letter -->
        <div class="col-md-3 d-flex">
            <div class="card profile-box flex-fill" id="Pending_Confirmation_Letter">
                <!-- Loader Code -->
                <div class="card-loader">
                    <div>
                        <div class="spinner-border text-primary-spinner" role="status" style="width: 2.5rem; height: 2.5rem;"></div>
                        <div style="margin-top: 0.5rem; font-weight: bold; color: #3a4a93;">Loading...</div>
                    </div>
                </div>
                <!-- // Loader Code -->

                <div class="card-body">
                     <div class="d-flex justify-content-between">
                        <h3 class="card-title">Pending Confirmation Letter</h3>
                        <h3 class="card-title" id="PendingConfirmationLetterCount"></h3>
                    </div>
                    <div class="d-flex flex-column gap-3 CommonScrolling" id="PendingConfirmationLetter-container"></div>
                </div>
            </div>
        </div>


        <!-- Pending Appointment Letter -->
        <div class="col-md-3 d-flex">
            <div class="card profile-box flex-fill"  id="Pending_Appointment_Letter" style="position: relative;">
                <!-- Loader Code -->
                <div class="card-loader">
                    <div>
                        <div class="spinner-border text-primary-spinner" role="status" style="width: 2.5rem; height: 2.5rem;"></div>
                        <div style="margin-top: 0.5rem; font-weight: bold; color: #3a4a93;">Loading...</div>
                    </div>
                </div>
                <!-- // Loader Code -->

                <div class="card-body">
                     <div class="d-flex justify-content-between">
                        <h3 class="card-title">Pending Appointment Letter</h3>
                        <h3 class="card-title" id="PendingAppointmentLetterCount"></h3>
                    </div>
                    <div class="d-flex flex-column gap-3 CommonScrolling" id="PendingAppointmentLetter-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>




<script>
    function showLoader(cardId) {
        const card = document.getElementById(cardId);
        const loader = card.querySelector(".card-loader");
        loader.style.display = "flex";
    }

    function hideLoader(cardId) {
        const card = document.getElementById(cardId);
        const loader = card.querySelector(".card-loader");
        loader.style.display = "none";
    }
</script>

<script>
    async function loadDashboard() {
        fetchAndUpdateProfile();
        fetchAndUpdateSummary();
        fetchAndUpdateBirthday();
        fetchAndUpdateUpcomingPADP();
        fetchAndUpdateAppointmentLetter();
        fetchAndUpdateFNFProcess();
        fetchAndUpdateAnniversary();
    }

    document.addEventListener("DOMContentLoaded", loadDashboard);

    // Profile
    async function fetchAndUpdateProfile() {
        showLoader("profile-card");
        try {
            const res = await fetch("/dashboard/api/Employee_Card_Details_Api/");
            const data = await res.json();
            updateProfile(data);
        } catch (err) {
            console.error("Profile error:", err);
        } finally {
            hideLoader("profile-card");
        }
    }

    // Summary
    async function fetchAndUpdateSummary() {
        showLoader("Summery-card");
        showLoader("Pending_Confirmation_Letter");
        try {
            const res = await fetch("/dashboard/api/HR_Dashboard_Summary_Api/");
            const data = await res.json();
            UpdateEmployeeSummery(data);
        } catch (err) {
            console.error("Summary error:", err);
        } finally {
            hideLoader("Summery-card");
            hideLoader("Pending_Confirmation_Letter");
        }
    }

    // Birthday
    async function fetchAndUpdateBirthday() {
        showLoader("Birthday_Card");
        try {
            const res = await fetch("/dashboard/api/Upcoming_Birthday_Api/");
            const data = await res.json();
            UpdateBirthdayData(data);
        } catch (err) {
            console.error("Birthday error:", err);
        } finally {
            hideLoader("Birthday_Card");
        }
    }

    // Upcoming Anniversary
    async function fetchAndUpdateAnniversary() {
        showLoader("Anniversary_Card");
        try {
            const res = await fetch("/dashboard/api/Upcoming_Work_Anniversary_Api/");
            const data = await res.json();
            UpdateAnniversaryData(data);
        } catch (err) {
            console.error("Anniversary error:", err);
        } finally {
            hideLoader("Anniversary_Card");
        }
    }

    // Upcoming PADP
    async function fetchAndUpdateUpcomingPADP() {
        showLoader("Upcoming_PADP");
        try {
            const res = await fetch("/dashboard/api/Upcoming_PADP_API/");
            const data = await res.json();
            UpdateUpcomingPADP(data);
        } catch (err) {
            console.error("PADP error:", err);
        } finally {
            hideLoader("Upcoming_PADP");
        }
    }

    // Pending Appointment Letter
    async function fetchAndUpdateAppointmentLetter() {
        showLoader("Pending_Appointment_Letter");
        try {
            const res = await fetch("/dashboard/api/Pending_Appointment_Letter_Api/");
            const data = await res.json();
            UpdateAppointmentLetter(data);
        } catch (err) {
            console.error("Appointment Letter error:", err);
        } finally {
            hideLoader("Pending_Appointment_Letter");
        }
    }

    // FNF Process
    async function fetchAndUpdateFNFProcess() {
        showLoader("FNF_Process");
        try {
            const res = await fetch("/dashboard/api/FNF_In_Process_API/");
            const data = await res.json();
            UpdateFNFInProcess(data);
        } catch (err) {
            console.error("FNF Process error:", err);
        } finally {
            hideLoader("FNF_Process");
        }
    }
</script>

<!-- Profile Card -- Employee Information Card -->
<script>
    function updateProfile(data) {
        const emp = data.Emobj;

        document.getElementById("emp-full-name").textContent = `${emp.FullName || ''}`;
        document.getElementById("emp-designation").textContent = `${emp.Designation || ''} (${emp.Level || ''})`;
        document.getElementById("emp-department").textContent = emp.Department || '';
        document.getElementById("emp-reporting-to").textContent = emp.ReportingtoDesignation || '';
        document.getElementById("emp-code").textContent = emp.EmployeeCode || '';
        document.getElementById("emp-status").textContent = emp.EmpStatus || '';
        document.getElementById("emp-doj").textContent = formatDate(emp.DateofJoining);
        document.getElementById("emp-tenure").textContent = emp.TenureTillToday || '';
        document.getElementById("emp-phone").textContent = emp.MobileNumber || '';
        document.getElementById("emp-email").textContent = emp.EmailAddress || '';
        document.getElementById("emp-birthday").textContent = formatBirthday(emp.DateofBirth);
        document.getElementById("emp-gender").textContent = emp.Gender || '';

        const profileImg = document.getElementById("emp-profile-image");
        if (emp.ProfileImageFileName) {
            profileImg.src = `/HumanResources/Humanview_file/?ID=${emp.EmpID}&model=EmployeePersonalDetails`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return "";
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function formatBirthday(dateStr) {
            if (!dateStr) return "";
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { month: 'long', day: 'numeric' });
        }
    }

    // <!-- /Profile Card Ends here -->


    // <!-- Second Card -- Employee Summery -->
    function UpdateEmployeeSummery(data) {

        document.getElementById("Resigned").textContent = data.resigned_count ?? '';
        document.getElementById("TotalEmployee").textContent = data.TotalEmployee ?? '';
        console.log("TotalEmployee Data::", data.TotalEmployee)

        // Padp -- Approved, Pending, Returned
        document.getElementById("PADP_Approved").textContent = data.approved_apadp ?? '';
        document.getElementById("PADP_Pending").textContent = data.pending_apadp ?? '';
        document.getElementById("PADP_InProcess").textContent = data.submitted_apadp ?? '';


        // Leave Status Count
        document.getElementById("LeavePending").textContent = data.pending_leave ?? '';
        document.getElementById("LeaveApproved").textContent = data.approved_leave ?? '';

        // Employee Status
        document.getElementById("EmpStatusConfirmedCount").textContent = data.Confirmed_Employee_Status ?? '';
        document.getElementById("EmpStatusNotConfirmedCount").textContent = data.Not_Confirmed_Employee_Status ?? '';
        document.getElementById("EmpStatusOnProbationCount").textContent = data.On_Probation_Employee_Status ?? '';


        // Open Position Count
        document.getElementById("Opened").textContent = data.total_openings ?? '';
        document.getElementById("Overdue").textContent = data.older_than_30_days ?? '';
        // console.log("TotalEmployee Data::", data.TotalEmployee)

        
        // Pending Confirmation Letter Count
        document.getElementById("PendingConfirmationLetterCount").textContent = data.not_confirmed_count ?? '';


        // Pending Confirmation Letter
        const PendingConfirmationLetter = document.getElementById('PendingConfirmationLetter-container');

        // Clear previous content if needed
        PendingConfirmationLetter.innerHTML = '';

        // Check if Pending Confirmation Letter has entries
        if (!data.not_confirmed_data || data.not_confirmed_data.length === 0) {
            PendingConfirmationLetter.innerHTML = `<p class="text-muted">No data available</p>`;
        } else {
            data.not_confirmed_data.forEach(function(employee) {
                // Build full name with spaces, ignoring empty middle names
                let fullName = employee.FirstName + 
                            (employee.MiddleName ? ' ' + employee.MiddleName : '') + 
                            (employee.LastName ? ' ' + employee.LastName : '');

                // Build the HTML block
                let html = `
                    <div class="feed-element d-flex align-items-center gap-3 mt-2 Custom-Border">
                        <div class="media-body ml-1">
                            <a class="float-left fullName">
                                <strong>${fullName}</strong>
                            </a> <br>
                            <span class="EmpDesignation">${employee.Designation}</span>
                        </div>
                    </div>
                `;
        
                PendingConfirmationLetter.innerHTML += html;
            });
        }
    };

    // <!-- // Emoloyee_Summery -->

    // <!--  Birthday Data  -->
    function UpdateBirthdayData(data) {

        // fetch("/HR_Dashboard/api/Upcoming_Birthday_Api/")
        document.getElementById("UpcomingBirthdayCount").textContent = data.birthday_count ?? '';

        // Birthday Data 
        const birthdayContainer = document.getElementById('Upcoming-Birthday-Container');

        // Clear previous content if needed
        birthdayContainer.innerHTML = '';

        // Check if birthday_data has entries
        if (!data.birthday_data || data.birthday_data.length === 0) {
            birthdayContainer.innerHTML = `<p class="text-muted">No data available</p>`;
        } else {
            data.birthday_data.forEach(function(employee) {
                let editUrl = `/HumanResources/EditEmployee/?EmpID=${employee.EmpID}`;

                // Birthday date 
                let Birthday_Date = employee.DateofBirth;
                let formatted_Birthday = formatBirthday(Birthday_Date);
                let daysLeft = getDaysUntilBirthday(Birthday_Date);
                let birthdayMessage = getBirthdayStatus(Birthday_Date);
                console.log("Birthday_Date:: ", formatted_Birthday)

                // Build full name with spaces, ignoring empty middle names
                let fullName = employee.FirstName + 
                            (employee.MiddleName ? ' ' + employee.MiddleName : '') + 
                            (employee.LastName ? ' ' + employee.LastName : '');

                // Build the HTML block
                let html = `
                    <div class="feed-element d-flex mt-2 Custom-Border" style="width: 100%;">
                        <div class="media-body ml-1" style="flex: 0 0 60%;">
                            <a class="float-left fullName" href="${editUrl}">
                                <strong>${fullName}</strong>
                            </a> <br>
                            <span class="EmpDesignation">${employee.Designation}</span>
                        </div>
                        <div class="media-body ml-1 d-flex flex-column align-items-end" style="flex: 0 0 40%;">
                            <span class="fullName">${formatted_Birthday}</span>
                            <span class="EmpDesignation ${birthdayMessage.class}" id="birthdayMessage">${birthdayMessage.message}</span>
                        </div>
                    </div>
                `;

                birthdayContainer.innerHTML += html;
            });
        }

        function formatBirthday(dateStr) {
            if (!dateStr) return "";
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { month: 'long', day: 'numeric' });
        }

        function getDaysUntilBirthday(dateString) {
            if (!dateString) return null;

            const today = new Date();
            const birthDate = new Date(dateString);

            // Set birthday to this year
            let nextBirthday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());

            // If birthday this year has already passed, set to next year
            if (nextBirthday < today) {
                nextBirthday.setFullYear(today.getFullYear() + 1);
            }

            // Calculate difference in milliseconds
            const diffTime = nextBirthday - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // Convert to days

            return diffDays;
        }

        function getBirthdayStatus(dateString) {
            if (!dateString) return null;

            const today = new Date();
            const birthDate = new Date(dateString);

            const currentYear = today.getFullYear();
            const thisYearBirthday = new Date(currentYear, birthDate.getMonth(), birthDate.getDate());

            const birthdayMessage_text = document.getElementById('birthdayMessage');

            // Clear time components for accurate comparison
            thisYearBirthday.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);

            const msInDay = 1000 * 60 * 60 * 24;
            const diff = Math.ceil((thisYearBirthday - today) / msInDay);

            if (diff === 0) {
                return { message: "Birthday is today!", class: "text-success" };
            } else if (diff > 0) {
                return { message: `${diff} day's left`, class: "text-warning" };
            } else {
                return { message: `Passed ${Math.abs(diff)} day's ago`, class: "text-danger" };
            }
        }

        // Example usage:
        // let Birthday_Date = employee.DateofBirth; // e.g., "2003-06-18"
        // let birthdayMessage = getBirthdayStatus(Birthday_Date);
        // console.log(birthdayMessage);


    };

    // <!--  // Birthday Data  -->

    // <!-- Upcoming Anniversary -->
    function UpdateAnniversaryData(data) {

        console.log("the Anniversary data is here::", data)

        // fetch("/HR_Dashboard/api/Upcoming_Anniversary_Api/")
        document.getElementById("UpcomingAnniversaryCount").textContent = data.anniversary_count ?? '';

        // Anniversary Data 
        const AnniversaryContainer = document.getElementById('Upcoming-Anniversary-Container');

        // Clear previous content if needed
        AnniversaryContainer.innerHTML = '';

        // Check if Anniversary_data has entries
        if (!data.anniversary_data || data.anniversary_data.length === 0) {
            AnniversaryContainer.innerHTML = `<p class="text-muted">No data available</p>`;
        } else {
            data.anniversary_data.forEach(function(employee) {
                let editUrl = `/HumanResources/EditEmployee/?EmpID=${employee.EmpID}`;

                // Anniversary date 
                let Anniversary_Date = employee.DateofJoining;
                let formatted_Anniversary = formatAnniversary(Anniversary_Date);
                let daysLeft = getDaysUntilAnniversary(Anniversary_Date);
                let AnniversaryMessage = getAnniversaryStatus(Anniversary_Date);
                // console.log("Anniversary_Date:: ", formatted_Anniversary)

                // Build full name with spaces, ignoring empty middle names
                // let fullName = employee.FirstName + 
                //             (employee.MiddleName ? ' ' + employee.MiddleName : '') + 
                //             (employee.LastName ? ' ' + employee.LastName : '');

                // Build the HTML block
                let html = `
                    <div class="feed-element d-flex mt-2 Custom-Border" style="width: 100%;">
                        <div class="media-body ml-1" style="flex: 0 0 60%;">
                            <a class="float-left fullName" href="${editUrl}">
                                <strong>${employee.EmpName}</strong>
                            </a> <br>
                            <span class="EmpDesignation">${employee.Designation}</span>
                        </div>
                        <div class="media-body ml-1 d-flex flex-column align-items-end" style="flex: 0 0 40%;">
                            <span class="fullName">${formatted_Anniversary}</span>
                            <span class="EmpDesignation ${AnniversaryMessage.class}" id="AnniversaryMessage">${AnniversaryMessage.message}</span>
                        </div>
                    </div>
                `;

                AnniversaryContainer.innerHTML += html;
            });
        }

        function formatAnniversary(dateStr) {
            if (!dateStr) return "";
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { month: 'long', day: 'numeric' });
        }

        function getDaysUntilAnniversary(dateString) {
            if (!dateString) return null;

            const today = new Date();
            const AnniversaryDate = new Date(dateString);

            // Set Anniversary to this year
            let nextAnniversary = new Date(today.getFullYear(), AnniversaryDate.getMonth(), AnniversaryDate.getDate());

            // If Anniversary this year has already passed, set to next year
            if (nextAnniversary < today) {
                nextAnniversary.setFullYear(today.getFullYear() + 1);
            }

            // Calculate difference in milliseconds
            const diffTime = nextAnniversary - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // Convert to days

            return diffDays;
        }

        function getAnniversaryStatus(dateString) {
            if (!dateString) return null;

            const today = new Date();
            const AnniversaryDate = new Date(dateString);

            const currentYear = today.getFullYear();
            const thisYearAnniversary = new Date(currentYear, AnniversaryDate.getMonth(), AnniversaryDate.getDate());

            const AnniversaryMessage_text = document.getElementById('AnniversaryMessage');

            // Clear time components for accurate comparison
            thisYearAnniversary.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);

            const msInDay = 1000 * 60 * 60 * 24;
            const diff = Math.ceil((thisYearAnniversary - today) / msInDay);

            if (diff === 0) {
                return { message: "Anniversary is today!", class: "text-success" };
            } else if (diff > 0) {
                return { message: `${diff} day's left`, class: "text-warning" };
            } else {
                return { message: `Passed ${Math.abs(diff)} day's ago`, class: "text-danger" };
            }
        }

        // Example usage:
        // let Anniversary_Date = employee.DateofAnniversary; // e.g., "2003-06-18"
        // let AnniversaryMessage = getAnniversaryStatus(Anniversary_Date);
        // console.log(AnniversaryMessage);


    };

    // <!--  // Upcoming Anniversary  -->


    // <!-- Upcoming PADP -->
    function UpdateUpcomingPADP(data) {

        // PADP Count
        document.getElementById("UpcomingPADPCount").textContent = data.upcoming_padp_count ?? '';

        // Upcoming PADP
        const Upcoming_PADP_Container = document.getElementById('UpcomingPADP_Container');

        // Clear previous content if needed
        Upcoming_PADP_Container.innerHTML = '';

        // Check if Upcoming PADP has entries
        if (!data.upcoming_padp_data || data.upcoming_padp_data.length === 0) {
            Upcoming_PADP_Container.innerHTML = `<p class="text-muted">No data available</p>`;
        } else {
            data.upcoming_padp_data.forEach(function(employee) {
                // let editUrl = `/HumanResources/EditEmployee/?EmpID=${employee.EncryptedEmpID}`;  // new
                let editUrl = `/HumanResources/EditEmployee/?EmpID=${employee.EmpID}`; 

                // console.log(`Employee id is here: ${employee.EmpID}`)

                // Build full name with spaces, ignoring empty middle names
                let fullName = employee.Name ?? '';

                // Build the HTML block
                let html = `
                    <div class="feed-element d-flex align-items-center gap-3 mt-2 Custom-Border">
                        <div class="media-body ml-1">
                            <a class="float-left fullName" href="${editUrl}">
                                <strong>${fullName}</strong>
                            </a> <br>
                            <span class="EmpDesignation">${employee.Designation}</span>
                        </div>
                    </div>
                `;
        
                Upcoming_PADP_Container.innerHTML += html;
            });
        }
    };

    // <!-- // Upcoming PADP -->

    // <!--  Pending Appointment Letter  -->
    function UpdateAppointmentLetter(data) {

        // Pending Appointment Letter Count
        document.getElementById("PendingAppointmentLetterCount").textContent = data.unmatched_count ?? '';

        // Appointment_Letter_container
        const Appointment_Letter_container = document.getElementById('PendingAppointmentLetter-container');

        // Clear previous content if needed
        Appointment_Letter_container.innerHTML = '';

        // Check if Appointment_Letter
        if (!data.unmatched_employees || data.unmatched_employees.length === 0) {
            Appointment_Letter_container.innerHTML = `<p class="text-muted">No data available</p>`;
        } else {
            data.unmatched_employees.forEach(function(employee) {

                // Build full name with spaces, ignoring empty middle names
                let fullName = employee.FirstName + 
                            (employee.MiddleName ? ' ' + employee.MiddleName : '') + 
                            (employee.LastName ? ' ' + employee.LastName : '');

                // Build the HTML block
                let html = `
                    <div class="feed-element d-flex align-items-center gap-3 mt-2 Custom-Border">
                        <div class="media-body ml-1">
                            <a class="float-left fullName">
                                <strong>${fullName}</strong>
                            </a> <br>
                            <span class="EmpDesignation">${employee.Designation}</span>
                        </div>
                    </div>
                `;

                // Append to container
                Appointment_Letter_container.innerHTML += html;
            });
        }
    };

    // <!-- // Pending Appointment Letter  -->

    //<!-- F&F In Process -->
    function UpdateFNFInProcess(data) {

        // F&F In process Count
        document.getElementById("FNFInProcessCount").textContent = data.ffpro_count ?? '';

        // Appointment_Letter_container
        const FNF_Process = document.getElementById('FNF-Process-container');

        // Clear previous content if needed
        FNF_Process.innerHTML = '';

        // Check if Appointment_Letter
        if (!data.ff_datapro || data.ff_datapro.length === 0) {
            FNF_Process.innerHTML = `<p class="text-muted">No data available</p>`;
        } else {
            data.ff_datapro.forEach(function(employee) {
                //let editUrl = `/edit-employee?EmpID=${employee.EmpID}`;  // Replace with your real URL logic
                let editUrl = `/HumanResources/EditEmployee/?EmpID=${employee.EmpID}`; 

                // Image URL - similarly, replace with your actual image URL logic
                // let profileImageUrl = `/Humanview_file?ID=${employee.EmpID}&model=EmployeePersonalDetails`;

                // Build full name with spaces, ignoring empty middle names
                let fullName = employee.FirstName + 
                            (employee.MiddleName ? ' ' + employee.MiddleName : '') + 
                            (employee.LastName ? ' ' + employee.LastName : '');

                // Build the HTML block
                let html = `
                    <div class="feed-element d-flex align-items-center gap-3 mt-2 Custom-Border">
                        <div class="media-body ml-1">
                            <a class="float-left fullName" href="${editUrl}">
                                <strong>${fullName}</strong>
                            </a> <br>
                            <span class="EmpDesignation">${employee.Designation}</span>
                        </div>
                    </div>
                `;

                // Append to container
                // document.getElementById('FNF-Process-container').innerHTML += html;
                FNF_Process.innerHTML += html;
            });
        }
    };
    // <!-- // F&F In Process -->

</script>


{% endblock content %}


