{% extends "EMP_PAY\homebase.html" %}
{% block content %}
<style>
    textarea{
        height: 44px !important;
    }
</style>
<div class="card">
  
    <div class="card-header text-uppercase fw-bold">Attendance Lock of {{emp_Details.EmpName}} {{month}} - {{year}}</div>

    <div class="card-body">
        <table class="table table-striped table-bordered table-hover custom-table mb-0">
            <thead class="text-center">
                <tr>
                    <th>Days</th>
                    <th>Date</th>
                    <th>In</th>
                    <th>Out</th>
                    <th>Duty Hours</th>
                    <th>Status</th>
                    <th>Remarks</th>
                </tr>
            </thead>
            <tbody>
                {% for record in attendance_data %}
                <tr class="text-center align-middle">
                    <td>{{ forloop.counter }}</td>
                    <td>{{ record.Date|date:"j F, Y" }}</td>
                    <td>{{ record.In_Time }}</td>
                    <td>{{ record.Out_Time }}</td>
                    <td>{{ record.Duty_Hour }}</td>

                    {% if IsLock == "True" %}
                        <td>{{ record.Status }}</td>
                    {% else %}
                        <td>
                            <select class="form-control status-select" 
                                    name="Status" 
                                    data-attid="{{ record.id }}" 
                                    data-current-status="{{ record.Status }}">
                                <option value="Present" {% if record.Status == "Present" %}selected{% endif %}>Present</option>
                                <option value="Absent" {% if record.Status == "Absent" %}selected{% endif %}>Absent</option>
                                <option value="Week off" {% if record.Status == "Week off" %}selected{% endif %}>Week off</option>
                                <option value="Half Day Present" {% if record.Status == "Half Day Present" %}selected{% endif %}>Half Day Present</option>
                                <!-- Leave options from API will be appended dynamically -->
                            </select>
                        </td>
                    {% endif %}
                    <td>
                       {% if record.Status == "Present" or record.Status == "Absent" or record.Status == "Week off" or  record.Status == "Half Day Present" %} 
                            <textarea class="form-control remark-text d-none" 
                                data-attid="{{ record.id }}" 
                                rows="2" placeholder="Remarks For Leave" name="RemarksTab"></textarea>
                       {% else %}
                            <textarea class="form-control remark-text" 
                                    data-attid="{{ record.id }}" 
                                    rows="2" placeholder="Remarks For Leave" name="RemarksTab">{{ record.Remarks|default_if_none:"" }}</textarea>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
              <tr>
                <td  colspan="6" style="text-align: center;">No Data Available</td>
              </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div >
        {% if IsLock == "False" %}
            <div class="">
                <form action="" method="post">
                    <div class="m-3 ml-5">
                        {% csrf_token %}
                        <input type="submit"  name="btn" value="Save" class="btn btn-primary">
                        <input type="submit"   name="btn" value="Lock" class="btn btn-primary">
                    </div>
                </form>
            </div>
        {% endif %}
    </div>
</div>



<script>
    $(document).ready(function() {

        function toggleRemark(select) {
            const selectedValue = $(select).val();
            const textarea = $(select).closest('tr').find('.remark-text');
            // const existingRemark = textarea.val().trim();

            // Show textarea only for leave options (not Present/Absent/Week off/Half Day Present)
            const isLeave = selectedValue !== "" && !["Present","Absent","Week off","Half Day Present"].includes(selectedValue);

            // if (isLeave) {
            //     textarea.removeClass('d-none');
            //     textarea.prop('required', true);
            //     // textarea.prop('disabled', true);
            // } else {
            //     textarea.addClass('d-none');
            //     textarea.prop('required', false);
            //     // textarea.prop('disabled', false);
            //     // textarea.val(''); // optional: clear previous remark
            // }
            
            if (isLeave) {
                textarea.removeClass('d-none');
                textarea.prop('required', true);
            } else {
                textarea.addClass('d-none');
                textarea.prop('required', false);
                textarea.val('');
            }
            
        }

        // Initial toggle on page load
        // $('.status-select').each(function() {
        //     toggleRemark(this);
        // });

        // On status change
        $('.status-select').change(function() {
            toggleRemark(this);
            const attId = $(this).data('attid'); 
            const newStatus = $(this).val(); 
            const leaveTypeId = $(this).find('option:selected').data('attid-leavetypeid');

            let remarkstext = false


            updateStatus(attId, newStatus, leaveTypeId, remarkstext); 
        });

        // 2. When remarks are typed/blurred
        $('.remark-text').on('blur', function () {
            const attId = $(this).data('attid');
            const newStatus = $(this).closest('tr').find('.status-select').val();
            const leaveTypeId = $(this).closest('tr').find('.status-select option:selected').data('attid-leavetypeid');

            let remarkstext = true


            updateStatus(attId, newStatus, leaveTypeId, remarkstext);
        });
    });

    function updateStatus(attId, newStatus, leaveTypeId, remarkstext) {
        const remark = $(`.remark-text[data-attid="${attId}"]`).val();

        console.log("Remarks Is Here::", remark)

        const isLeave = newStatus !== "" && !["Present","Absent","Week off","Half Day Present"].includes(newStatus);
        if (isLeave && remark === "" && remarkstext) {
            alert("Please enter remarks for leave!");
            textarea.focus();
            return;
        }

        $.ajax({
            url: '/Employee_Payroll/UpdateStatus/', 
            type: 'GET',
            data: {
                'Attid': attId,
                'Status': newStatus,
                'leaveTypeId': leaveTypeId,
                'Remarks': remark
            },
            success: function(response) {
                if (response.message) {
                    console.log(response.message); 
                }
            },
            error: function(xhr, status, error) {
                console.error('Status update failed');
            }
        });
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        fetch("/Global_Api/Leave_Type_Data_Api/")
            .then(response => response.json())
            .then(data => {
                console.log("data is here::", data)
                if (data.status && data.Leave_Data) {
                    // Get all selects
                    document.querySelectorAll(".status-select").forEach(select => {
                        const currentStatus = select.getAttribute("data-current-status") || "";

                        // Append Leave Data dynamically
                        data.Leave_Data.forEach(leave => {
                            let option = document.createElement("option");
                            option.value = leave.Type;
                            option.textContent = leave.Type;

                            option.setAttribute("data-attid-leavetypeid", leave.id);

                            if (leave.Type === currentStatus) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        });
                    });
                }
            })
            .catch(err => console.error("Error fetching leave data:", err));
    });
</script>


{% endblock content %}
