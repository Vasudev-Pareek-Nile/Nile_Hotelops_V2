{% extends 'LMS/homebase.html' %}
{% block content %}  

{% comment %} {% extends 'EMP_PAY/homebase.html' %}
{% block content %}  {% endcomment %}


<style>
  table th, td {
      font-size: 14px;
  }

  .input-wrapper {
    position: relative;
  }

  .input-wrapper input[type="date"] {
    padding-left: 59px;
  }

  .input-wrapper label {
    position: absolute;
    left: 5px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1;
    background-color: white;
    padding: 0 5px;
  }
</style>
<div class="container">
    <div class="container text-center">
        {% for message in messages %}
        {% if message.tags == 'success' %}
        <div class="alert alert-success" role="alert">{{ message|safe }}</div>
        {% else %}
        <div class="alert alert-danger" role="alert">{{ message|safe }}</div>
        {% endif %}
        <script>
          setTimeout(function() {
            document.querySelector('.alert').remove();
          }, 3000);
        </script>
        {% endfor %}
    </div>
</div>
<div class="card">
  <div class="card-header text-uppercase fw-bold">Leave Approval List</div>

  <div class="card-body">
    <div class="row">
        <div class="col-md-12">
            <form method="get">
                <div class="row">
                  <div class="col-md-2">
                    <label for="Status">Status</label>
                      <select name="Status" id="" data-val="{{Status}}" class="form-control">
                          <option value="1" >Approved</option>
                          <option value="0"  selected>Pending</option>
                          <option value="-1">Rejected</option>
                      </select>
                  </div>
                  <div class="col-md-2">
                        <label for="Start_Date">From</label>
                        <input type="date" name="Start_Date" id="Start_Date" value="{% if Start_Date %}{{ Start_Date }}{% endif %}" class="form-control">
                  </div>
                  <div class="col-md-2">
                      <label for="To_Date">To</label>
                      <input type="date" name="To_Date" id="To_Date" value="{% if To_Date %}{{ To_Date }}{% endif %}" class="form-control">
                  </div>

                <div class="col-md-3 d-flex justify-items-start align-items-center gap-2" style="margin-top:1rem;">
                  <button type="submit" class="btn mr-4 btn-primary" id="filter">
                      <i class="fa fa-filter"></i> Filter
                  </button>
              
                  <a href="{% url 'Approval_list' %}" class="btn btn-danger ml-3" id="clear">
                      Clear
                  </a>
              </div>

            </form>
        </div>
    </div>
  </div>
</div>
</div>

<div class="card">
  <div class="card-body">
    <div class="col-md-12">
        <div class="mb-1" style="text-align: right;">
            <input
                type="text"
                id="searchInput"
                class="form-control"
                placeholder="Search ..."
                style="width: 200px; display: inline-block; height: 37px;"
                onkeyup="searchTable()"
            >
      </div>
    <table id="example" class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Emp Name</th>
                <th>Emp Code</th>
                <th>Reporting To</th>
                <th>Leave Type</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Days</th>

                <th>Reason</th>
                
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            {% for data in employee_data %}
            <tr>
                <td>{{ data.EmpName }}</td>
                <td>{{ data.EmployeeCode }}</td>
                <td>{{ data.LeaveApplicationDetails.ReportingtoDesigantion }}</td>
                <td>{{ data.LeaveApplicationDetails.Leave_Type_Master.Type }}</td>
                <td>{{ data.LeaveApplicationDetails.Start_Date | date:'d-m-Y'}}</td>
                <td>{{ data.LeaveApplicationDetails.End_Date | date:'d-m-Y'}}</td>
                <td>{{ data.LeaveApplicationDetails.Total_credit }}</td>
                <td>{{ data.LeaveApplicationDetails.Reason }}</td>
                
                <td> 
                    {% if data.LeaveApplicationDetails.Status == 0 %}
                      <a href="{% url 'Approve_Leave' %}?ID={{data.LeaveApplicationDetails.id}}&action=approve&OID={{data.LeaveApplicationDetails.OrganizationID}}" class="btn btn-primary btn-sm">Approve</a>
                      {% comment %} <button onclick="javascript:$('#rejectModal').modal('show');" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-target="#rejectModal" data-id="{{data.LeaveApplicationDetails.id}}" data-oid="{{data.LeaveApplicationDetails.OrganizationID}}">Reject</button> {% endcomment %}
                      &nbsp;
                      <button 
                          onclick="showRejectModal(this)" 
                          class="btn btn-danger btn-sm" 
                          data-toggle="modal" 
                          data-target="#rejectModal" 
                          data-id="{{data.LeaveApplicationDetails.id}}" 
                          data-oid="{{data.LeaveApplicationDetails.OrganizationID}}">
                          Reject 
                      </button>
                    {% endif %}

                    {% if data.LeaveApplicationDetails.Status == 1 %}
                      <div class="d-flex align-items-center">
                        <p class="btn btn-primary btn-sm mb-0">Approved</p>
                        &nbsp;
                        <a href="{% url 'RevokeLeave' %}?ID={{data.LeaveApplicationDetails.id}}&action=revoke&OID={{data.LeaveApplicationDetails.OrganizationID}}" class="btn btn-primary btn-sm ml-2">Revoke</a>
                     </div>
                    {% endif %}
                    
                    
                    {% if data.LeaveApplicationDetails.Status == -1 %}
                      <p style="color: red;" >Rejected <br> Reason :- {{  data.LeaveApplicationDetails.Remark }}</p>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
      </table>
  </div>
</div>

<div class="modal fade" id="rejectModal" tabindex="-1" role="dialog" aria-labelledby="rejectModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rejectModalLabel">Reject Leave Application </h5>
        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="rejectForm" method="post" action="{% url 'RejectLeave' %}">
          {% csrf_token %}
          <input type="hidden" name="ID" id="applicationId">
          <input type="hidden" name="OID" id="organizationId">
          <div class="form-group">
            <label for="remark">Rejection Remark</label>
            <textarea class="form-control" id="remark" name="Remark" required></textarea>
          </div>
          <br>
          <button type="submit" class="btn btn-danger">Submit</button>
        </form>
      </div>
    </div>
  </div>
</div>


<script>
    function showRejectModal(button) {
      var applicationId = button.getAttribute('data-id');
      var organizationId = button.getAttribute('data-oid');
  
      // console.log("applicationId is here:", applicationId);
      // console.log("organizationId is here:", organizationId);
  
      document.getElementById('applicationId').value = applicationId;
      document.getElementById('organizationId').value = organizationId;
  
      var modal = new bootstrap.Modal(document.getElementById('rejectModal'));
      modal.show();
  }
  $(function(){
    $("select").each(function(){

if($(this).attr('data-val')!=undefined){

    $(this).val($(this).attr('data-val'))
}
})

  })
</script>

<script>
    function searchTable() {
        // Get the search input value
        const input = document.getElementById("searchInput").value.toLowerCase();
        const tableBody = document.getElementById("tableBody");
        const rows = tableBody.getElementsByTagName("tr");
   
        // Loop through all table rows
        for (let i = 0; i < rows.length; i++) {
            let isMatch = false;
            const cells = rows[i].getElementsByTagName("td");
   
            // Check each cell in the row
            for (let j = 0; j < cells.length; j++) {
                if (cells[j]) {
                    const cellContent = cells[j].textContent || cells[j].innerText;
                    if (cellContent.toLowerCase().indexOf(input) > -1) {
                        isMatch = true;
                        break;
                    }
                }
            }
   
            // Show or hide the row based on the match
            rows[i].style.display = isMatch ? "" : "none";
        }
    }
</script>
{% endblock %}

