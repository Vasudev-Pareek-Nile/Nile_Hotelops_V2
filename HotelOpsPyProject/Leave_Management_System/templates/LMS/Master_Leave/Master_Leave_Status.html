{% extends 'LMS/homebase.html' %}
{% block content %}  

{% comment %} {% extends 'EMP_PAY/homebase.html' %}
{% block content %}  {% endcomment %}

 {% load static %}
 {% load custom_filters %}
 {% load encryption_filters %}

<style>

     .disabled {
        pointer-events: none; /* Prevent clicking */
        opacity: 0.5; /* Make it look faded */
    }

    #pdfLoader {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        {% comment %} border-top: 5px solid #3498db; {% endcomment %}
        border-top: 5px solid #FC133D;
        {% comment %} border-top: 5px solid #FF902F; {% endcomment %}
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    #loaderContainer {
        display: none; /* Ensure it's hidden by default */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    
    
</style>

<div id="loaderContainer">
    <div id="pdfLoader"></div>
</div>

<div class="card">
    <div class="card-header">
        <!-- Page Header -->
        {% comment %} <div class="page-header"> {% endcomment %}
            <div class="row align-items-center">
                <div class="col">
                    <h3 class="text-uppercase fw-bold">Leaves Management</h3>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="admin-dashboard.html">Dashboard</a></li>
                        <li class="breadcrumb-item active">Master Leave Status</li>
                    </ul>
                </div>
                <div class="col-auto float-end ms-auto">
                    <a href="/Leave_Management_System/Leave_Application/" class="btn add-btn" ><i class="fa-solid fa-plus"></i> Add Leave</a>
                </div>
            </div>
        {% comment %} </div> {% endcomment %}
    </div>
<!-- /Page Header -->
    <div class="card-body">
        <form method="GET" class="row g-2 mb-1">
            <div class="col-md-2">
            <label for="EmployeeCode" class="form-label">Employee Code</label>
            <select class="form-control" name="EmployeeCode" id="EmployeeCodeDropdown">
                <option value="All" {% if request.GET.EmployeeCode == "All" %}selected{% endif %}>All</option>
                {% for emp in employees %}
                <option value="{{ emp.EmployeeCode }}" {% if request.GET.EmployeeCode == emp.EmployeeCode %}selected{% endif %}>
                    {{ emp.EmployeeCode }} - {{ emp.EmpName }}
                </option>
                {% endfor %}
            </select>
            </div>
            <div class="col-md-2">
                <label for="start_date" class="form-label">Start Date</label>
                <input type="date" name="start_date" id="start_date" class="form-control" value="{{ request.GET.start_date }}">
            </div>
            <div class="col-md-2">
                <label for="end_date" class="form-label">End Date</label>
                <input type="date" name="end_date" id="end_date" class="form-control" value="{{ request.GET.end_date }}">
            </div>
            <div class="col-md-1">
                <label for="leave_type" class="form-label">Leave Type</label>
                <select name="leave_type" id="leave_type" class="form-control">
                    <option value="">All</option>
                    {% for leave_type in leave_types %}
                        <option value="{{ leave_type.id }}" {% if request.GET.leave_type == leave_type.id|stringformat:"s" %}selected{% endif %}>
                            {{ leave_type.Type }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-1">
                <label for="status" class="form-label">Status</label>
                <select name="status" id="status" class="form-control">
                    <option value="">All</option>
                    <option value="0" {% if request.GET.status == "0" %}selected{% endif %}>Pending</option>
                    <option value="1" {% if request.GET.status == "1" %}selected{% endif %}>Approved</option>
                    <option value="-1" {% if request.GET.status == "-1" %}selected{% endif %}>Rejected</option>
                    <option value="2" {% if request.GET.status == "2" %}selected{% endif %}>Revoked</option>
                </select>
            </div>

            <div class="col-md-4 d-flex justify-items-start align-items-center gap-1" style="margin-top:1.5rem;">
                <button type="submit" class="btn mr-4 btn-primary" style="padding-inline:15px; padding-block:8px;">
                    Search 
                </button>

                <a href="{% url 'Master_Leave_Status' %}" class="btn btn-danger ml-2" style="padding-inline:15px; padding-block:8px;">
                    Clear
                </a>
                <button type="button" class="btn btn-danger mt-3 mb-3" onclick="downloadPDF()" style="padding-inline:15px; padding-block:8px;">Download PDF</button>
            </div>
        </form>  
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div class="row">
            <div class="col-md-12">
                <div class="table-responsive">
                    <table class="table table-striped custom-table mb-0 datatable">
                        <thead>
                            <tr>
                                <th>Employee Code</th>
                                <th>Employee Name</th>
                                <th>Leave Type</th>
                                <th>From</th>
                                <th>To</th>
                                <th>Reason</th>
                                <th class="text-center">Status</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for leave_application in status %}
                                <tr>
                                    <td>{{ leave_application.Emp_code }}</td>
                                    <td>{{ leave_application.Emp_code|get_emp_name:leave_application.OrganizationID }}</td>
                                    <td>{{ leave_application.Leave_Type_Master.Type }}</td>
                                    <td>{{ leave_application.Start_Date |date:'d-m-Y' }}</td>
                                    <td>{{ leave_application.End_Date |date:'d-m-Y' }}</td>
                                    <td>{{ leave_application.Reason }}</td>

                                    <td class="text-center">
                                        <div class="dropdown action-label">
                                            <a class="btn btn-white btn-sm btn-rounded dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                                                {% if leave_application.Status == 0 %}
                                                    <i class="fa-regular fa-circle-dot text-warning"></i> Pending
                                                {% elif leave_application.Status == 1 %}
                                                    <i class="fa-regular fa-circle-dot text-success"></i> Approved
                                                {% elif leave_application.Status == -1 %}
                                                    <i class="fa-regular fa-circle-dot text-danger"></i> Rejected
                                                {% elif leave_application.Status == 2 %}
                                                    <i class="fa-regular fa-circle-dot text-secondary"></i> Revoked
                                                {% else%}
                                                    <i class="fa-regular fa-circle-dot text-warning"></i> Pending
                                                {% endif %}
                                            </a>
                                        </div>
                                    </td>

                                    <td class="text-end">
                                        <div class="dropdown dropdown-action">
                                            <a href="#" class="action-icon dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="material-icons">more_vert</i>
                                            </a>
                                            <div class="dropdown-menu dropdown-menu-right">
                                                <a class="dropdown-item {% if leave_application.Status != 0 %}disabled{% endif %}" 
                                                    href="#" 
                                                    {% if leave_application.Status == 0 %}data-bs-toggle="modal" data-bs-target="#edit_leave"{% endif %}>
                                                    <i class="fa-solid fa-pencil m-r-5"></i> Edit
                                                </a>
                                                <a class="dropdown-item {% if leave_application.Status != 0 %}disabled{% endif %}" 
                                                    href="#" 
                                                    {% if leave_application.Status == 0 %}data-bs-toggle="modal" data-bs-target="#delete_approve"{% endif %}>
                                                    <i class="fa-regular fa-trash-can m-r-5"></i> Delete
                                                </a>
                                            </div>
                                        </div>
                                    </td>
                                    
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Add Leave Modal -->
<div id="add_leave" class="modal custom-modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Leave</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="input-block mb-3">
                        <label class="col-form-label">Leave Type <span class="text-danger">*</span></label>
                        <select class="select">
                            <option value="">All</option>
                            {% for leave_type in leave_types %}
                                <option value="{{ leave_type.id }}" {% if request.GET.leave_type == leave_type.id|stringformat:"s" %}selected{% endif %}>
                                    {{ leave_type.Type }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="input-block mb-3">
                        <label class="col-form-label">From <span class="text-danger">*</span></label>
                        <div class="cal-icon">
                            <input class="form-control datetimepicker" type="text">
                        </div>
                    </div>
                    <div class="input-block mb-3">
                        <label class="col-form-label">To <span class="text-danger">*</span></label>
                        <div class="cal-icon">
                            <input class="form-control datetimepicker" type="text">
                        </div>
                    </div>
                    <div class="input-block mb-3">
                        <label class="col-form-label">Leave Reason <span class="text-danger">*</span></label>
                        <textarea rows="4" class="form-control"></textarea>
                    </div>
                    <div class="submit-section">
                        <button class="btn btn-primary submit-btn">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>



{% comment %} <script>
    function downloadPDF() {
        let employeeCode = document.getElementById("EmployeeCodeDropdown").value;
        let startDate = document.getElementById("start_date").value;
        let endDate = document.getElementById("end_date").value;
        let leaveType = document.getElementById("leave_type").value;
        let status = document.getElementById("status").value;
    
        let url = "{% url 'Master_download_leave_status_pdf' %}?" + 
                    "EmployeeCode=" + encodeURIComponent(employeeCode) +
                    "&start_date=" + encodeURIComponent(startDate) +
                    "&end_date=" + encodeURIComponent(endDate) +
                    "&leave_type=" + encodeURIComponent(leaveType) +
                    "&status=" + encodeURIComponent(status);
    
        // ✅ Show loader properly
        document.getElementById("loaderContainer").style.display = "flex";
    
        fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error("Failed to generate PDF");
            }
            return response.blob();
        })
        .then(blob => {
            let downloadUrl = window.URL.createObjectURL(blob);
            let a = document.createElement("a");
            a.href = downloadUrl;
            a.download = "Employee_Leave_Report.pdf";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(downloadUrl);
        })
        .catch(error => {
            alert("Error generating PDF. Please try again.");
        })
        .finally(() => {
            // ✅ Hide loader after PDF is downloaded
            document.getElementById("loaderContainer").style.display = "none";
        });
    }
</script> {% endcomment %}

<script>

    document.addEventListener("DOMContentLoaded", function() {
        let filterForm = document.querySelector("form"); // Get the first form on the page
        let clearButton = document.querySelector("a.btn-danger"); // Select the "Clear" button
    
        if (filterForm) {
            filterForm.addEventListener("submit", function() {
                document.getElementById("loaderContainer").style.display = "flex"; // Show loader on filter submit
            });
        }
    
        if (clearButton) {
            clearButton.addEventListener("click", function() {
                document.getElementById("loaderContainer").style.display = "flex"; // Show loader on clear button click
            });
        }
    });
    
    
    function downloadPDF() {
        let employeeCode = document.getElementById("EmployeeCodeDropdown").value;
        let startDate = document.getElementById("start_date").value;
        let endDate = document.getElementById("end_date").value;
        let leaveType = document.getElementById("leave_type").value;
        let status = document.getElementById("status").value;
    
        let url = "{% url 'download_leave_status_pdf' %}?" + 
                  "EmployeeCode=" + encodeURIComponent(employeeCode) +
                  "&start_date=" + encodeURIComponent(startDate) +
                  "&end_date=" + encodeURIComponent(endDate) +
                  "&leave_type=" + encodeURIComponent(leaveType) +
                  "&status=" + encodeURIComponent(status);
    
        // ✅ Show loader properly
        document.getElementById("loaderContainer").style.display = "flex";
    
        fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error("Failed to generate PDF");
            }
            return response.blob();
        })
        .then(blob => {
            let downloadUrl = window.URL.createObjectURL(blob);
            let a = document.createElement("a");
            a.href = downloadUrl;
            a.download = "Employee_Leave_Report.pdf";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(downloadUrl);
        })
        .catch(error => {
            alert("Error generating PDF. Please try again.");
        })
        .finally(() => {
            // ✅ Hide loader after PDF is downloaded
            document.getElementById("loaderContainer").style.display = "none";
        });
    } 
</script>

{% endblock content %}